<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ระบบจัดผังองค์กรอัตโนมัติ (HR Auto Organize)</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; touch-action: manipulation; }
        
        @media print {
            @page { size: landscape; margin: 5mm; }
            body { background: white; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            nav, .no-print, .add-btn, .zoom-controls, .login-screen, .sidebar-resizer, .debug-console, .sidebar-toggle-btn, .logo-controls, .undo-btn, .batch-actions { display: none !important; }
            main { padding: 0; margin: 0; width: 100%; overflow: visible !important; }
            aside { display: none !important; }
            .org-chart-container { transform: none !important; margin: 0 !important; border: none !important; shadow: none !important; }
            .draggable-element { border: none !important; resize: none !important; box-shadow: none !important; }
            .reorder-controls { display: none !important; }
        }

        ::-webkit-scrollbar { height: 8px; width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .draggable-source { cursor: grab; }
        .draggable-source:active { cursor: grabbing; }
        
        .zoom-controls { position: fixed; bottom: 20px; right: 20px; background: white; padding: 10px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 40; display: flex; align-items: center; gap: 8px; border: 1px solid #e2e8f0; }
        .undo-controls { position: fixed; bottom: 80px; right: 20px; z-index: 40; display: flex; flex-direction: column; gap: 8px; }
        .batch-actions { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: white; padding: 10px 20px; border-radius: 50px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); z-index: 50; display: flex; gap: 12px; align-items: center; border: 1px solid #e2e8f0; animation: slideUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes slideUp { from { transform: translate(-50%, 100%); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }
        
        .spinner { animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .sidebar-resizer { width: 5px; cursor: col-resize; background-color: transparent; position: absolute; right: 0; top: 0; bottom: 0; z-index: 50; }
        .sidebar-resizer:hover, .sidebar-resizer.resizing { background-color: #3b82f6; }
        
        .sidebar-toggle-btn { position: absolute; top: 50%; transform: translateY(-50%); width: 24px; height: 40px; background: white; border: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 50; box-shadow: 2px 0 5px rgba(0,0,0,0.1); color: #4b5563; }
        
        .debug-console { position: fixed; bottom: 0; left: 0; right: 0; height: 150px; background: #1e293b; color: #33ff33; font-family: monospace; font-size: 11px; z-index: 100; display: flex; flex-direction: column; border-top: 2px solid #334155; }
        .debug-content { flex: 1; overflow-y: auto; padding: 10px; }
        
        .reorder-controls { position: absolute; top: 50%; transform: translateY(-50%); display: flex; gap: 2px; z-index: 30; opacity: 0; transition: opacity 0.2s; }
        .group:hover .reorder-controls { opacity: 1; }
        .reorder-btn { background: white; border: 1px solid #e2e8f0; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #64748b; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .reorder-btn:hover { background: #f1f5f9; color: #2563eb; }

        .connector-line { position: absolute; pointer-events: none; z-index: 5; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 h-screen overflow-hidden">
    <div id="root" class="h-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback, useMemo } = React;

        // --- UTILS ---
        const formatDriveUrl = (url) => {
            if (!url) return "https://via.placeholder.com/100?text=No+Img";
            if (url.includes('drive.google.com') || url.includes('docs.google.com')) {
                let id = null;
                const idMatch1 = url.match(/id=([a-zA-Z0-9_-]+)/);
                if (idMatch1) id = idMatch1[1]; else { const idMatch2 = url.match(/\/d\/([a-zA-Z0-9_-]+)/); if (idMatch2) id = idMatch2[1]; }
                if (id) return `https://lh3.googleusercontent.com/d/${id}`;
            }
            return url;
        };

        const compressImage = (file, targetSizeKB = 512) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader(); reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image(); img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas'); let width = img.width, height = img.height; const MAX = 1600;
                        if (width > MAX || height > MAX) { if (width > height) { height *= MAX / width; width = MAX; } else { width *= MAX / height; height = MAX; } }
                        canvas.width = width; canvas.height = height; const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height);
                        let quality = 0.9, dataUrl = canvas.toDataURL('image/jpeg', quality);
                        while (dataUrl.length * 0.75 > targetSizeKB * 1024 && quality > 0.1) { quality -= 0.1; dataUrl = canvas.toDataURL('image/jpeg', quality); }
                        resolve(dataUrl);
                    }; img.onerror = reject;
                }; reader.onerror = reject;
            });
        };

        const exportToExcel = (employees) => {
            let csvContent = "data:text/csv;charset=utf-8,\uFEFFID,Name,Position,Type,Status,ReportsTo,Order\n";
            employees.forEach(e => { csvContent += `"${e.id}","${e.name}","${e.position}","${e.type}","${e.status}","${e.reportsTo}","${e.order||0}"\n`; });
            const link = document.createElement("a"); link.setAttribute("href", encodeURI(csvContent)); link.setAttribute("download", "employees_export.csv"); document.body.appendChild(link); link.click(); document.body.removeChild(link);
        };

        const getDefaultChildPosition = (parentPos) => {
            const p = (parentPos || "").toLowerCase();
            if(p.includes('manager')) return 'Supervisor';
            if(p.includes('supervisor')) return 'Engineer';
            if(p.includes('engineer')) return 'Leader';
            if(p.includes('leader')) return 'Operator';
            return 'Operator';
        };

        // --- ICONS ---
        const IconBase = ({ children, size = 18, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>;
        const Icons = {
            Camera: (p)=><IconBase {...p}><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></IconBase>,
            Plus: (p)=><IconBase {...p}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></IconBase>,
            Trash2: (p)=><IconBase {...p}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></IconBase>,
            Download: (p)=><IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></IconBase>,
            Users: (p)=><IconBase {...p}><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></IconBase>,
            X: (p)=><IconBase {...p}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></IconBase>,
            Check: (p)=><IconBase {...p}><polyline points="20 6 9 17 4 12"/></IconBase>,
            Settings: (p)=><IconBase {...p}><path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></IconBase>,
            Move: (p)=><IconBase {...p}><polyline points="5 9 2 12 5 15"/><polyline points="9 5 12 2 15 5"/><polyline points="19 9 22 12 19 15"/><polyline points="9 19 12 22 15 19"/><line x1="2" y1="12" x2="22" y2="12"/><line x1="12" y1="2" x2="12" y2="22"/></IconBase>,
            Menu: (p)=><IconBase {...p}><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></IconBase>,
            List: (p)=><IconBase {...p}><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></IconBase>,
            Grid: (p)=><IconBase {...p}><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></IconBase>,
            ChevronLeft: (p)=><IconBase {...p}><polyline points="15 18 9 12 15 6"/></IconBase>,
            ChevronRight: (p)=><IconBase {...p}><polyline points="9 18 15 12 9 6"/></IconBase>,
            ArrowLeft: (p)=><IconBase {...p}><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></IconBase>,
            ArrowRight: (p)=><IconBase {...p}><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></IconBase>,
            RotateCcw: (p)=><IconBase {...p}><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></IconBase>,
            Ruler: (p)=><IconBase {...p}><path d="M21.3 15.3a2.4 2.4 0 0 1 0 3.4l-2.6 2.6a2.4 2.4 0 0 1-3.4 0L2.7 8.7a2.4 2.4 0 0 1 0-3.4l2.6-2.6a2.4 2.4 0 0 1 3.4 0Z"/><line x1="14.5" y1="3.2" x2="18.8" y2="7.5"/><line x1="12.5" y1="5.2" x2="16.8" y2="9.5"/><line x1="10.5" y1="7.2" x2="14.8" y2="11.5"/><line x1="8.5" y1="9.2" x2="12.8" y2="13.5"/><line x1="6.5" y1="11.2" x2="10.8" y2="15.5"/><line x1="4.5" y1="13.2" x2="8.8" y2="17.5"/></IconBase>,
            Edit: (p)=><IconBase {...p}><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></IconBase>,
            Lock: (p)=><IconBase {...p}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></IconBase>,
            Unlock: (p)=><IconBase {...p}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></IconBase>,
            ZoomIn: (p)=><IconBase {...p}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="11" y1="8" x2="11" y2="14"/><line x1="8" y1="11" x2="14" y2="11"/></IconBase>,
            ZoomOut: (p)=><IconBase {...p}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="8" y1="11" x2="14" y2="11"/></IconBase>,
            LogOut: (p)=><IconBase {...p}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></IconBase>,
            Cloud: (p)=><IconBase {...p}><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></IconBase>,
            Loader: (p)=><IconBase {...p} className={`spinner ${p.className}`}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></IconBase>,
            Alert: (p)=><IconBase {...p}><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></IconBase>,
            Terminal: (p)=><IconBase {...p}><polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/></IconBase>,
            Paint: (p)=><IconBase {...p}><path d="M18.375 2.625a2.121 2.121 0 1 1 3 3L12 15l-4 1 1-4Z"/><path d="m15 6.5 3 3"/><path d="M6 20h1a2 2 0 0 0 2-2V8a2 2 0 0 0-4 0v10a2 2 0 0 0 1 2Z"/></IconBase>,
            FileSpreadsheet: (p)=><IconBase {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M8 13h2"/><path d="M8 17h2"/><path d="M14 13h2"/><path d="M14 17h2"/></IconBase>,
            Chart: (p)=><IconBase {...p}><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></IconBase>,
            Image: (p)=><IconBase {...p}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></IconBase>,
            Briefcase: (p)=><IconBase {...p}><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></IconBase>,
            CheckSquare: (p)=><IconBase {...p}><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></IconBase>,
            Type: (p)=><IconBase {...p}><polyline points="4 7 4 4 20 4 20 7"/><line x1="9" y1="20" x2="15" y2="20"/><line x1="12" y1="4" x2="12" y2="20"/></IconBase>,
            Link: (p)=><IconBase {...p}><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></IconBase>,
            Search: (p)=><IconBase {...p}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></IconBase>
        };

        const Button = ({ children, onClick, variant = 'primary', className = '', icon: Icon, disabled, title }) => {
            const base = "flex items-center justify-center px-3 py-2 sm:px-4 sm:py-2 rounded-lg font-medium transition-all active:scale-95 shadow-sm disabled:opacity-50 text-sm sm:text-base whitespace-nowrap";
            const variants = {
                primary: "bg-blue-600 text-white hover:bg-blue-700",
                secondary: "bg-white text-gray-700 border border-gray-200 hover:bg-gray-50",
                danger: "bg-red-50 text-red-600 hover:bg-red-100 border border-red-100",
                success: "bg-green-600 text-white hover:bg-green-700",
                warning: "bg-orange-500 text-white hover:bg-orange-600",
            };
            return <button type="button" onClick={onClick} disabled={disabled} className={`${base} ${variants[variant]} ${className}`} title={title}>{Icon && <Icon size={18} className="mr-2" />} {children}</button>;
        };

        // --- COMPONENTS ---
        
        const AdminPanel = ({ onClose, driveUrl, setDriveUrl, apiCall }) => {
            const [users, setUsers] = useState([]); const [newUser, setNewUser] = useState({ username: '', password: '', role: 'leader', name: '' }); const [editingUsername, setEditingUsername] = useState(null); const [loading, setLoading] = useState(false);
            useEffect(() => { const loadUsers = async () => { setLoading(true); let loadedUsers = []; if (driveUrl) { try { const res = await apiCall(driveUrl, 'getUsers'); if (res?.status === 'success') loadedUsers = res.users; } catch (e) {} } if (loadedUsers.length === 0) loadedUsers = JSON.parse(localStorage.getItem('users')) || [{ username: 'admin', password: 'password', role: 'admin', name: 'Admin User' }]; setUsers(loadedUsers); setLoading(false); }; loadUsers(); }, [driveUrl]);
            const saveUserAction = async () => { if (!newUser.username || !newUser.password) return alert("กรุณากรอก User/Pass"); setLoading(true); let updatedUsers; if (editingUsername) updatedUsers = users.map(u => u.username === editingUsername ? newUser : u); else { if (users.some(u => u.username === newUser.username)) { setLoading(false); return alert('ชื่อซ้ำ'); } updatedUsers = [...users, newUser]; } setUsers(updatedUsers); localStorage.setItem('users', JSON.stringify(updatedUsers)); if (driveUrl) try { await apiCall(driveUrl, 'saveUser', { user: newUser }); } catch (e) { alert("บันทึก Cloud ไม่สำเร็จ"); } setEditingUsername(null); setNewUser({ username: '', password: '', role: 'leader', name: '' }); setLoading(false); };
            const deleteUserAction = async (username) => { if (!confirm('ยืนยันลบ?')) return; setLoading(true); const updated = users.filter(u => u.username !== username); setUsers(updated); localStorage.setItem('users', JSON.stringify(updated)); if (driveUrl) await apiCall(driveUrl, 'deleteUser', { username }); setLoading(false); };
            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[70]"><div className="bg-white w-full max-w-3xl rounded-2xl shadow-xl overflow-hidden flex flex-col max-h-[90vh]">
                    <div className="p-6 border-b flex justify-between items-center"><h2 className="text-xl font-bold">Admin Panel</h2><button onClick={onClose}><Icons.X /></button></div>
                    <div className="p-6 overflow-y-auto space-y-6">
                        <div className="bg-blue-50 p-4 rounded-lg border border-blue-100"><h3 className="font-bold text-blue-800 mb-2 flex items-center"><Icons.Cloud className="mr-2"/> Google Script URL</h3><input type="text" value={driveUrl} onChange={(e) => setDriveUrl(e.target.value)} className="w-full p-2 border rounded text-sm"/></div>
                        <div><h3 className="font-bold mb-4 flex items-center"><Icons.Users className="mr-2"/> Users {loading && <Icons.Loader className="ml-2"/>}</h3>
                            <div className="flex gap-2 mb-4 items-end bg-gray-50 p-3 rounded flex-wrap"><div className="flex-1 min-w-[100px]"><label className="text-xs text-gray-500">User</label><input value={newUser.username} onChange={e => setNewUser({...newUser, username: e.target.value})} className="border p-2 rounded text-sm w-full" disabled={!!editingUsername}/></div><div className="flex-1 min-w-[100px]"><label className="text-xs text-gray-500">Pass</label><input value={newUser.password} onChange={e => setNewUser({...newUser, password: e.target.value})} className="border p-2 rounded text-sm w-full"/></div><div className="flex-1 min-w-[100px]"><label className="text-xs text-gray-500">Name</label><input value={newUser.name} onChange={e => setNewUser({...newUser, name: e.target.value})} className="border p-2 rounded text-sm w-full"/></div><div className="w-24"><label className="text-xs text-gray-500">Role</label><select value={newUser.role} onChange={e => setNewUser({...newUser, role: e.target.value})} className="border p-2 rounded text-sm w-full"><option value="admin">Admin</option><option value="supervisor">Sup</option><option value="leader">Leader</option><option value="viewer">View</option></select></div><button onClick={saveUserAction} className={`${editingUsername ? 'bg-orange-500' : 'bg-green-600'} text-white p-2 rounded h-[38px] w-[38px] flex justify-center items-center`}>{editingUsername ? <Icons.Check size={18}/> : <Icons.Plus size={18}/>}</button></div>
                            <table className="w-full text-sm text-left"><thead className="bg-gray-100"><tr><th className="p-2">User</th><th className="p-2">Name</th><th className="p-2">Role</th><th className="p-2">Act</th></tr></thead><tbody>{users.map((u, i) => <tr key={i} className="border-b"><td className="p-2 font-medium">{u.username}</td><td className="p-2">{u.name}</td><td className="p-2"><span className={`px-2 py-0.5 rounded text-xs ${u.role==='admin'?'bg-red-100 text-red-800':u.role==='supervisor'?'bg-blue-100 text-blue-800':'bg-gray-100'}`}>{u.role}</span></td><td className="p-2 flex gap-2"><button onClick={() => { setNewUser(u); setEditingUsername(u.username); }} className="text-orange-500 p-1"><Icons.Edit size={16}/></button>{u.username !== 'admin' && <button onClick={() => deleteUserAction(u.username)} className="text-red-500 p-1"><Icons.Trash2 size={16}/></button>}</td></tr>)}</tbody></table>
                        </div>
                    </div>
                </div></div>
            );
        };

        // [RESTORED] LoginScreen Component
        const LoginScreen = ({ onLogin, driveUrl, apiCall }) => {
            const [user, setUser] = useState(''); const [pass, setPass] = useState(''); const [error, setError] = useState(''); const [isLoading, setIsLoading] = useState(false);
            const handleLogin = async (e) => {
                e.preventDefault(); setIsLoading(true); setError('');
                if (driveUrl) {
                    try { const res = await apiCall(driveUrl, 'login', { username: user, password: pass });
                        if (res?.status === 'success') { onLogin(res.user); return; } else setError('Cloud Login Failed: ' + (res?.message||'Unknown'));
                    } catch (err) { setError('Connection failed. Trying local...'); }
                }
                const users = JSON.parse(localStorage.getItem('users')) || [{ username: 'admin', password: 'password', role: 'admin', name: 'Admin User' }];
                const valid = users.find(u => u.username === user && u.password === pass);
                if (valid) { if(driveUrl) setError('Offline Mode'); onLogin(valid); } else { if(!error) setError('Invalid credentials'); }
                setIsLoading(false);
            };
            return (
                <div className="fixed inset-0 bg-gray-100 flex items-center justify-center z-50 login-screen">
                    <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm">
                        <div className="flex flex-col items-center mb-6"><div className="bg-red-600 p-3 rounded-lg text-white font-bold text-2xl mb-2">HR</div><h2 className="text-xl font-bold text-gray-800">เข้าสู่ระบบ</h2></div>
                        <form onSubmit={handleLogin} className="space-y-4">
                            <div><label className="text-sm font-medium">Username</label><input type="text" value={user} onChange={e=>setUser(e.target.value)} className="w-full mt-1 p-2 border rounded-lg" required /></div>
                            <div><label className="text-sm font-medium">Password</label><input type="password" value={pass} onChange={e=>setPass(e.target.value)} className="w-full mt-1 p-2 border rounded-lg" required /></div>
                            {error && <p className="text-red-500 text-xs text-center">{error}</p>}
                            <button type="submit" disabled={isLoading} className="w-full bg-red-600 text-white py-2 rounded-lg font-bold flex justify-center items-center">{isLoading ? <Icons.Loader className="mr-2"/> : "เข้าสู่ระบบ"}</button>
                        </form>
                    </div>
                </div>
            );
        };

        const DraggableLogo = ({ logo, setLogo, isLocked }) => {
            if (!logo.url) return null;
            const handleMouseDown = (e) => {
                if (isLocked) return; e.preventDefault(); const startX = e.clientX - logo.x; const startY = e.clientY - logo.y;
                const onMouseMove = (moveEvent) => { setLogo(prev => ({ ...prev, x: moveEvent.clientX - startX, y: moveEvent.clientY - startY })); };
                const onMouseUp = () => { document.removeEventListener("mousemove", onMouseMove); document.removeEventListener("mouseup", onMouseUp); };
                document.addEventListener("mousemove", onMouseMove); document.addEventListener("mouseup", onMouseUp);
            };
            return (
                <div className={`absolute z-30 group draggable-element ${!isLocked ? 'cursor-move hover:ring-2 hover:ring-blue-400' : ''}`} style={{ left: logo.x, top: logo.y, width: logo.width || 150 }} onMouseDown={handleMouseDown}>
                    <img src={logo.url} className="w-full h-auto object-contain pointer-events-none" />
                    {!isLocked && <button onClick={() => setLogo({ url: null, x: 50, y: 50 })} className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity shadow-sm"><Icons.X size={12}/></button>}
                </div>
            );
        };

        const DraggableAnnotation = ({ ann, onUpdate, onDelete, isLocked, onLinkStart }) => {
            const handleMouseDown = (e) => {
                if (isLocked) return; e.stopPropagation();
                const startX = e.clientX - ann.x; const startY = e.clientY - ann.y;
                const onMouseMove = (moveEvent) => { onUpdate(ann.id, { x: moveEvent.clientX - startX, y: moveEvent.clientY - startY }); };
                const onMouseUp = () => { document.removeEventListener("mousemove", onMouseMove); document.removeEventListener("mouseup", onMouseUp); };
                document.addEventListener("mousemove", onMouseMove); document.addEventListener("mouseup", onMouseUp);
            };
            return (
                <div className={`absolute z-30 draggable-element group p-3 rounded shadow-md border min-w-[150px] ${!isLocked ? 'cursor-move hover:ring-2 hover:ring-blue-300' : ''}`} style={{ left: ann.x, top: ann.y, backgroundColor: ann.bg || '#ffffff', color: ann.color || '#000' }} onMouseDown={handleMouseDown}>
                    {!isLocked ? ( <textarea value={ann.text} onChange={(e)=>onUpdate(ann.id, {text: e.target.value})} className="w-full bg-transparent outline-none resize-none overflow-hidden text-center" style={{fontSize: '14px'}} placeholder="Type here..."/> ) : ( <div className="text-center whitespace-pre-wrap">{ann.text}</div> )}
                    {!isLocked && (<div className="absolute -top-3 -right-3 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity"><button onClick={(e)=>{e.stopPropagation(); onLinkStart(ann.id);}} className="bg-blue-500 text-white p-1 rounded-full shadow" title="Link to Node"><Icons.Link size={10}/></button><button onClick={(e)=>{e.stopPropagation(); onDelete(ann.id);}} className="bg-red-500 text-white p-1 rounded-full shadow"><Icons.X size={10}/></button></div>)}
                    {!isLocked && (<div className="absolute -bottom-8 left-0 right-0 flex justify-center gap-1 opacity-0 group-hover:opacity-100 bg-white/90 p-1 rounded shadow text-xs"><input type="color" value={ann.bg||'#ffffff'} onChange={(e)=>onUpdate(ann.id, {bg: e.target.value})} title="Background" className="w-4 h-4"/><input type="color" value={ann.color||'#000000'} onChange={(e)=>onUpdate(ann.id, {color: e.target.value})} title="Text Color" className="w-4 h-4"/></div>)}
                </div>
            );
        };

        const ManagePositionsModal = ({ positions, onAdd, onDelete, onClose }) => {
            const [newPos, setNewPos] = useState("");
            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[70]">
                    <div className="bg-white rounded-xl shadow-xl p-6 w-full max-w-sm">
                        <div className="flex justify-between items-center mb-4"><h3 className="font-bold flex items-center"><Icons.Briefcase className="mr-2"/> Manage Positions</h3><button onClick={onClose}><Icons.X/></button></div>
                        <div className="flex gap-2 mb-4"><input value={newPos} onChange={e=>setNewPos(e.target.value)} placeholder="New Position..." className="flex-1 border p-2 rounded text-sm"/><button onClick={()=>{if(newPos){onAdd(newPos);setNewPos('');}}} className="bg-green-600 text-white p-2 rounded"><Icons.Plus/></button></div>
                        <div className="max-h-60 overflow-y-auto space-y-2">{positions.map(p => (<div key={p} className="flex justify-between items-center p-2 bg-gray-50 rounded text-sm group"><span>{p}</span><button onClick={()=>onDelete(p)} className="text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100"><Icons.Trash2 size={16}/></button></div>))}</div>
                    </div>
                </div>
            );
        };

        const SummaryDashboard = ({ employees, onClose }) => {
            const stats = useMemo(() => {
                const total = employees.length; const byType = { Permanent: 0, Subcontract: 0 }; const byPosition = {};
                employees.forEach(e => { if (e.type === 'Permanent') byType.Permanent++; else byType.Subcontract++; byPosition[e.position] = (byPosition[e.position] || 0) + 1; });
                return { total, byType, byPosition };
            }, [employees]);
            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[80] animate-in fade-in">
                    <div className="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-2xl max-h-[80vh] overflow-y-auto">
                        <div className="flex justify-between items-center mb-6 border-b pb-2"><h2 className="text-2xl font-bold text-gray-800 flex items-center"><Icons.Chart className="mr-2"/> Summary Dashboard</h2><button onClick={onClose}><Icons.X/></button></div>
                        <div className="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-8">
                            <div className="bg-blue-50 p-4 rounded-xl text-center border border-blue-100"><h3 className="text-gray-500 text-sm font-medium">Total Employees</h3><p className="text-3xl font-bold text-blue-700">{stats.total}</p></div>
                            <div className="bg-green-50 p-4 rounded-xl text-center border border-green-100"><h3 className="text-gray-500 text-sm font-medium">Permanent</h3><p className="text-3xl font-bold text-green-700">{stats.byType.Permanent}</p></div>
                            <div className="bg-orange-50 p-4 rounded-xl text-center border border-orange-100"><h3 className="text-gray-500 text-sm font-medium">Subcontract</h3><p className="text-3xl font-bold text-orange-700">{stats.byType.Subcontract}</p></div>
                        </div>
                        <div><h3 className="font-bold text-gray-700 mb-4">By Position</h3><div className="space-y-3">{Object.entries(stats.byPosition).sort((a,b)=>b[1]-a[1]).map(([pos, count]) => (<div key={pos} className="flex items-center"><div className="w-1/3 text-sm font-medium text-gray-600 truncate pr-2">{pos}</div><div className="flex-1 bg-gray-100 rounded-full h-4 overflow-hidden"><div className="bg-blue-500 h-full rounded-full" style={{width: `${(count/stats.total)*100}%`}}></div></div><div className="w-10 text-right text-sm font-bold text-gray-800">{count}</div></div>))}</div></div>
                    </div>
                </div>
            );
        };

        const BatchEditModal = ({ selectedCount, onClose, onSave }) => {
            const [field, setField] = useState('position'); const [value, setValue] = useState('');
            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[80]">
                    <div className="bg-white rounded-xl p-6 w-80">
                        <h3 className="font-bold mb-4">Batch Edit ({selectedCount})</h3>
                        <select className="w-full border p-2 rounded mb-2" value={field} onChange={e=>setField(e.target.value)}><option value="position">Change Position</option><option value="status">Change Status</option></select>
                        <input className="w-full border p-2 rounded mb-4" value={value} onChange={e=>setValue(e.target.value)} placeholder="New Value..."/>
                        <div className="flex justify-end gap-2"><Button variant="secondary" onClick={onClose}>Cancel</Button><Button onClick={()=>onSave(field, value)}>Apply</Button></div>
                    </div>
                </div>
            );
        };

        const Ruler = ({ orientation = 'horizontal', length = 2000 }) => {
            const pxPerMm = 3.7795; const ticks = []; for (let i = 0; i <= length / pxPerMm; i += 10) ticks.push(<div key={i} className="ruler-tick" style={orientation==='horizontal'?{left:`${i*pxPerMm}px`,height:'6px',width:'1px',bottom:0}:{top:`${i*pxPerMm}px`,width:'6px',height:'1px',right:0}}><span className="ruler-label" style={orientation==='horizontal'?{left:'2px',bottom:'8px'}:{top:'2px',right:'8px'}}>{i}</span></div>);
            return <div className={`absolute bg-gray-50 border-gray-300 z-10 opacity-80 pointer-events-none ${orientation==='horizontal'?'h-8 border-b w-full top-0 left-8':'w-8 border-r h-full left-0 top-8'}`}>{ticks}</div>;
        };

        const EmployeeCard = ({ employee, onClick, onDragStart, onMoveInit, className="", isStaging=false, isSelected=false, isLocked=false, isViewOnly=false, themeConf, shapeClass, selectionMode, toggleSelection, onReorder }) => {
            const isSub = employee.type === 'Subcontract';
            let bgClass = "bg-white"; let borderClass = "border-gray-200"; let radiusClass = shapeClass?.cls || 'rounded-xl'; let badgeClass = isSub ? 'bg-orange-500' : 'bg-blue-600';
            if (employee.customColor && THEMES[employee.customColor]) { const customTheme = THEMES[employee.customColor]; const styles = customTheme.lv0.split(' '); bgClass = styles.find(s => s.startsWith('bg-')) || bgClass; borderClass = styles.find(s => s.startsWith('border-')) || borderClass; } else if (className) { const styles = className.split(' '); bgClass = styles.find(s => s.startsWith('bg-')) || bgClass; borderClass = styles.find(s => s.startsWith('border-')) || borderClass; }
            if (employee.customShape && SHAPES[employee.customShape]) { radiusClass = SHAPES[employee.customShape].cls; }
            const textColorStyle = employee.textColor ? { color: employee.textColor } : {};

            return (
                <div draggable={!isLocked && !isViewOnly} onDragStart={(e) => !isLocked && !isViewOnly && onDragStart && onDragStart(e, employee.id)} 
                    className={`relative flex flex-col items-center p-3 border-b-4 shadow-sm w-36 sm:w-40 transition-transform duration-200 cursor-pointer group ${bgClass} ${borderClass} ${radiusClass} ${isSelected?'ring-4 ring-purple-500 scale-105 z-20 shadow-xl':'hover:scale-105'} ${isLocked||isViewOnly?'cursor-default':'draggable-source'}`} 
                    onClick={(e) => { e.stopPropagation(); if(selectionMode) toggleSelection(employee.id); else if(!isViewOnly || isLocked) onClick(employee); }}
                    id={`node-${employee.id}`}
                >
                    <div className={`absolute top-2 left-2 px-1.5 py-0.5 rounded text-[10px] font-bold text-white ${badgeClass}`}>{isSub?'S':'P'}</div>
                    {selectionMode && <div className={`absolute top-2 right-2 w-5 h-5 rounded-full border-2 flex items-center justify-center ${isSelected?'bg-purple-600 border-purple-600':'border-gray-300 bg-white'}`}>{isSelected && <Icons.Check size={12} className="text-white"/>}</div>}
                    {!isLocked && !isStaging && !selectionMode && !isViewOnly && (<><div className="reorder-controls" style={{left: '-10px'}}><button className="reorder-btn" onClick={(e)=>{e.stopPropagation(); onReorder(employee.id, -1)}}><Icons.ArrowLeft size={10}/></button></div><div className="reorder-controls" style={{right: '-10px'}}><button className="reorder-btn" onClick={(e)=>{e.stopPropagation(); onReorder(employee.id, 1)}}><Icons.ArrowRight size={10}/></button></div></>)}
                    <div className="relative"><img src={formatDriveUrl(employee.image)} referrerPolicy="no-referrer" loading="eager" onError={(e)=>{e.target.onerror=null; e.target.src="https://via.placeholder.com/100?text=No+Img"}} className="w-14 h-14 sm:w-16 sm:h-16 rounded-full object-cover border-2 border-white shadow-sm bg-gray-200 pointer-events-none"/><div className="absolute -bottom-1 -right-1 bg-white rounded-full p-1 shadow"><div className={`w-3 h-3 rounded-full ${employee.status==='Active'?'bg-green-500':'bg-red-500'}`}></div></div></div>
                    <div className="mt-2 text-center w-full" style={textColorStyle}><p className="text-[10px] sm:text-xs font-bold opacity-60">{employee.id}</p><h3 className="text-xs sm:text-sm font-bold leading-tight truncate w-full">{employee.name}</h3><p className="text-[10px] sm:text-xs opacity-70 truncate w-full">{employee.position}</p>{isSub && employee.company && <p className="text-[9px] text-orange-600 truncate mt-0.5">({employee.company})</p>}</div>
                    {isStaging && !isLocked && !isViewOnly && !selectionMode && <button onClick={(e)=>{e.stopPropagation();onMoveInit(employee);}} className="absolute top-1 right-1 p-1.5 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-full"><Icons.Move size={14}/></button>}
                </div>
            );
        };

        const EmployeeNode = ({ employee, allEmployees, onEdit, onDelete, onAddSubordinate, onDrop, onMoveSelect, moveTargetId, isLocked, isViewOnly, level = 0, themeConf, shapeClass, selectionMode, selectedIds, toggleSelection, onReorder, onAddChild }) => {
            const [isDragOver, setIsDragOver] = useState(false);
            if (!employee) return null;
            const subordinates = allEmployees.filter(e => e.reportsTo === employee.id).sort((a, b) => (a.order || 0) - (b.order || 0));
            let cardColor = "bg-white border-gray-300"; if (themeConf) { if (level === 0) cardColor = themeConf.lv0; else if (level === 1) cardColor = themeConf.lv1; else cardColor = themeConf.lvN; }
            const isLargeTeam = subordinates.length > 4; 
            const handleDropInternal = (e) => { if(isLocked||isViewOnly)return; e.preventDefault(); setIsDragOver(false); const rawData = e.dataTransfer.getData("empIds"); const droppedIds = rawData ? JSON.parse(rawData) : []; if(droppedIds.length > 0 && !droppedIds.includes(employee.id)) onDrop(droppedIds, employee.id); };
            
            return (
                <div className="flex flex-col items-center">
                    {level > 0 && <div className="h-4 sm:h-6 w-px bg-gray-300"></div>}
                    <div onDragOver={(e)=>{if(!isLocked&&!isViewOnly){e.preventDefault();setIsDragOver(true);}}} onDragLeave={()=>setIsDragOver(false)} onDrop={handleDropInternal} onClick={()=>moveTargetId && !isLocked && !isViewOnly && onMoveSelect(employee.id)} className={`relative z-10 group transition-all ${isDragOver?'scale-110 drop-target-hover':''} ${moveTargetId?'cursor-crosshair':''}`}>
                        {moveTargetId && !isLocked && !isViewOnly && <div className="absolute -inset-2 border-2 border-dashed border-blue-400 rounded-2xl bg-blue-50/50 z-20 flex items-center justify-center animate-pulse pointer-events-none"><span className="bg-blue-600 text-white text-[10px] px-2 py-0.5 rounded-full">เลือกเป็นหัวหน้า</span></div>}
                        <EmployeeCard employee={employee} onClick={onEdit} onDragStart={(e, id)=>{ const payload = (selectionMode && selectedIds.includes(id)) ? selectedIds : [id]; e.dataTransfer.setData("empIds", JSON.stringify(payload)); }} className={cardColor} isLocked={isLocked} isViewOnly={isViewOnly} themeConf={themeConf} shapeClass={shapeClass} selectionMode={selectionMode} selectedIds={selectedIds} isSelected={selectedIds.includes(employee.id)} toggleSelection={toggleSelection} onReorder={onReorder}/>
                        {!moveTargetId && !isLocked && !isViewOnly && !selectionMode && <button onClick={(e)=>{e.stopPropagation();onAddChild(employee);}} className="add-btn absolute -bottom-3 left-1/2 -translate-x-1/2 bg-white text-blue-600 border border-blue-200 rounded-full w-6 h-6 flex items-center justify-center shadow-md active:scale-95"><Icons.Plus size={14}/></button>}
                    </div>
                    {subordinates.length > 0 && (
                        <>
                            <div className="h-4 sm:h-6 w-px bg-gray-300"></div>
                            <div className="flex relative">
                                {isLargeTeam ? (
                                    <div className="grid grid-cols-4 gap-4 p-4 bg-gray-50/50 rounded-xl border border-dashed border-gray-300">
                                        {subordinates.map((sub) => (<EmployeeNode key={sub.id} employee={sub} allEmployees={allEmployees} onEdit={onEdit} onDelete={onDelete} onAddSubordinate={onAddSubordinate} onDrop={onDrop} onMoveSelect={onMoveSelect} moveTargetId={moveTargetId} level={level + 1} isLocked={isLocked} isViewOnly={isViewOnly} themeConf={themeConf} shapeClass={shapeClass} selectionMode={selectionMode} selectedIds={selectedIds} toggleSelection={toggleSelection} onReorder={onReorder} onAddChild={onAddChild} />))}
                                    </div>
                                ) : (
                                    <> {subordinates.length > 1 && <div className="absolute top-0 left-0 right-0 h-px bg-gray-300 mx-[calc(50%/2)] -translate-y-px"></div>}
                                        <div className="flex gap-4 sm:gap-6 pt-0">
                                            {subordinates.map((sub, i) => (<div key={sub.id} className="relative flex flex-col items-center"> {subordinates.length > 1 && <div className={`absolute top-0 h-px bg-gray-300 ${i===0?'w-1/2 right-0':''} ${i===subordinates.length-1?'w-1/2 left-0':''} ${i>0 && i<subordinates.length-1?'w-full':''}`}></div>} <EmployeeNode employee={sub} allEmployees={allEmployees} onEdit={onEdit} onDelete={onDelete} onAddSubordinate={onAddSubordinate} onDrop={onDrop} onMoveSelect={onMoveSelect} moveTargetId={moveTargetId} level={level + 1} isLocked={isLocked} isViewOnly={isViewOnly} themeConf={themeConf} shapeClass={shapeClass} selectionMode={selectionMode} selectedIds={selectedIds} toggleSelection={toggleSelection} onReorder={onReorder} onAddChild={onAddChild} /> </div>))}
                                        </div>
                                    </>
                                )}
                            </div>
                        </>
                    )}
                </div>
            );
        };

        const ThemePanel = ({ onClose, currentTheme, setAppTheme, currentShape, setAppShape }) => {
            return (
                <div className="fixed top-16 right-4 bg-white p-4 rounded-xl shadow-xl border w-64 z-[60] animate-in slide-in-from-top-2">
                    <div className="flex justify-between items-center mb-4"><h3 className="font-bold">Appearance</h3><button onClick={onClose}><Icons.X size={16}/></button></div>
                    <div className="mb-4"><label className="text-xs text-gray-500 block mb-2">Theme</label><div className="grid grid-cols-4 gap-2">{Object.entries(THEMES).map(([key, t]) => (<button key={key} onClick={()=>setAppTheme(key)} className={`w-10 h-10 rounded-lg ${t.lv0} shadow-sm border-2 ${currentTheme===key?'border-gray-800 scale-110 ring-2 ring-offset-1':'border-transparent'}`} title={t.name}></button>))}</div></div>
                    <div><label className="text-xs text-gray-500 block mb-2">Global Shape</label><div className="flex flex-wrap gap-2">{Object.entries(SHAPES).map(([key, s]) => (<button key={key} onClick={()=>setAppShape(s)} className={`px-3 py-1 bg-gray-100 border text-xs ${s.cls} ${currentShape.name===s.name?'bg-blue-100 border-blue-500 text-blue-700':''}`}>{s.name}</button>))}</div></div>
                </div>
            );
        };

        const THEMES = { blue: { name: 'Blue', lv0: 'bg-blue-100 border-blue-600', lv1: 'bg-blue-50 border-blue-400', lvN: 'bg-white border-blue-200' }, teal: { name: 'Teal', lv0: 'bg-teal-100 border-teal-600', lv1: 'bg-teal-50 border-teal-400', lvN: 'bg-white border-teal-200' }, indigo: { name: 'Indigo', lv0: 'bg-indigo-100 border-indigo-600', lv1: 'bg-indigo-50 border-indigo-400', lvN: 'bg-white border-indigo-200' }, rose: { name: 'Rose', lv0: 'bg-rose-100 border-rose-600', lv1: 'bg-rose-50 border-rose-400', lvN: 'bg-white border-rose-200' }, slate: { name: 'Slate', lv0: 'bg-slate-200 border-slate-600', lv1: 'bg-slate-100 border-slate-400', lvN: 'bg-white border-slate-300' }, orange: { name: 'Orange', lv0: 'bg-orange-100 border-orange-600', lv1: 'bg-orange-50 border-orange-400', lvN: 'bg-white border-orange-200' } };
        const SHAPES = { rounded: { name: 'Rounded', cls: 'rounded-xl' }, sharp: { name: 'Square', cls: 'rounded-none' }, pill: { name: 'Pill', cls: 'rounded-[2rem]' }, leaf: { name: 'Leaf', cls: 'rounded-tr-3xl rounded-bl-3xl rounded-tl-md rounded-br-md' } };

        const EmployeeForm = ({ employee, supervisors, positions, onSave, onCancel, onDelete, role, driveUrl, onAddPosition, onDeletePosition }) => {
            const [formData, setFormData] = useState({ id: '', name: '', position: '', reportsTo: '', image: null, status: 'Active', type: 'Permanent', company: '', customColor: '', customShape: '', textColor: '#1f2937' });
            const [showDeleteConfirm, setShowDeleteConfirm] = useState(false); const [isUploading, setIsUploading] = useState(false); const [tab, setTab] = useState('info'); const [isManagePosOpen, setIsManagePosOpen] = useState(false); const fileInputRef = useRef(null); const isEditMode = employee && !employee.isNew; const canEditStructure = role === 'admin' || role === 'supervisor';
            useEffect(() => { if (isEditMode) setFormData({ type: 'Permanent', company: '', customColor: '', customShape: '', textColor: '#1f2937', ...employee }); else setFormData({ id: Math.floor(60000 + Math.random() * 9000).toString(), name: '', position: employee?.position || '', reportsTo: employee?.reportsTo || '', image: null, status: 'Active', type: 'Permanent', company: '', customColor: '', customShape: '', textColor: '#1f2937' }); }, [employee]);
            const handleChange = (e) => setFormData(prev => ({ ...prev, [e.target.name]: e.target.value }));
            const handleImageUpload = async (e) => { const file = e.target.files[0]; if (!file) return; try { setIsUploading(true); const compressedBase64 = await compressImage(file, 512); if (driveUrl) { const payload = { file: compressedBase64.split(',')[1], filename: `emp_${formData.id}.jpg`, mimetype: 'image/jpeg', oldFileUrl: formData.image }; const res = await fetch(driveUrl, { method: 'POST', body: JSON.stringify(payload) }); const result = await res.json(); if (result?.url) { setFormData(prev => ({ ...prev, image: result.url })); alert("อัปโหลดสำเร็จ"); } else throw new Error("Upload failed"); } else { setFormData(prev => ({ ...prev, image: compressedBase64 })); alert("บันทึกรูปลงเครื่องสำเร็จ"); } } catch (err) { alert("Error: " + err.message); } finally { setIsUploading(false); } };
            
            // [Auto-Move Logic]
            const handleSubmit = (e) => { e.preventDefault(); let finalData = { ...formData }; if (finalData.position.toLowerCase().includes('operator') && finalData.reportsTo) { const boss = supervisors.find(s => s.id === finalData.reportsTo); if (boss && boss.position.toLowerCase().includes('operator')) { if (boss.reportsTo && boss.reportsTo !== 'STAGING') { alert(`[Auto-Move] ย้าย Operator ไปหาหัวหน้าของ ${boss.name}`); finalData.reportsTo = boss.reportsTo; } } } onSave(finalData); };
            
            return (
                <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-[60] p-4">
                    <div className="bg-white w-full max-w-md rounded-2xl shadow-2xl flex flex-col max-h-[90vh]">
                        <div className="bg-gray-50 px-6 py-4 border-b flex justify-between items-center"><h2 className="text-lg font-bold">{isEditMode ? 'แก้ไขข้อมูล' : 'เพิ่มพนักงาน'}</h2><button onClick={onCancel}><Icons.X/></button></div>
                        <div className="flex border-b"><button onClick={()=>setTab('info')} className={`flex-1 py-3 text-sm font-medium ${tab==='info'?'text-blue-600 border-b-2 border-blue-600':'text-gray-500'}`}>ข้อมูลทั่วไป</button><button onClick={()=>setTab('style')} className={`flex-1 py-3 text-sm font-medium ${tab==='style'?'text-blue-600 border-b-2 border-blue-600':'text-gray-500'}`}>ปรับแต่งการ์ด</button></div>
                        <form onSubmit={handleSubmit} className="p-6 space-y-4 overflow-y-auto grow">
                            {tab === 'info' ? (<> <div className="flex flex-col items-center mb-6"><div className="w-24 h-24 rounded-full bg-gray-100 border-4 border-white shadow-md flex items-center justify-center overflow-hidden cursor-pointer relative group" onClick={()=>fileInputRef.current.click()}>{isUploading ? <Icons.Loader/> : (formData.image ? <img src={formatDriveUrl(formData.image)} referrerPolicy="no-referrer" className="w-full h-full object-cover"/> : <Icons.Camera size={32} className="text-gray-400"/>)}</div><input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={handleImageUpload} /></div><div className="grid grid-cols-2 gap-4"><div><label className="text-xs text-gray-500">รหัส</label><input name="id" value={formData.id} onChange={handleChange} className="w-full border p-2 rounded" disabled={!canEditStructure && isEditMode}/></div><div><label className="text-xs text-gray-500">สถานะ</label><select name="status" value={formData.status} onChange={handleChange} className="w-full border p-2 rounded"><option value="Active">ปกติ</option><option value="Resigned">ลาออก</option></select></div></div><div><label className="text-xs text-gray-500">ประเภท</label><div className="flex gap-4"><label><input type="radio" name="type" value="Permanent" checked={formData.type==='Permanent'} onChange={handleChange}/> ประจำ</label><label><input type="radio" name="type" value="Subcontract" checked={formData.type==='Subcontract'} onChange={handleChange}/> Sub</label></div></div>{formData.type === 'Subcontract' && <input name="company" value={formData.company} onChange={handleChange} placeholder="บริษัทสังกัด..." className="w-full border p-2 rounded bg-orange-50"/>}<div><label className="text-xs text-gray-500">ชื่อ-สกุล</label><input name="name" value={formData.name} onChange={handleChange} className="w-full border p-2 rounded" required/></div><div><label className="text-xs text-gray-500 flex justify-between">ตำแหน่ง <button type="button" onClick={()=>setIsManagePosOpen(true)} className="text-blue-600 underline">จัดการ</button></label><select name="position" value={formData.position} onChange={handleChange} className="w-full border p-2 rounded">{positions.map(p=><option key={p} value={p}>{p}</option>)}</select></div><div><label className="text-xs text-gray-500">หัวหน้างาน</label><select name="reportsTo" value={formData.reportsTo} onChange={handleChange} disabled={!canEditStructure && isEditMode} className="w-full border p-2 rounded bg-gray-50"><option value="STAGING">-- รอจัดสายงาน --</option><option value="">-- สูงสุด --</option>{supervisors.filter(s=>s.id!==formData.id).map(s=><option key={s.id} value={s.id}>{s.name}</option>)}</select></div> </>) : (<div className="space-y-6"><div className="p-4 bg-yellow-50 rounded-lg text-xs text-yellow-800 border border-yellow-200">การตั้งค่าในหน้านี้จะทับค่า Default ของธีมหลัก</div><div><label className="text-xs text-gray-500 mb-2 block">เลือกสีการ์ด</label><div className="grid grid-cols-5 gap-2"><button type="button" onClick={()=>setFormData(p=>({...p, customColor: ''}))} className={`h-8 rounded-lg border bg-white text-xs ${formData.customColor===''?'ring-2 ring-blue-500':''}`}>None</button>{Object.entries(THEMES).map(([k,t]) => (<button type="button" key={k} onClick={()=>setFormData(p=>({...p, customColor: k}))} className={`h-8 rounded-lg ${t.lv0} ${formData.customColor===k?'ring-2 ring-blue-500':''}`}></button>))}</div></div><div><label className="text-xs text-gray-500 mb-2 block">เลือกรูปร่าง</label><div className="flex flex-wrap gap-2"><button type="button" onClick={()=>setFormData(p=>({...p, customShape: ''}))} className={`px-3 py-1 border rounded bg-white text-xs ${formData.customShape===''?'bg-gray-200':''}`}>Default</button>{Object.entries(SHAPES).map(([k,s]) => (<button type="button" key={k} onClick={()=>setFormData(p=>({...p, customShape: k}))} className={`px-3 py-1 border text-xs ${s.cls} ${formData.customShape===k?'bg-blue-100 border-blue-500':''}`}>{s.name}</button>))}</div></div><div><label className="text-xs text-gray-500 mb-2 block">สีตัวอักษร</label><div className="flex items-center gap-2"><input type="color" value={formData.textColor || '#1f2937'} onChange={(e)=>setFormData(p=>({...p, textColor: e.target.value}))} className="h-10 w-20"/><span className="text-xs text-gray-500">เลือกสี</span></div></div></div>)}
                        </form>
                        <div className="bg-gray-50 px-6 py-4 border-t flex justify-between">{isEditMode && role!=='leader' && (!showDeleteConfirm ? <Button variant="danger" onClick={()=>setShowDeleteConfirm(true)} icon={Icons.Trash2}>ลบ</Button> : <div className="flex gap-2"><Button variant="danger" onClick={()=>onDelete(formData.id)}>ยืนยัน</Button><Button variant="secondary" onClick={()=>setShowDeleteConfirm(false)}>ไม่</Button></div>)}{!showDeleteConfirm && <div className="flex gap-2 ml-auto"><Button variant="secondary" onClick={onCancel}>ยกเลิก</Button><Button variant="primary" onClick={handleSubmit} icon={Icons.Check}>บันทึก</Button></div>}</div>
                    </div>
                    {isManagePosOpen && <ManagePositionsModal positions={positions} onAdd={onAddPosition} onDelete={onDeletePosition} onClose={()=>setIsManagePosOpen(false)} />}
                </div>
            );
        };

        // --- BATCH EDIT MODAL ---
        const BatchEditModal = ({ selectedCount, onClose, onSave }) => {
            const [field, setField] = useState('position');
            const [value, setValue] = useState('');
            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[80]">
                    <div className="bg-white rounded-xl p-6 w-80">
                        <h3 className="font-bold mb-4">Batch Edit ({selectedCount})</h3>
                        <select className="w-full border p-2 rounded mb-2" value={field} onChange={e=>setField(e.target.value)}>
                            <option value="position">Change Position</option>
                            <option value="status">Change Status</option>
                        </select>
                        <input className="w-full border p-2 rounded mb-4" value={value} onChange={e=>setValue(e.target.value)} placeholder="New Value..."/>
                        <div className="flex justify-end gap-2">
                            <Button variant="secondary" onClick={onClose}>Cancel</Button>
                            <Button onClick={()=>onSave(field, value)}>Apply</Button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        const App = () => {
            const initialData = [ { id: '68040', name: 'Detbodin K.', position: 'Assembly Supervisor', reportsTo: '', status: 'Active', image: null, type: 'Permanent', order: 0 } ];
            const initialPositions = ["Department Manager", "Supervisor", "Engineer", "Leader", "Assembly Operator", "Clerk"];
            const [currentUser, setCurrentUser] = useState(() => JSON.parse(localStorage.getItem('currentUser')));
            const [employees, setEmployees] = useState(() => JSON.parse(localStorage.getItem('orgData')) || initialData);
            const [positions, setPositions] = useState(() => JSON.parse(localStorage.getItem('orgPositions')) || initialPositions);
            const [annotations, setAnnotations] = useState(() => JSON.parse(localStorage.getItem('orgAnnotations')) || []);
            const [lastUpdated, setLastUpdated] = useState(() => localStorage.getItem('lastUpdated') || new Date().toLocaleString('th-TH'));
            const [driveUrl, setDriveUrl] = useState("https://script.google.com/macros/s/AKfycbxYxBWD4blG_bP9hdTm_W8RP9PtM9CLZovmSFQVVsQTcBl18uxcaAxrhW5lZKFmEj8H/exec");
            
            const [logo, setLogo] = useState({ url: null, x: 50, y: 50 });
            const [selectionMode, setSelectionMode] = useState(false);
            const [selectedIds, setSelectedIds] = useState([]);
            const [history, setHistory] = useState([]);
            const [historyIndex, setHistoryIndex] = useState(-1);
            const [headerColor, setHeaderColor] = useState('#1f2937'); 
            const [linkStartId, setLinkStartId] = useState(null); 
            const [searchTerm, setSearchTerm] = useState('');

            const [isModalOpen, setIsModalOpen] = useState(false); const [editingEmployee, setEditingEmployee] = useState(null); const [viewMode, setViewMode] = useState('chart'); const [isThemePanelOpen, setIsThemePanelOpen] = useState(false); const [isSummaryOpen, setIsSummaryOpen] = useState(false); const [showRulers, setShowRulers] = useState(false); const [isSidebarOpen, setIsSidebarOpen] = useState(false); const [sidebarWidth, setSidebarWidth] = useState(256); const [isSidebarCollapsed, setIsSidebarCollapsed] = useState(false); const [isAdminPanelOpen, setIsAdminPanelOpen] = useState(false); const [isBatchEditOpen, setIsBatchEditOpen] = useState(false);
            const [zoom, setZoom] = useState(1); const [appTheme, setAppTheme] = useState('blue'); const [appShape, setAppShape] = useState(SHAPES.rounded); const [cloudStatus, setCloudStatus] = useState('offline'); const [debugLogs, setDebugLogs] = useState([]); const [showDebug, setShowDebug] = useState(false); const [moveSource, setMoveSource] = useState(null); const [deptName, setDeptName] = useState("ASSEMBLY DEPT"); 
            const sidebarRef = useRef(null); const isResizing = useRef(false); const logoInputRef = useRef(null);

            const addLog = (msg, data, type='info') => setDebugLogs(prev => [...prev.slice(-49), { time: new Date().toLocaleTimeString(), msg, data, type }]);
            const appApiCall = async (url, action, payload) => { try { const res = await fetch(url, { method: 'POST', body: JSON.stringify({ action, ...payload }) }); const json = await res.json(); addLog(`API: ${action}`, json); return json; } catch (e) { addLog(`Error: ${action}`, e.toString(), 'error'); throw e; } };
            const syncUpdatesToCloud = async (updates = [], deletes = []) => { if (!driveUrl) return; setCloudStatus('syncing'); try { const res = await appApiCall(driveUrl, 'updateEmployees', { updates, deletes }); setCloudStatus(res?.status === 'success' ? 'online' : 'error'); } catch (e) { setCloudStatus('error'); } };

            useEffect(() => { if (driveUrl) { setCloudStatus('syncing'); appApiCall(driveUrl, 'getData').then(res => { if (res?.status === 'success' && res.data) { if (res.data.orgData) { setEmployees(res.data.orgData); localStorage.setItem('orgData', JSON.stringify(res.data.orgData)); } if (res.data.orgPositions) setPositions(res.data.orgPositions); setCloudStatus('online'); } else setCloudStatus('error'); }).catch(() => setCloudStatus('error')); } }, [driveUrl]);

            // Utility to update state + history + timestamp + sync
            const updateStateFull = (newState, updates = [], deletes = []) => {
                pushToHistory(employees);
                setEmployees(newState);
                const time = new Date().toLocaleString('th-TH');
                setLastUpdated(time);
                localStorage.setItem('orgData', JSON.stringify(newState));
                localStorage.setItem('lastUpdated', time);
                if(updates.length > 0 || deletes.length > 0) syncUpdatesToCloud(updates, deletes);
            };

            const pushToHistory = (newData) => { const newHistory = history.slice(0, historyIndex + 1); newHistory.push(newData); if (newHistory.length > 5) newHistory.shift(); setHistory(newHistory); setHistoryIndex(newHistory.length - 1); };
            const handleUndo = () => { if (historyIndex >= 0) { const prevState = history[historyIndex]; setEmployees(prevState); localStorage.setItem('orgData', JSON.stringify(prevState)); setHistoryIndex(prev => prev - 1); if(driveUrl) appApiCall(driveUrl, 'saveData', { orgData: prevState }); } };

            const handleSave = (data) => {
                let updates = [data];
                let newData = employees;
                const exists = employees.find(e => e.id === data.id);
                newData = exists ? employees.map(e => e.id === data.id ? data : e) : [...employees, data];
                updateStateFull(newData, updates, []);
                setIsModalOpen(false); setEditingEmployee(null);
            };

            const handleDelete = (id) => {
                const target = employees.find(e => e.id === id);
                if (!target) return;
                const grandParentId = target.reportsTo;
                // Promote subordinates
                const subUpdates = employees.filter(e => e.reportsTo === id).map(e => ({ ...e, reportsTo: grandParentId }));
                const newData = employees
                    .filter(e => e.id !== id) // Remove target
                    .map(e => {
                        const updatedSub = subUpdates.find(sub => sub.id === e.id);
                        return updatedSub ? updatedSub : e; 
                    });
                updateStateFull(newData, subUpdates, [id]);
                setIsModalOpen(false);
            };

            const handleReorder = (id, direction) => {
                const target = employees.find(e => e.id === id); if(!target) return;
                const siblings = employees.filter(e => e.reportsTo === target.reportsTo).sort((a,b) => (a.order||0) - (b.order||0));
                const currentIndex = siblings.findIndex(e => e.id === id);
                if (currentIndex === -1) return;
                const newIndex = currentIndex + direction;
                if (newIndex < 0 || newIndex >= siblings.length) return;
                const siblingToSwap = siblings[newIndex];
                const targetOrder = target.order || 0;
                const siblingOrder = siblingToSwap.order || 0;
                
                let newData = employees.map(e => {
                    if (e.id === target.id) return { ...e, order: siblingOrder };
                    if (e.id === siblingToSwap.id) return { ...e, order: targetOrder };
                    return e;
                });
                
                // Fix if same order
                if (targetOrder === siblingOrder) {
                     newData = employees.map(e => {
                         if(e.reportsTo === target.reportsTo) {
                             if(e.id === target.id) return {...e, order: newIndex};
                             if(e.id === siblingToSwap.id) return {...e, order: currentIndex};
                             const idx = siblings.findIndex(s=>s.id === e.id);
                             return {...e, order: idx};
                         }
                         return e;
                     });
                }
                const u1 = newData.find(e => e.id === target.id);
                const u2 = newData.find(e => e.id === siblingToSwap.id);
                updateStateFull(newData, [u1, u2], []);
            };
            
            const handleBatchDelete = () => { if(!confirm(`Delete ${selectedIds.length} items?`)) return; const newData = employees.filter(e => !selectedIds.includes(e.id)); updateStateFull(newData, [], selectedIds); setSelectedIds([]); setSelectionMode(false); };
            const handleBatchEditSave = (field, value) => { let updates = []; const newData = employees.map(e => { if(selectedIds.includes(e.id)) { const u = {...e, [field]: value}; updates.push(u); return u; } return e; }); updateStateFull(newData, updates, []); setIsBatchEditOpen(false); setSelectedIds([]); setSelectionMode(false); };
            const handleBatchAdd = () => { const count = parseInt(prompt("How many cards?", "5")); if(!count) return; let newCards = []; for(let i=0; i<count; i++) { newCards.push({ id: Math.floor(Math.random()*100000).toString(), name: 'New Employee', position: 'Operator', reportsTo: 'STAGING', status: 'Active', type: 'Subcontract' }); } const newData = [...employees, ...newCards]; updateStateFull(newData, newCards, []); };

            const handleAddAnnotation = () => { const newAnn = { id: Date.now().toString(), x: 100, y: 100, text: 'New Text', bg: '#ffffff', color: '#000000', linkTo: null }; setAnnotations(prev => { const n = [...prev, newAnn]; localStorage.setItem('orgAnnotations', JSON.stringify(n)); return n; }); };
            const handleUpdateAnnotation = (id, updates) => { setAnnotations(prev => { const n = prev.map(a => a.id === id ? { ...a, ...updates } : a); localStorage.setItem('orgAnnotations', JSON.stringify(n)); return n; }); };
            const handleDeleteAnnotation = (id) => { setAnnotations(prev => { const n = prev.filter(a => a.id !== id); localStorage.setItem('orgAnnotations', JSON.stringify(n)); return n; }); };
            const handleAnnotationLink = (nodeId) => { if(linkStartId) { handleUpdateAnnotation(linkStartId, { linkTo: nodeId }); setLinkStartId(null); } };

            const handleAddChild = (parent) => {
                const defaultPos = getDefaultChildPosition(parent.position);
                setEditingEmployee({ isNew: true, reportsTo: parent.id, position: defaultPos });
                setIsModalOpen(true);
            };

            const handleAddPosition = (newPos) => { setPositions(prev => { const newArr = [...prev, newPos]; localStorage.setItem('orgPositions', JSON.stringify(newArr)); if (driveUrl) appApiCall(driveUrl, 'saveData', { orgPositions: newArr }); return newArr; }); };
            const handleDeletePosition = (pos) => { setPositions(prev => { const newArr = prev.filter(p => p !== pos); localStorage.setItem('orgPositions', JSON.stringify(newArr)); if (driveUrl) appApiCall(driveUrl, 'saveData', { orgPositions: newArr }); return newArr; }); };
            const handleLogoUpload = (e) => { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (ev) => { setLogo(prev => ({ ...prev, url: ev.target.result })); }; reader.readAsDataURL(file); } };

            const handleDropOnChart = (draggedIds, targetId) => {
                if(linkStartId) { handleAnnotationLink(targetId); return; } 
                if(currentUser.role !== 'admin' && currentUser.role !== 'supervisor') return;
                const idsToMove = Array.isArray(draggedIds) ? draggedIds : [draggedIds];
                let updates = [];
                const newData = employees.map(e => {
                    if(idsToMove.includes(e.id)) {
                        const updated = { ...e, reportsTo: targetId };
                        updates.push(updated);
                        return updated;
                    }
                    return e;
                });
                updateStateFull(newData, updates, []);
                setSelectedIds([]);
            };

            const toggleSelection = (id) => { setSelectedIds(prev => prev.includes(id) ? prev.filter(x => x !== id) : [...prev, id]); };
            const resize = useCallback((e) => { if (isResizing.current) { const w = e.clientX; if (w > 150 && w < 500) setSidebarWidth(w); } }, []);
            const stopResizing = useCallback(() => { isResizing.current = false; }, []);
            useEffect(() => { window.addEventListener("mousemove", resize); window.addEventListener("mouseup", stopResizing); return () => { window.removeEventListener("mousemove", resize); window.removeEventListener("mouseup", stopResizing); }; }, [resize, stopResizing]);

            if (!currentUser) return <LoginScreen onLogin={(u)=>{localStorage.setItem('currentUser',JSON.stringify(u));setCurrentUser(u);}} driveUrl={driveUrl} apiCall={appApiCall} />;

            const stagingEmployees = employees.filter(e => e.reportsTo === 'STAGING' && (searchTerm === '' || e.name.toLowerCase().includes(searchTerm.toLowerCase())));
            
            // ORPHAN LOGIC: Show orphans as roots
            const rootEmployees = employees.filter(e => {
                if (e.reportsTo === 'STAGING') return false; 
                if (!e.reportsTo) return true; 
                const boss = employees.find(b => b.id === e.reportsTo);
                if (!boss) return true; // Boss deleted -> Orphan -> Show as root
                if (boss.reportsTo === 'STAGING') return true; // Boss in staging -> Show as root
                return false; 
            }).filter(e => searchTerm === '' || e.name.toLowerCase().includes(searchTerm.toLowerCase()));

            const isLocked = currentUser.role !== 'admin' && currentUser.role !== 'supervisor';
            const currentThemeConf = THEMES[appTheme];

            // Render Connectors
            const connectors = annotations.filter(a => a.linkTo).map(ann => {
                const targetNode = document.getElementById(`node-${ann.linkTo}`);
                if(!targetNode) return null;
                const rect = targetNode.getBoundingClientRect();
                const container = document.getElementById('org-chart-full-view').getBoundingClientRect();
                const x1 = ann.x + 75; const y1 = ann.y + 20; 
                const x2 = (rect.left - container.left) + (rect.width/2);
                const y2 = (rect.top - container.top) + (rect.height/2);
                return <line key={ann.id} x1={x1} y1={y1} x2={x2} y2={y2} stroke="red" strokeWidth="2" strokeDasharray="5,5" className="connector-line"/>;
            });

            return (
                <div className="flex flex-col h-full bg-gray-50">
                    <nav className="bg-white shadow-sm border-b sticky top-0 z-40 shrink-0 h-14 flex items-center px-4 justify-between">
                        <div className="flex items-center gap-2"><button onClick={() => setIsSidebarOpen(!isSidebarOpen)} className="md:hidden p-2"><Icons.Menu/></button><div className="bg-red-600 p-1 rounded text-white font-bold">HR</div><span className={`text-xs flex items-center ${cloudStatus==='online'?'text-green-600':cloudStatus==='error'?'text-red-500':'text-gray-400'}`}>{cloudStatus==='online'?<><Icons.Cloud size={14} className="mr-1"/>Online</>:cloudStatus==='syncing'?<><Icons.Loader size={14} className="mr-1"/>Syncing</>:<><Icons.Alert size={14} className="mr-1"/>Offline</>}</span></div>
                        <div className="flex items-center gap-1 sm:gap-2">
                            {/* [NEW] Search Bar */}
                            <div className="hidden sm:flex items-center bg-gray-100 rounded-full px-2 py-1"><Icons.Search size={14} className="text-gray-400"/><input value={searchTerm} onChange={e=>setSearchTerm(e.target.value)} placeholder="Search..." className="bg-transparent border-none text-xs ml-2 w-24 outline-none"/></div>
                            
                            <button onClick={()=>setViewMode('chart')} className={`p-1.5 rounded ${viewMode==='chart'?'bg-blue-50 text-blue-600':''}`}><Icons.Grid/></button>
                            <button onClick={()=>setViewMode('list')} className={`p-1.5 rounded ${viewMode==='list'?'bg-blue-50 text-blue-600':''}`}><Icons.List/></button>
                            {!isLocked && (<><button onClick={()=>{setSelectionMode(!selectionMode); setSelectedIds([]);}} className={`p-1.5 rounded border flex items-center gap-1 transition-all ${selectionMode?'bg-purple-600 text-white border-purple-600 ring-2 ring-purple-200':'text-gray-600 hover:bg-gray-100'}`} title="Multi-Select"><Icons.CheckSquare size={18}/>{selectionMode && <span className="text-xs font-bold px-1">{selectedIds.length}</span>}</button>
                            <button onClick={handleAddAnnotation} className="p-1.5 text-gray-600 hover:bg-gray-100 rounded border" title="Add Text"><Icons.Type size={18}/></button>
                            <button onClick={handleBatchAdd} className="p-1.5 text-gray-600 hover:bg-gray-100 rounded border" title="Bulk Add"><Icons.Users size={18}/></button></>)}
                            <div className={`p-1.5 rounded-full border flex items-center justify-center ${isLocked?'bg-gray-50 text-gray-500':'bg-green-50 text-green-600'}`} title={isLocked?"View Only":"Edit Mode"}>{isLocked?<Icons.Lock size={16}/>:<Icons.Unlock size={16}/>}</div>
                            {!isLocked && <button onClick={()=>setIsThemePanelOpen(!isThemePanelOpen)} className="p-2 text-gray-600 hover:bg-gray-100 rounded-full" title="Theme"><Icons.Paint size={20}/></button>}
                            {!isLocked && <div className="logo-controls"><button onClick={()=>logoInputRef.current.click()} className="p-2 text-purple-600 hover:bg-purple-50 rounded-full" title="Upload Logo"><Icons.Image size={20}/></button><input ref={logoInputRef} type="file" accept="image/*" className="hidden" onChange={handleLogoUpload}/></div>}
                            <button onClick={()=>setIsSummaryOpen(true)} className="p-2 text-blue-600 hover:bg-blue-50 rounded-full" title="Summary Dashboard"><Icons.Chart size={20}/></button>
                            <button onClick={()=>exportToExcel(employees)} className="p-2 text-green-600 hover:bg-green-50 rounded-full" title="Export CSV"><Icons.FileSpreadsheet size={20}/></button>
                            {!isLocked && <Button onClick={() => { setEditingEmployee({ isNew: true, reportsTo: 'STAGING' }); setIsModalOpen(true); }} icon={Icons.Plus} className="hidden sm:flex">เพิ่ม</Button>}
                            {currentUser.role === 'admin' && <button onClick={()=>setIsAdminPanelOpen(true)} className="p-2 text-gray-600 hover:bg-gray-100 rounded-full"><Icons.Settings size={20}/></button>}
                            <button onClick={()=>{localStorage.removeItem('currentUser');setCurrentUser(null);}} className="text-red-500 hover:bg-red-50 p-2 rounded-full"><Icons.LogOut size={20}/></button>
                        </div>
                    </nav>

                    {moveSource && <div className="bg-blue-600 text-white p-2 text-center text-sm sticky top-14 z-50 shadow-md animate-bounce">กำลังย้าย: <b>{moveSource.name}</b> <span className="text-xs opacity-80 cursor-pointer ml-4 underline" onClick={()=>setMoveSource(null)}>ยกเลิก</span></div>}
                    {linkStartId && <div className="bg-yellow-500 text-white p-2 text-center text-sm sticky top-14 z-50 shadow-md animate-pulse">Select a node to link annotation... <span className="cursor-pointer underline ml-2" onClick={()=>setLinkStartId(null)}>Cancel</span></div>}

                    <div className="flex flex-1 overflow-hidden relative">
                        {viewMode === 'chart' && (
                            <>
                                <aside ref={sidebarRef} className={`fixed inset-y-0 left-0 z-40 bg-white border-r transform transition-transform duration-300 pt-20 md:pt-4 ${isSidebarOpen?'translate-x-0':'-translate-x-full'} ${isSidebarCollapsed?'w-0 overflow-hidden':''} md:relative md:translate-x-0`} style={{ width: isSidebarCollapsed?'0px':(window.innerWidth>768?`${sidebarWidth}px`:'16rem') }}>
                                    <div className="px-4 flex justify-between mb-4"><h2 className="font-bold text-gray-600">WAITING ({stagingEmployees.length})</h2>{!isLocked && <button onClick={() => { setEditingEmployee({ isNew: true, reportsTo: 'STAGING' }); setIsModalOpen(true); }}><Icons.Plus size={18} className="text-blue-600"/></button>}</div>
                                    <div className="px-4 space-y-3 overflow-y-auto h-[calc(100%-3rem)] pb-20">{stagingEmployees.map(emp => <EmployeeCard key={emp.id} employee={emp} onClick={(e)=>{setEditingEmployee({...e,isNew:false});setIsModalOpen(true);}} onDragStart={(e,id)=>{const p = (selectionMode && selectedIds.includes(id)) ? selectedIds : [id]; e.dataTransfer.setData("empIds", JSON.stringify(p));}} onMoveInit={(e)=>{setMoveSource(e);setIsSidebarOpen(false);}} isStaging={true} isSelected={selectedIds.includes(emp.id)} isLocked={isLocked} selectionMode={selectionMode} toggleSelection={toggleSelection}/>)}</div>
                                    <div className="sidebar-resizer hidden md:block" onMouseDown={()=>isResizing.current=true}></div>
                                    <button className="sidebar-toggle-btn hidden md:flex" style={{right: '-12px', borderRadius: '50%', width: '24px', height: '24px'}} onClick={()=>setIsSidebarCollapsed(true)}><Icons.ChevronLeft size={14}/></button>
                                </aside>
                                {isSidebarCollapsed && <button className="sidebar-toggle-btn hidden md:flex" style={{left: '0', borderTopRightRadius: '8px', borderBottomRightRadius: '8px'}} onClick={()=>setIsSidebarCollapsed(false)}><Icons.ChevronRight size={18}/></button>}
                            </>
                        )}

                        <main className="flex-1 bg-gray-100 p-2 sm:p-8 overflow-auto relative touch-pan-x touch-pan-y" style={viewMode==='chart'?{backgroundImage:'radial-gradient(#cbd5e1 1px, transparent 1px)',backgroundSize:'20px 20px'}:{}}>
                            {showRulers && viewMode === 'chart' && <><Ruler orientation="horizontal" length={3000} /><Ruler orientation="vertical" length={2000} /></>}
                            {viewMode === 'chart' ? (
                                <div className={`min-h-full flex flex-col items-center origin-top-left transition-transform duration-100 ${showRulers ? 'mt-8 ml-8' : ''}`} style={{ transform: `scale(${zoom})`, transformOrigin: '0 0', width: 'fit-content', minWidth: '100%' }}>
                                    <DraggableLogo logo={logo} setLogo={setLogo} isLocked={isLocked} />
                                    {annotations.map(ann => <DraggableAnnotation key={ann.id} ann={ann} onUpdate={handleUpdateAnnotation} onDelete={handleDeleteAnnotation} isLocked={isLocked} onLinkStart={setLinkStartId} />)}
                                    <svg className="absolute top-0 left-0 w-full h-full pointer-events-none z-0" style={{overflow:'visible'}}>{connectors}</svg>

                                    <div id="org-chart-full-view" className="bg-white p-8 rounded-2xl border shadow-xl inline-block min-w-max org-chart-container relative">
                                        <div className="text-left mb-6 border-b-2 border-gray-200 pb-2 pl-2">
                                            <input value={deptName} onChange={(e)=>setDeptName(e.target.value)} className="text-3xl font-bold uppercase outline-none bg-transparent" style={{color: headerColor}} disabled={isLocked}/>
                                            {!isLocked && <input type="color" value={headerColor} onChange={(e)=>setHeaderColor(e.target.value)} className="ml-2 w-6 h-6 border-none cursor-pointer" title="Header Color"/>}
                                            <p className="text-gray-400 text-sm mt-1">Updated: {lastUpdated}</p>
                                        </div>
                                        <div className="flex gap-16 justify-center">{rootEmployees.map(root => <EmployeeNode key={root.id} employee={root} allEmployees={employees} onEdit={(e)=>{setEditingEmployee({...e,isNew:false});setIsModalOpen(true);}} onDelete={handleDelete} onAddSubordinate={(id)=>{setEditingEmployee({isNew:true,reportsTo:id});setIsModalOpen(true);}} onDrop={handleDropOnChart} onMoveSelect={(tid)=>{if(moveSource&&moveSource.id!==tid){handleDropOnChart(moveSource.id,tid);setMoveSource(null);}}} moveTargetId={moveSource?.id} isLocked={isLocked} themeConf={currentThemeConf} shapeClass={appShape} selectionMode={selectionMode} selectedIds={selectedIds} toggleSelection={toggleSelection} onReorder={handleReorder} onAddChild={handleAddChild} />)}</div>
                                    </div>
                                    <div className="h-20"></div>
                                </div>
                            ) : (
                                <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
                                    <table className="min-w-full divide-y divide-gray-200"><thead className="bg-gray-50"><tr><th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Employee</th><th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase hidden sm:table-cell">Position</th></tr></thead><tbody className="bg-white divide-y divide-gray-200">{employees.map(emp => <tr key={emp.id} onClick={()=>{setEditingEmployee({...emp,isNew:false});setIsModalOpen(true);}} className="cursor-pointer hover:bg-gray-50"><td className="px-4 py-3 flex items-center gap-3"><img className="h-8 w-8 rounded-full bg-gray-200" src={emp.image||"https://via.placeholder.com/100"}/><div><div className="text-sm font-medium">{emp.name}</div><div className="text-xs text-gray-500 sm:hidden">{emp.position}</div></div></td><td className="px-4 py-3 text-sm text-gray-500 hidden sm:table-cell">{emp.position}</td></tr>)}</tbody></table>
                                </div>
                            )}
                            {viewMode === 'chart' && (
                                <>
                                    <div className="zoom-controls"><Icons.ZoomOut onClick={()=>setZoom(z=>Math.max(0.3,z-0.1))}/><span className="text-xs font-mono w-8 text-right">{Math.round(zoom*100)}%</span><Icons.ZoomIn onClick={()=>setZoom(z=>Math.min(1.5,z+0.1))}/></div>
                                    {!isLocked && historyIndex >= 0 && ( <div className="undo-controls"><button onClick={handleUndo} className="bg-white text-gray-700 p-3 rounded-full shadow-lg border hover:bg-gray-50 flex items-center gap-2 group undo-btn" title="Undo Last Action"><Icons.RotateCcw size={20}/></button></div> )}
                                    {selectionMode && selectedIds.length > 0 && (
                                        <div className="batch-actions">
                                            <span className="text-sm font-bold text-gray-600">{selectedIds.length} Selected</span>
                                            <button onClick={()=>setIsBatchEditOpen(true)} className="p-2 bg-blue-100 text-blue-600 rounded hover:bg-blue-200" title="Edit All"><Icons.Edit/></button>
                                            <button onClick={handleBatchDelete} className="p-2 bg-red-100 text-red-600 rounded hover:bg-red-200" title="Delete All"><Icons.Trash2/></button>
                                        </div>
                                    )}
                                </>
                            )}
                        </main>
                    </div>

                    {showDebug && <DebugConsole logs={debugLogs} onClose={()=>setShowDebug(false)} onClear={()=>setDebugLogs([])}/>}
                    {isModalOpen && <EmployeeForm employee={editingEmployee} supervisors={employees} positions={positions} onSave={handleSave} onCancel={()=>setIsModalOpen(false)} onDelete={handleDelete} onAddPosition={handleAddPosition} onDeletePosition={handleDeletePosition} role={currentUser.role} driveUrl={driveUrl} />}
                    {isThemePanelOpen && <ThemePanel onClose={() => setIsThemePanelOpen(false)} currentTheme={appTheme} setAppTheme={setAppTheme} currentShape={appShape} setAppShape={setAppShape} />}
                    {isSummaryOpen && <SummaryDashboard employees={employees} onClose={()=>setIsSummaryOpen(false)} />}
                    {isAdminPanelOpen && <AdminPanel onClose={() => setIsAdminPanelOpen(false)} driveUrl={driveUrl} setDriveUrl={setDriveUrl} apiCall={appApiCall} />}
                    {isBatchEditOpen && <BatchEditModal selectedCount={selectedIds.length} onClose={()=>setIsBatchEditOpen(false)} onSave={handleBatchEditSave} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
