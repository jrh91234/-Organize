<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HR Organize System (Authorized)</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; touch-action: manipulation; }
        .draggable-source { cursor: grab; } .draggable-source:active { cursor: grabbing; }
        .zoom-controls { position: fixed; bottom: 20px; right: 20px; background: white; padding: 10px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 40; display: flex; align-items: center; gap: 8px; border: 1px solid #e2e8f0; }
        .undo-controls { position: fixed; bottom: 80px; right: 20px; z-index: 40; display: flex; flex-direction: column; gap: 8px; }
        .batch-actions { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: white; padding: 10px 20px; border-radius: 50px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); z-index: 50; display: flex; gap: 12px; align-items: center; border: 1px solid #e2e8f0; animation: slideUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes slideUp { from { transform: translate(-50%, 100%); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }
        .sidebar-resizer { width: 5px; cursor: col-resize; background-color: transparent; position: absolute; right: 0; top: 0; bottom: 0; z-index: 50; } .sidebar-resizer:hover, .sidebar-resizer.resizing { background-color: #3b82f6; }
        .sidebar-toggle-btn { position: absolute; top: 50%; transform: translateY(-50%); width: 24px; height: 40px; background: white; border: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 50; box-shadow: 2px 0 5px rgba(0,0,0,0.1); color: #4b5563; }
        .reorder-controls { position: absolute; top: 50%; transform: translateY(-50%); display: flex; flex-direction: column; gap: 2px; z-index: 30; opacity: 0; transition: opacity 0.2s; } .group:hover .reorder-controls { opacity: 1; }
        .reorder-btn { background: white; border: 1px solid #e2e8f0; border-radius: 50%; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #64748b; box-shadow: 0 1px 2px rgba(0,0,0,0.1); font-size: 8px; } .reorder-btn:hover { background: #f1f5f9; color: #2563eb; transform: scale(1.1); }
        .paper-marker { position: absolute; font-size: 9px; color: #ef4444; font-weight: bold; pointer-events: none; display: flex; align-items: center; justify-content: center; z-index: 15; opacity: 0.8; background: rgba(255,255,255,0.8); padding: 0 2px; border-radius: 2px; }
        .paper-line { position: absolute; background-color: #ef4444; pointer-events: none; z-index: 14; opacity: 0.4; border-left: 1px dashed #ef4444; border-top: 1px dashed #ef4444; }
        @media print { nav, .zoom-controls, .undo-controls, .batch-actions, .sidebar-resizer, .sidebar-toggle-btn, aside { display: none !important; } }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 h-screen overflow-hidden">
    <div id="root" class="h-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback, useMemo } = React;

        // --- UTILS ---
        const formatDriveUrl = (url) => { if (!url) return "https://via.placeholder.com/100?text=No+Img"; if (url.includes('drive.google.com') || url.includes('docs.google.com')) { let id = null; const idMatch1 = url.match(/id=([a-zA-Z0-9_-]+)/); if (idMatch1) id = idMatch1[1]; else { const idMatch2 = url.match(/\/d\/([a-zA-Z0-9_-]+)/); if (idMatch2) id = idMatch2[1]; } if (id) return `https://lh3.googleusercontent.com/d/$${id}`; } return url; };
        const compressImage = (file, targetSizeKB = 512) => { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = (event) => { const img = new Image(); img.src = event.target.result; img.onload = () => { const canvas = document.createElement('canvas'); let width = img.width, height = img.height; const MAX = 1600; if (width > MAX || height > MAX) { if (width > height) { height *= MAX / width; width = MAX; } else { width *= MAX / height; height = MAX; } } canvas.width = width; canvas.height = height; const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height); let quality = 0.9, dataUrl = canvas.toDataURL('image/jpeg', quality); while (dataUrl.length * 0.75 > targetSizeKB * 1024 && quality > 0.1) { quality -= 0.1; dataUrl = canvas.toDataURL('image/jpeg', quality); } resolve(dataUrl); }; img.onerror = reject; }; reader.onerror = reject; }); };
        const formatDate = (dateString) => { if (!dateString) return ""; const date = new Date(dateString); if (isNaN(date)) return dateString; return date.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: '2-digit' }); };
        const calculateTenure = (dateString) => { if (!dateString) return ""; const start = new Date(dateString); const now = new Date(); if (isNaN(start)) return ""; let years = now.getFullYear() - start.getFullYear(); let months = now.getMonth() - start.getMonth(); if (months < 0 || (months === 0 && now.getDate() < start.getDate())) { years--; months += 12; } if (years < 0) return "New"; return `${years} ปี ${months} ด.`; };
        const exportToExcel = (employees) => { let csvContent = "data:text/csv;charset=utf-8,\uFEFFID,Name,Position,Dept,Type,Status,ReportsTo,StartDate,Phone,Order\n"; employees.forEach(e => { csvContent += `"${e.id}","${e.name}","${e.position}","${e.dept||''}","${e.type}","${e.status}","${e.reportsTo}","${e.startDate||''}","${e.phone||''}","${e.order||0}"\n`; }); const link = document.createElement("a"); link.setAttribute("href", encodeURI(csvContent)); link.setAttribute("download", "employees_export.csv"); document.body.appendChild(link); link.click(); document.body.removeChild(link); };

        // --- ICONS (Minimal Set) ---
        const IconBase = ({ children, size = 18, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>;
        const Icons = { 
            Camera: (p)=><IconBase {...p}><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></IconBase>, Plus: (p)=><IconBase {...p}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></IconBase>, Trash2: (p)=><IconBase {...p}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></IconBase>, X: (p)=><IconBase {...p}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></IconBase>, Check: (p)=><IconBase {...p}><polyline points="20 6 9 17 4 12"/></IconBase>, Settings: (p)=><IconBase {...p}><path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></IconBase>, Move: (p)=><IconBase {...p}><polyline points="5 9 2 12 5 15"/><polyline points="9 5 12 2 15 5"/><polyline points="19 9 22 12 19 15"/><polyline points="9 19 12 22 15 19"/><line x1="2" y1="12" x2="22" y2="12"/><line x1="12" y1="2" x2="12" y2="22"/></IconBase>, Menu: (p)=><IconBase {...p}><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></IconBase>, Grid: (p)=><IconBase {...p}><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></IconBase>, List: (p)=><IconBase {...p}><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></IconBase>, ChevronLeft: (p)=><IconBase {...p}><polyline points="15 18 9 12 15 6"/></IconBase>, ChevronRight: (p)=><IconBase {...p}><polyline points="9 18 15 12 9 6"/></IconBase>, ArrowUp: (p)=><IconBase {...p}><line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/></IconBase>, ArrowDown: (p)=><IconBase {...p}><line x1="12" y1="5" x2="12" y2="19"/><polyline points="19 12 12 19 5 12"/></IconBase>, ArrowLeft: (p)=><IconBase {...p}><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></IconBase>, ArrowRight: (p)=><IconBase {...p}><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></IconBase>, RotateCcw: (p)=><IconBase {...p}><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></IconBase>, RulerIcon: (p)=><IconBase {...p}><path d="M21.3 15.3a2.4 2.4 0 0 1 0 3.4l-2.6 2.6a2.4 2.4 0 0 1-3.4 0L2.7 8.7a2.4 2.4 0 0 1 0-3.4l2.6-2.6a2.4 2.4 0 0 1 3.4 0Z"/><line x1="14.5" y1="3.2" x2="18.8" y2="7.5"/><line x1="12.5" y1="5.2" x2="16.8" y2="9.5"/><line x1="10.5" y1="7.2" x2="14.8" y2="11.5"/><line x1="8.5" y1="9.2" x2="12.8" y2="13.5"/><line x1="6.5" y1="11.2" x2="10.8" y2="15.5"/><line x1="4.5" y1="13.2" x2="8.8" y2="17.5"/></IconBase>, Edit: (p)=><IconBase {...p}><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></IconBase>, Lock: (p)=><IconBase {...p}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></IconBase>, Unlock: (p)=><IconBase {...p}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></IconBase>, ZoomIn: (p)=><IconBase {...p}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="11" y1="8" x2="11" y2="14"/><line x1="8" y1="11" x2="14" y2="11"/></IconBase>, ZoomOut: (p)=><IconBase {...p}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="8" y1="11" x2="14" y2="11"/></IconBase>, LogOut: (p)=><IconBase {...p}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></IconBase>, Cloud: (p)=><IconBase {...p}><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></IconBase>, Loader: (p)=><IconBase {...p} className={`spinner ${p.className}`}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></IconBase>, Alert: (p)=><IconBase {...p}><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></IconBase>, Paint: (p)=><IconBase {...p}><path d="M18.375 2.625a2.121 2.121 0 1 1 3 3L12 15l-4 1 1-4Z"/><path d="m15 6.5 3 3"/><path d="M6 20h1a2 2 0 0 0 2-2V8a2 2 0 0 0-4 0v10a2 2 0 0 0 1 2Z"/></IconBase>, FileSpreadsheet: (p)=><IconBase {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M8 13h2"/><path d="M8 17h2"/><path d="M14 13h2"/><path d="M14 17h2"/></IconBase>, Chart: (p)=><IconBase {...p}><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></IconBase>, CheckSquare: (p)=><IconBase {...p}><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></IconBase>, Type: (p)=><IconBase {...p}><polyline points="4 7 4 4 20 4 20 7"/><line x1="9" y1="20" x2="15" y2="20"/><line x1="12" y1="4" x2="12" y2="20"/></IconBase>, Link: (p)=><IconBase {...p}><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></IconBase>, Search: (p)=><IconBase {...p}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></IconBase>, Upload: (p)=><IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></IconBase>, Home: (p)=><IconBase {...p}><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></IconBase> };

        const Button = ({ children, onClick, variant = 'primary', className = '', icon: Icon, disabled }) => { const base = "flex items-center justify-center px-3 py-2 rounded-lg font-medium transition-all active:scale-95 shadow-sm disabled:opacity-50 text-sm whitespace-nowrap"; const variants = { primary: "bg-blue-600 text-white hover:bg-blue-700", secondary: "bg-white text-gray-700 border border-gray-200 hover:bg-gray-50", danger: "bg-red-50 text-red-600 hover:bg-red-100 border border-red-100", success: "bg-green-600 text-white hover:bg-green-700", warning: "bg-orange-500 text-white hover:bg-orange-600", }; return <button type="button" onClick={onClick} disabled={disabled} className={`${base} ${variants[variant]} ${className}`}>{Icon && <Icon size={18} className="mr-2" />} {children}</button>; };
        const THEMES = { blue: { name: 'Blue', lv0: 'bg-blue-100 border-blue-600', lv1: 'bg-blue-50 border-blue-400', lvN: 'bg-white border-blue-200' }, teal: { name: 'Teal', lv0: 'bg-teal-100 border-teal-600', lv1: 'bg-teal-50 border-teal-400', lvN: 'bg-white border-teal-200' }, indigo: { name: 'Indigo', lv0: 'bg-indigo-100 border-indigo-600', lv1: 'bg-indigo-50 border-indigo-400', lvN: 'bg-white border-indigo-200' }, rose: { name: 'Rose', lv0: 'bg-rose-100 border-rose-600', lv1: 'bg-rose-50 border-rose-400', lvN: 'bg-white border-rose-200' }, slate: { name: 'Slate', lv0: 'bg-slate-200 border-slate-600', lv1: 'bg-slate-100 border-slate-400', lvN: 'bg-white border-slate-300' }, orange: { name: 'Orange', lv0: 'bg-orange-100 border-orange-600', lv1: 'bg-orange-50 border-orange-400', lvN: 'bg-white border-orange-200' } };
        const SHAPES = { rounded: { name: 'Rounded', cls: 'rounded-xl' }, sharp: { name: 'Square', cls: 'rounded-none' }, pill: { name: 'Pill', cls: 'rounded-[2rem]' }, leaf: { name: 'Leaf', cls: 'rounded-tr-3xl rounded-bl-3xl rounded-tl-md rounded-br-md' } };

        // --- COMPONENTS ---
        // [RESTORED] Admin Panel with Dept Authorization
        const AdminPanel = ({ onClose, driveUrl, setDriveUrl, apiCall, depts }) => { 
            const [users, setUsers] = useState([]);
            const [newUser, setNewUser] = useState({ username: '', password: '', role: 'leader', name: '', dept: 'ALL' }); 
            const [editingUsername, setEditingUsername] = useState(null);
            useEffect(() => { const loadUsers = async () => { let loadedUsers = []; if (driveUrl) { try { const res = await apiCall(driveUrl, 'getUsers'); if (res?.status === 'success') loadedUsers = res.users; } catch (e) {} } if (loadedUsers.length === 0) loadedUsers = JSON.parse(localStorage.getItem('users')) || []; setUsers(loadedUsers); }; loadUsers(); }, [driveUrl]);
            const saveUserAction = async () => { if (!newUser.username || !newUser.password) return alert("กรุณากรอก User/Pass"); let updatedUsers; if (editingUsername) updatedUsers = users.map(u => u.username === editingUsername ? newUser : u); else { if (users.some(u => u.username === newUser.username)) return alert('ชื่อซ้ำ'); updatedUsers = [...users, newUser]; } setUsers(updatedUsers); localStorage.setItem('users', JSON.stringify(updatedUsers)); if (driveUrl) try { await apiCall(driveUrl, 'saveUser', { user: newUser }); } catch (e) {} setEditingUsername(null); setNewUser({ username: '', password: '', role: 'leader', name: '', dept: 'ALL' }); };
            const deleteUserAction = async (username) => { if (!confirm('ยืนยันลบ?')) return; const updated = users.filter(u => u.username !== username); setUsers(updated); localStorage.setItem('users', JSON.stringify(updated)); if (driveUrl) await apiCall(driveUrl, 'deleteUser', { username }); };
            return ( <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[70]"><div className="bg-white w-full max-w-4xl rounded-2xl shadow-xl overflow-hidden flex flex-col max-h-[90vh]"> <div className="p-6 border-b flex justify-between items-center"><h2 className="text-xl font-bold">Admin Panel</h2><button onClick={onClose}><Icons.X /></button></div> <div className="p-6 overflow-y-auto space-y-6"> <div className="bg-blue-50 p-4 rounded-lg"><h3 className="font-bold text-blue-800 mb-2">Google Script URL</h3><input type="text" value={driveUrl} onChange={(e) => setDriveUrl(e.target.value)} className="w-full p-2 border rounded text-sm"/></div> <div><h3 className="font-bold mb-4">Users</h3> <div className="flex gap-2 mb-4 items-end bg-gray-50 p-3 rounded flex-wrap"><div className="w-32"><label className="text-xs text-gray-500">User</label><input value={newUser.username} onChange={e => setNewUser({...newUser, username: e.target.value})} className="border p-2 rounded text-sm w-full" disabled={!!editingUsername}/></div><div className="w-32"><label className="text-xs text-gray-500">Pass</label><input value={newUser.password} onChange={e => setNewUser({...newUser, password: e.target.value})} className="border p-2 rounded text-sm w-full"/></div><div className="flex-1"><label className="text-xs text-gray-500">Name</label><input value={newUser.name} onChange={e => setNewUser({...newUser, name: e.target.value})} className="border p-2 rounded text-sm w-full"/></div><div className="w-28"><label className="text-xs text-gray-500">Role</label><select value={newUser.role} onChange={e => setNewUser({...newUser, role: e.target.value})} className="border p-2 rounded text-sm w-full"><option value="admin">Admin</option><option value="supervisor">Sup</option><option value="leader">Leader</option></select></div><div className="w-32"><label className="text-xs text-gray-500">Dept (Auth)</label><select value={newUser.dept} onChange={e => setNewUser({...newUser, dept: e.target.value})} className="border p-2 rounded text-sm w-full"><option value="ALL">ALL (Admin)</option>{depts.map(d=><option key={d} value={d}>{d}</option>)}</select></div><button onClick={saveUserAction} className="bg-green-600 text-white p-2 rounded h-[38px] w-[38px] flex justify-center items-center"><Icons.Plus size={18}/></button></div> <table className="w-full text-sm text-left"><thead className="bg-gray-100"><tr><th className="p-2">User</th><th className="p-2">Name</th><th className="p-2">Role</th><th className="p-2">Dept</th><th className="p-2">Act</th></tr></thead><tbody>{users.map((u, i) => <tr key={i} className="border-b"><td className="p-2">{u.username}</td><td className="p-2">{u.name}</td><td className="p-2">{u.role}</td><td className="p-2 font-bold text-blue-600">{u.dept||'ALL'}</td><td className="p-2 flex gap-2"><button onClick={() => { setNewUser(u); setEditingUsername(u.username); }} className="text-orange-500"><Icons.Edit size={16}/></button><button onClick={() => deleteUserAction(u.username)} className="text-red-500"><Icons.Trash2 size={16}/></button></td></tr>)}</tbody></table> </div> </div> </div></div> ); };
        
        const ManageDeptsModal = ({ depts, onAdd, onDelete, onClose }) => { const [newD, setNewD] = useState(""); return ( <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[70]"> <div className="bg-white rounded-xl shadow-xl p-6 w-full max-w-sm"> <div className="flex justify-between items-center mb-4"><h3 className="font-bold flex items-center"><Icons.Grid className="mr-2"/> Manage Departments</h3><button onClick={onClose}><Icons.X/></button></div> <div className="flex gap-2 mb-4"><input value={newD} onChange={e=>setNewD(e.target.value)} placeholder="New Dept..." className="flex-1 border p-2 rounded text-sm"/><button onClick={()=>{if(newD){onAdd(newD);setNewD('');}}} className="bg-green-600 text-white p-2 rounded"><Icons.Plus/></button></div> <div className="max-h-60 overflow-y-auto space-y-2">{depts.map(d => (<div key={d} className="flex justify-between items-center p-2 bg-gray-50 rounded text-sm group"><span>{d}</span><button onClick={()=>onDelete(d)} className="text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100"><Icons.Trash2 size={16}/></button></div>))}</div> </div> </div> ); };

        // [UPDATE] EmployeeCard with Phone, Tenure & Reorder
        const EmployeeCard = React.memo(({ employee, onClick, onDragStart, onMoveInit, className="", isStaging=false, isSelected=false, isLocked=false, selectionMode, toggleSelection, onReorder }) => {
            const isSub = employee.type === 'Subcontract';
            let bgClass = "bg-white"; let borderClass = "border-gray-200"; 
            if (employee.customColor && THEMES[employee.customColor]) { const s = THEMES[employee.customColor].lv0.split(' '); bgClass = s.find(c=>c.startsWith('bg-'))||bgClass; borderClass = s.find(c=>c.startsWith('border-'))||borderClass; }
            const tenure = calculateTenure(employee.startDate);
            return (
                <div draggable={!isLocked} onDragStart={(e) => !isLocked && onDragStart && onDragStart(e, employee.id)} className={`relative flex flex-col items-center p-3 border-b-4 shadow-sm w-36 sm:w-40 transition-transform duration-200 cursor-pointer group ${bgClass} ${borderClass} rounded-xl ${isSelected?'ring-4 ring-purple-500 scale-105 z-20 shadow-xl':'hover:scale-105'} ${isLocked?'cursor-default':'draggable-source'} ${className}`} onClick={(e) => { e.stopPropagation(); if(selectionMode) toggleSelection(employee.id); else if(!isLocked) onClick(employee); }} id={`node-${employee.id}`}>
                    <div className={`absolute top-2 left-2 px-1.5 py-0.5 rounded text-[10px] font-bold text-white ${isSub?'bg-orange-500':'bg-blue-600'}`}>{isSub?'S':'P'}</div>
                    {selectionMode && <div className={`absolute top-2 right-2 w-5 h-5 rounded-full border-2 flex items-center justify-center ${isSelected?'bg-purple-600 border-purple-600':'border-gray-300 bg-white'}`}>{isSelected && <Icons.Check size={12} className="text-white"/>}</div>}
                    {!isLocked && !isStaging && !selectionMode && ( <> 
                        <div className="reorder-controls" style={{left: '-10px'}}> <button className="reorder-btn" onClick={(e)=>{ e.stopPropagation(); onReorder(employee.id, -4); }}><Icons.ArrowUp size={8}/></button> <button className="reorder-btn" onClick={(e)=>{e.stopPropagation(); onReorder(employee.id, -1)}}><Icons.ArrowLeft size={8}/></button> </div> 
                        <div className="reorder-controls" style={{right: '-10px'}}> <button className="reorder-btn" onClick={(e)=>{ e.stopPropagation(); onReorder(employee.id, 4); }}><Icons.ArrowDown size={8}/></button> <button className="reorder-btn" onClick={(e)=>{e.stopPropagation(); onReorder(employee.id, 1)}}><Icons.ArrowRight size={8}/></button> </div> 
                    </> )}
                    <div className="relative"><img src={formatDriveUrl(employee.image)} className="w-14 h-14 sm:w-16 sm:h-16 rounded-full object-cover border-2 border-white shadow-sm bg-gray-200 pointer-events-none" onError={(e)=>{e.target.src="https://via.placeholder.com/100"}}/><div className="absolute -bottom-1 -right-1 bg-white rounded-full p-1 shadow"><div className={`w-3 h-3 rounded-full ${employee.status==='Active'?'bg-green-500':'bg-red-500'}`}></div></div></div>
                    <div className="mt-2 text-center w-full" style={{color: employee.textColor}}><p className="text-[10px] sm:text-xs font-bold opacity-60">{employee.id}</p><h3 className="text-xs sm:text-sm font-bold leading-tight truncate w-full">{employee.name}</h3><p className="text-[10px] sm:text-xs opacity-70 truncate w-full">{employee.position}</p>
                    {employee.showPhone && employee.phone && <p className="text-[10px] text-blue-600 mt-0.5 bg-blue-50 rounded px-1">{employee.phone}</p>}
                    {tenure && <div className="text-[9px] bg-green-50 text-green-700 px-1 rounded mt-1 border border-green-100">{tenure}</div>}
                    </div>
                    {isStaging && !isLocked && !selectionMode && <button onClick={(e)=>{e.stopPropagation();onMoveInit(employee);}} className="absolute top-1 right-1 p-1.5 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-full"><Icons.Move size={14}/></button>}
                </div>
            );
        });

        const EmployeeNode = React.memo(({ employee, allEmployees, onEdit, onDrop, onMoveSelect, moveTargetId, isLocked, selectionMode, selectedIds, toggleSelection, onReorder, onAddChild, layoutThreshold, searchTerm, visitedIds = new Set() }) => {
            const [isDragOver, setIsDragOver] = useState(false);
            if (!employee || visitedIds.has(employee.id)) return null;
            const newVisited = new Set(visitedIds).add(employee.id);
            const subordinates = allEmployees.filter(e => e.reportsTo === employee.id && !newVisited.has(e.id)).sort((a, b) => (a.order || 0) - (b.order || 0));
            const isMatch = searchTerm && employee.name.toLowerCase().includes(searchTerm.toLowerCase());
            const handleDropInternal = (e) => { if(isLocked)return; e.preventDefault(); setIsDragOver(false); const rawData = e.dataTransfer.getData("empIds"); const droppedIds = rawData ? JSON.parse(rawData) : []; if(droppedIds.length > 0 && !droppedIds.includes(employee.id)) onDrop(droppedIds, employee.id); };
            return (
                <div className="flex flex-col items-center">
                    <div onDragOver={(e)=>{if(!isLocked){e.preventDefault();setIsDragOver(true);}}} onDragLeave={()=>setIsDragOver(false)} onDrop={handleDropInternal} onClick={()=>moveTargetId && !isLocked && onMoveSelect(employee.id)} className={`relative z-10 group transition-all ${isDragOver?'scale-110':''} ${moveTargetId?'cursor-crosshair':''}`}>
                        {moveTargetId && !isLocked && <div className="absolute -inset-2 border-2 border-dashed border-blue-400 rounded-2xl bg-blue-50/50 z-20 flex items-center justify-center animate-pulse pointer-events-none"><span className="bg-blue-600 text-white text-[10px] px-2 py-0.5 rounded-full">เลือกเป็นหัวหน้า</span></div>}
                        <EmployeeCard employee={employee} onClick={onEdit} onDragStart={(e, id)=>{ const payload = (selectionMode && selectedIds.includes(id)) ? selectedIds : [id]; e.dataTransfer.setData("empIds", JSON.stringify(payload)); }} className={isMatch?"flash-active":""} isLocked={isLocked} selectionMode={selectionMode} selectedIds={selectedIds} isSelected={selectedIds.includes(employee.id)} toggleSelection={toggleSelection} onReorder={onReorder}/>
                        {!moveTargetId && !isLocked && !selectionMode && <button onClick={(e)=>{e.stopPropagation();onAddChild(employee);}} className="absolute -bottom-3 left-1/2 -translate-x-1/2 bg-white text-blue-600 border border-blue-200 rounded-full w-6 h-6 flex items-center justify-center shadow-md active:scale-95"><Icons.Plus size={14}/></button>}
                    </div>
                    {subordinates.length > 0 && ( <> <div className="h-4 sm:h-6 w-px bg-gray-300"></div> <div className="flex relative gap-4 sm:gap-6 pt-0 p-4 rounded-xl"> {subordinates.map((sub, i) => (<div key={sub.id} className="relative flex flex-col items-center"> {subordinates.length > 1 && <div className={`absolute top-0 h-px bg-gray-300 ${i===0?'w-1/2 right-0':''} ${i===subordinates.length-1?'w-1/2 left-0':''} ${i>0 && i<subordinates.length-1?'w-full':''}`}></div>} <EmployeeNode employee={sub} allEmployees={allEmployees} onEdit={onEdit} onDrop={onDrop} onMoveSelect={onMoveSelect} moveTargetId={moveTargetId} isLocked={isLocked} selectionMode={selectionMode} selectedIds={selectedIds} toggleSelection={toggleSelection} onReorder={onReorder} onAddChild={onAddChild} layoutThreshold={layoutThreshold} searchTerm={searchTerm} visitedIds={newVisited}/> </div>))} </div> </> )}
                </div>
            );
        });

        // [UPDATE] Employee Form with Logic for ReportsTo & Fields
        const EmployeeForm = ({ employee, supervisors, positions, depts, onSave, onCancel, onDelete, role, driveUrl, onAddPosition }) => {
            const [formData, setFormData] = useState({ id: '', name: '', position: '', dept: '', reportsTo: '', image: null, status: 'Active', type: 'Permanent', phone: '', showPhone: true, startDate: '' });
            const [showDeleteConfirm, setShowDeleteConfirm] = useState(false); const [isUploading, setIsUploading] = useState(false); const [tab, setTab] = useState('info'); 
            const fileInputRef = useRef(null); const isEditMode = employee && !employee.isNew;
            useEffect(() => { if (isEditMode) setFormData({ type: 'Permanent', phone: '', showPhone: true, startDate: '', ...employee }); else setFormData({ id: Math.floor(60000 + Math.random() * 9000).toString(), name: '', position: employee?.position || '', dept: employee?.dept || (depts[0] || ''), reportsTo: employee?.reportsTo || '', image: null, status: 'Active', type: 'Permanent', phone: '', showPhone: true, startDate: '' }); }, [employee]);
            const handleImageUpload = async (e) => { const file = e.target.files[0]; if (!file) return; try { setIsUploading(true); const compressedBase64 = await compressImage(file, 512); if (driveUrl) { const res = await fetch(driveUrl, { method: 'POST', body: JSON.stringify({ action: 'upload', file: compressedBase64.split(',')[1], filename: `emp_${formData.id}.jpg`, mimetype: 'image/jpeg', oldFileUrl: formData.image }) }); const result = await res.json(); if (result?.url) { setFormData(prev => ({ ...prev, image: result.url })); } } else { setFormData(prev => ({ ...prev, image: compressedBase64 })); } } catch (err) { alert(err.message); } finally { setIsUploading(false); } };
            // [LOGIC] Filter Supervisors: Exclude Operator/Feeder
            const filteredSupervisors = useMemo(() => supervisors.filter(s => {
                if (s.id === formData.id) return false;
                const pos = (s.position || "").toLowerCase();
                return !pos.endsWith('operator') && !pos.endsWith('feeder');
            }), [supervisors, formData.id]);

            return (
                <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-[60] p-4">
                    <div className="bg-white w-full max-w-md rounded-2xl shadow-2xl flex flex-col max-h-[90vh]">
                        <div className="bg-gray-50 px-6 py-4 border-b flex justify-between items-center"><h2 className="text-lg font-bold">{isEditMode ? 'Edit Employee' : 'Add Employee'}</h2><button onClick={onCancel}><Icons.X/></button></div>
                        <div className="flex border-b"><button onClick={()=>setTab('info')} className={`flex-1 py-3 text-sm font-medium ${tab==='info'?'text-blue-600 border-b-2 border-blue-600':'text-gray-500'}`}>General Info</button><button onClick={()=>setTab('style')} className={`flex-1 py-3 text-sm font-medium ${tab==='style'?'text-blue-600 border-b-2 border-blue-600':'text-gray-500'}`}>Appearance</button></div>
                        <form className="p-6 space-y-4 overflow-y-auto grow">
                            {tab === 'info' ? (<> 
                            <div className="flex flex-col items-center mb-4"><div className="w-20 h-20 rounded-full bg-gray-100 border-4 border-white shadow-md flex items-center justify-center overflow-hidden cursor-pointer relative group" onClick={()=>fileInputRef.current.click()}>{isUploading ? <Icons.Loader/> : (formData.image ? <img src={formatDriveUrl(formData.image)} className="w-full h-full object-cover"/> : <Icons.Camera size={24} className="text-gray-400"/>)}</div><input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={handleImageUpload} /></div>
                            <div className="grid grid-cols-2 gap-4"><div><label className="text-xs text-gray-500">ID</label><input name="id" value={formData.id} onChange={e=>setFormData({...formData, id: e.target.value})} className="w-full border p-2 rounded" disabled={isEditMode}/></div><div><label className="text-xs text-gray-500">Department</label><select name="dept" value={formData.dept} onChange={e=>setFormData({...formData, dept: e.target.value})} className="w-full border p-2 rounded bg-blue-50">{depts.map(d=><option key={d} value={d}>{d}</option>)}</select></div></div>
                            <div><label className="text-xs text-gray-500">Name</label><input value={formData.name} onChange={e=>setFormData({...formData, name: e.target.value})} className="w-full border p-2 rounded" required/></div>
                            <div className="grid grid-cols-2 gap-4"><div><label className="text-xs text-gray-500">Start Date</label><input type="date" value={formData.startDate} onChange={e=>setFormData({...formData, startDate: e.target.value})} className="w-full border p-2 rounded"/></div><div><label className="text-xs text-gray-500">Phone</label><div className="flex gap-1"><input value={formData.phone} onChange={e=>setFormData({...formData, phone: e.target.value})} className="w-full border p-2 rounded" placeholder="08x..."/><input type="checkbox" checked={formData.showPhone} onChange={e=>setFormData({...formData, showPhone: e.target.checked})} title="Show on card"/></div></div></div>
                            <div><label className="text-xs text-gray-500">Position</label><select value={formData.position} onChange={e=>setFormData({...formData, position: e.target.value})} className="w-full border p-2 rounded">{positions.map(p=><option key={p} value={p}>{p}</option>)}</select></div>
                            <div><label className="text-xs text-gray-500">Reports To (Filtered Leader+)</label><select value={formData.reportsTo} onChange={e=>setFormData({...formData, reportsTo: e.target.value})} className="w-full border p-2 rounded bg-gray-50"><option value="STAGING">-- Waiting Area --</option><option value="">-- Top Management --</option>{filteredSupervisors.map(s=><option key={s.id} value={s.id}>{s.name} ({s.position})</option>)}</select></div>
                            </>) : (<div className="space-y-6"><div><label className="text-xs text-gray-500 mb-2 block">Card Color</label><div className="grid grid-cols-5 gap-2"><button type="button" onClick={()=>setFormData({...formData, customColor: ''})} className="h-8 rounded-lg border bg-white text-xs">None</button>{Object.entries(THEMES).map(([k,t]) => (<button type="button" key={k} onClick={()=>setFormData({...formData, customColor: k})} className={`h-8 rounded-lg ${t.lv0}`}></button>))}</div></div></div>)}
                        </form>
                        <div className="bg-gray-50 px-6 py-4 border-t flex justify-between">{isEditMode && role!=='leader' && (!showDeleteConfirm ? <Button variant="danger" onClick={()=>setShowDeleteConfirm(true)} icon={Icons.Trash2}>Delete</Button> : <div className="flex gap-2"><Button variant="danger" onClick={()=>onDelete(formData.id)}>Confirm</Button><Button variant="secondary" onClick={()=>setShowDeleteConfirm(false)}>No</Button></div>)}{!showDeleteConfirm && <div className="flex gap-2 ml-auto"><Button variant="secondary" onClick={onCancel}>Cancel</Button><Button variant="primary" onClick={()=>onSave(formData)}>Save</Button></div>}</div>
                    </div>
                </div>
            );
        };
        const LoginScreen = ({ onLogin, driveUrl, apiCall }) => { const [creds, setCreds] = useState({ username: '', password: '' }); const [loading, setLoading] = useState(false); const handleSubmit = async (e) => { e.preventDefault(); setLoading(true); try { if (driveUrl) { const res = await apiCall(driveUrl, 'login', creds); if (res?.status === 'success') { onLogin(res.user); return; } } if (creds.username === 'admin' && creds.password === 'password') { onLogin({ username: 'admin', name: 'System Admin', role: 'admin', dept: 'ALL' }); } else { alert("Login failed"); } } catch (err) { alert("Error"); } finally { setLoading(false); } }; return ( <div className="h-screen flex items-center justify-center bg-slate-900 px-4"> <div className="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm"> <div className="flex flex-col items-center mb-8"> <div className="bg-red-600 p-3 rounded-xl text-white font-bold text-2xl mb-2">HR</div> <h1 className="text-xl font-bold text-gray-800">Organize System</h1> </div> <form onSubmit={handleSubmit} className="space-y-4"> <input type="text" placeholder="Username" className="w-full p-3 border rounded-lg" onChange={e => setCreds({...creds, username: e.target.value})} required /> <input type="password" placeholder="Password" className="w-full p-3 border rounded-lg" onChange={e => setCreds({...creds, password: e.target.value})} required /> <button type="submit" disabled={loading} className="w-full bg-blue-600 text-white p-3 rounded-lg font-bold hover:bg-blue-700 transition-colors"> {loading ? 'Logging in...' : 'Login'} </button> </form> </div> </div> ); };
        
        // [NEW] Department Selection Landing Page
        const LandingPage = ({ departments, user, onSelectDept }) => {
            const availableDepts = user.dept === 'ALL' ? departments : [user.dept];
            return (
                <div className="h-screen flex items-center justify-center bg-gray-50 px-4">
                    <div className="w-full max-w-4xl">
                        <h1 className="text-3xl font-bold text-center mb-8 text-gray-800">เลือกแผนกเพื่อเข้าใช้งาน</h1>
                        <p className="text-center text-gray-500 mb-8">สวัสดี, {user.name} ({user.role})</p>
                        <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
                            {availableDepts.map(dept => (
                                <button key={dept} onClick={() => onSelectDept(dept)} className="bg-white p-8 rounded-2xl shadow-lg hover:shadow-xl transition-all border border-gray-100 flex flex-col items-center group hover:border-blue-500">
                                    <div className="w-16 h-16 bg-blue-50 rounded-full flex items-center justify-center text-blue-600 mb-4 group-hover:bg-blue-600 group-hover:text-white transition-colors"><Icons.Briefcase size={32}/></div>
                                    <h3 className="text-xl font-bold text-gray-800">{dept}</h3>
                                    <p className="text-sm text-gray-400 mt-2">Click to enter</p>
                                </button>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [currentUser, setCurrentUser] = useState(() => JSON.parse(localStorage.getItem('currentUser')));
            const [employees, setEmployees] = useState(() => JSON.parse(localStorage.getItem('orgData')) || []);
            const [positions, setPositions] = useState(() => JSON.parse(localStorage.getItem('orgPositions')) || ["Manager", "Supervisor", "Engineer", "Leader", "Operator"]);
            const [departments, setDepartments] = useState(() => JSON.parse(localStorage.getItem('orgDepartments')) || ["ASSEMBLY", "QC", "HR"]);
            const [currentDept, setCurrentDept] = useState(null); // Null = Landing Page
            const [driveUrl, setDriveUrl] = useState("https://script.google.com/macros/s/AKfycbxYxBWD4blG_bP9hdTm_W8RP9PtM9CLZovmSFQVVsQTcBl18uxcaAxrhW5lZKFmEj8H/exec");
            const [viewMode, setViewMode] = useState('chart'); 
            const [zoom, setZoom] = useState(1);
            const [searchTerm, setSearchTerm] = useState('');
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingEmployee, setEditingEmployee] = useState(null);
            const [selectionMode, setSelectionMode] = useState(false);
            const [selectedIds, setSelectedIds] = useState([]);
            const [isSidebarCollapsed, setIsSidebarCollapsed] = useState(false);
            const [isAdminPanelOpen, setIsAdminPanelOpen] = useState(false);
            const [isSummaryOpen, setIsSummaryOpen] = useState(false);
            const [isManageDeptsOpen, setIsManageDeptsOpen] = useState(false);
            const [logo, setLogo] = useState({ url: null, x: 50, y: 50 });
            const [history, setHistory] = useState([]);
            const [historyIndex, setHistoryIndex] = useState(-1);
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);
            const [sidebarWidth, setSidebarWidth] = useState(256);
            const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
            const isResizing = useRef(false);

            const appApiCall = async (url, action, payload) => { try { const res = await fetch(url, { method: 'POST', body: JSON.stringify({ action, ...payload }) }); return await res.json(); } catch (e) { throw e; } };
            const syncUpdatesToCloud = async (updates = [], deletes = []) => { if (!driveUrl) return; try { await appApiCall(driveUrl, 'updateEmployees', { updates, deletes }); } catch (e) {} };
            useEffect(() => { if (driveUrl && currentUser) { appApiCall(driveUrl, 'getData').then(res => { if (res?.status === 'success' && res.data) { if (res.data.orgData) setEmployees(res.data.orgData); if (res.data.orgPositions) setPositions(res.data.orgPositions); if (res.data.orgDepartments) setDepartments(res.data.orgDepartments); } }); } }, [driveUrl, currentUser]);
            
            const pushToHistory = (newData) => { const newHistory = history.slice(0, historyIndex + 1); newHistory.push(newData); if (newHistory.length > 10) newHistory.shift(); setHistory(newHistory); setHistoryIndex(newHistory.length - 1); };
            const handleUndo = () => { if (historyIndex > 0) { const prevState = history[historyIndex - 1]; setEmployees(prevState); setHistoryIndex(prev => prev - 1); localStorage.setItem('orgData', JSON.stringify(prevState)); } };
            const updateStateFull = useCallback((newState, updates = [], deletes = []) => { pushToHistory(employees); setEmployees(newState); localStorage.setItem('orgData', JSON.stringify(newState)); if(updates.length > 0 || deletes.length > 0) syncUpdatesToCloud(updates, deletes); }, [employees, driveUrl, history, historyIndex]);

            // [FIX] Left/Right Reorder Logic
            const handleReorder = useCallback((id, offset) => {
                const target = employees.find(e => e.id === id);
                if (!target) return;
                // Get siblings sorted by order
                const siblings = employees.filter(e => e.reportsTo === target.reportsTo).sort((a, b) => (a.order || 0) - (b.order || 0));
                const currentIndex = siblings.findIndex(e => e.id === id);
                if (currentIndex === -1) return;
                
                let newIndex = currentIndex + offset;
                if (newIndex < 0) newIndex = 0;
                if (newIndex >= siblings.length) newIndex = siblings.length - 1;
                if (newIndex === currentIndex) return;

                const siblingToSwap = siblings[newIndex];
                const targetOrder = target.order || 0;
                const siblingOrder = siblingToSwap.order || 0;

                // Swap orders
                const updates = [ { ...target, order: siblingOrder }, { ...siblingToSwap, order: targetOrder } ];
                const newData = employees.map(e => { const up = updates.find(u => u.id === e.id); return up ? up : e; });
                updateStateFull(newData, updates, []);
            }, [employees, updateStateFull]);

            // [AUTH] Filter Logic: Only show subordinates of current user's dept
            const validEmployees = employees.filter(e => e.id);
            const isAuthorized = (emp) => {
                if (currentUser.role === 'admin') return true;
                if (currentUser.dept === 'ALL') return true;
                return emp.dept === currentUser.dept;
            };

            const handleSave = useCallback((data) => { let updates = [data]; let newData = employees.find(e => e.id === data.id) ? employees.map(e => e.id === data.id ? data : e) : [...employees, data]; updateStateFull(newData, updates, []); setIsModalOpen(false); }, [employees, updateStateFull]);
            const handleDelete = useCallback((id) => { const newData = employees.filter(e => e.id !== id); updateStateFull(newData, [], [id]); setIsModalOpen(false); }, [employees, updateStateFull]);
            const handleTransferToDept = (targetDept) => { if(selectedIds.length === 0) return; const updates = []; const newData = employees.map(e => { if (selectedIds.includes(e.id)) { const u = { ...e, dept: targetDept, reportsTo: 'STAGING' }; updates.push(u); return u; } return e; }); updateStateFull(newData, updates, []); setSelectedIds([]); setSelectionMode(false); };

            if (!currentUser) return <LoginScreen onLogin={(u)=>{setCurrentUser(u); localStorage.setItem('currentUser', JSON.stringify(u));}} driveUrl={driveUrl} apiCall={appApiCall} />;
            if (!currentDept) return <LandingPage departments={departments} user={currentUser} onSelectDept={setCurrentDept} />;

            const filteredAll = validEmployees.filter(e => e.reportsTo !== 'STAGING' && (currentDept === 'ALL' || e.dept === currentDept));
            const stagingEmployees = validEmployees.filter(e => e.reportsTo === 'STAGING' && (currentDept === 'ALL' || e.dept === currentDept) && (!searchTerm || e.name.toLowerCase().includes(searchTerm.toLowerCase())));
            const rootEmployees = filteredAll.filter(e => { const boss = filteredAll.find(b => b.id === e.reportsTo); return !boss; });
            const isLocked = currentUser.role !== 'admin' && currentUser.role !== 'supervisor';
            const canEdit = (emp) => !isLocked && isAuthorized(emp);

            return (
                <div className="flex flex-col h-full bg-gray-50">
                    <nav className="bg-white shadow-sm border-b sticky top-0 z-40 h-14 flex items-center px-4 justify-between shrink-0">
                        <div className="flex items-center gap-4">
                            <button onClick={()=>setIsMobileMenuOpen(true)} className="lg:hidden p-2 text-gray-600"><Icons.Menu/></button>
                            <button onClick={()=>setCurrentDept(null)} className="flex items-center gap-2 font-bold text-gray-700 hover:text-blue-600"><Icons.Home/> <span className="hidden sm:inline">Home</span></button>
                            <div className="h-6 w-px bg-gray-300"></div>
                            <span className="font-bold text-blue-600">{currentDept} DEPT</span>
                            {!isLocked && <button onClick={()=>setIsManageDeptsOpen(true)} className="p-1 text-gray-400 hover:text-blue-600"><Icons.Settings size={14}/></button>}
                        </div>
                        <div className="hidden lg:flex items-center gap-3">
                            <div className="hidden sm:flex items-center bg-gray-100 rounded-full px-3 py-1"><Icons.Search size={14} className="text-gray-400"/><input value={searchTerm} onChange={e=>setSearchTerm(e.target.value)} placeholder="Search..." className="bg-transparent border-none text-xs ml-2 w-24 outline-none"/></div>
                            <div className="flex bg-gray-100 rounded-lg p-1 gap-1">
                                <button onClick={()=>setViewMode('chart')} className={`p-1 rounded ${viewMode==='chart'?'bg-white shadow-sm text-blue-600':'text-gray-500'}`}><Icons.Grid size={16}/></button>
                                <button onClick={()=>setViewMode('list')} className={`p-1 rounded ${viewMode==='list'?'bg-white shadow-sm text-blue-600':'text-gray-500'}`}><Icons.List size={16}/></button>
                            </div>
                            {!isLocked && <button onClick={()=>{setSelectionMode(!selectionMode); setSelectedIds([]);}} className={`p-1.5 rounded border ${selectionMode?'bg-purple-600 text-white':'text-gray-600'}`}><Icons.CheckSquare size={18}/></button>}
                            <button onClick={()=>setIsSummaryOpen(true)} className="p-2 text-blue-600"><Icons.Chart size={20}/></button>
                            {/* [RESTORED] Export Excel */}
                            <button onClick={()=>exportToExcel(employees)} className="p-2 text-green-600 hover:bg-green-50 rounded-full" title="Export Excel"><Icons.FileSpreadsheet size={20}/></button>
                            {currentUser.role === 'admin' && <button onClick={()=>setIsAdminPanelOpen(true)} className="p-2 text-gray-600 hover:bg-gray-100 rounded-full"><Icons.Settings size={20}/></button>}
                            <button onClick={()=>{localStorage.removeItem('currentUser'); setCurrentUser(null); setCurrentDept(null);}} className="text-red-500 p-2"><Icons.LogOut size={20}/></button>
                        </div>
                    </nav>

                    {isMobileMenuOpen && ( <div className="fixed inset-0 z-[110] lg:hidden"> <div className="absolute inset-0 bg-black/50" onClick={()=>setIsMobileMenuOpen(false)}></div> <div className="absolute left-0 top-0 h-full w-64 bg-white shadow-xl flex flex-col p-4 animate-in slide-in-from-left duration-200"> <div className="flex justify-between items-center mb-6 border-b pb-2"><span className="font-bold">เมนูจัดการ</span><button onClick={()=>setIsMobileMenuOpen(false)}><Icons.X/></button></div> <div className="flex flex-col gap-4 overflow-y-auto"> <button onClick={()=>{setCurrentDept(null); setIsMobileMenuOpen(false);}} className="flex items-center gap-3 p-2 hover:bg-gray-100 rounded"><Icons.Home/> หน้าหลัก</button> <button onClick={()=>{exportToExcel(employees); setIsMobileMenuOpen(false);}} className="flex items-center gap-3 p-2 hover:bg-gray-100 rounded"><Icons.FileSpreadsheet/> Export Excel</button> <button onClick={()=>{localStorage.removeItem('currentUser'); setCurrentUser(null);}} className="flex items-center gap-3 p-2 text-red-600 hover:bg-red-50 mt-auto border-t"><Icons.LogOut/> ออกจากระบบ</button> </div> </div> </div> )}

                    <div className="flex flex-1 overflow-hidden relative">
                        {viewMode === 'chart' && (
                            <>
                            <aside className={`fixed inset-y-0 left-0 z-40 bg-white border-r transform transition-transform duration-300 pt-14 lg:pt-0 ${isSidebarOpen?'translate-x-0':'-translate-x-full'} ${isSidebarCollapsed?'w-0 overflow-hidden':''} lg:relative lg:translate-x-0`} style={{ width: isSidebarCollapsed?'0px':(window.innerWidth>1024?`${sidebarWidth}px`:'16rem') }}>
                                <div className="p-4 flex justify-between items-center shrink-0">
                                    <h2 className="font-bold text-xs text-gray-400 uppercase">Waiting Area ({stagingEmployees.length})</h2>
                                    {!isLocked && <button onClick={()=>{setEditingEmployee({isNew:true, reportsTo:'STAGING', dept: currentDept}); setIsModalOpen(true);}}><Icons.Plus size={18} className="text-blue-600"/></button>}
                                    <button onClick={()=>setIsSidebarOpen(false)} className="lg:hidden text-gray-400 hover:text-red-500"><Icons.X size={18}/></button>
                                </div>
                                <div className="flex-1 overflow-y-auto px-4 space-y-3 pb-20">
                                    {stagingEmployees.map(emp => <EmployeeCard key={emp.id} employee={emp} onClick={()=> {setEditingEmployee({...emp, isNew:false}); setIsModalOpen(true);}} onDragStart={(e,id)=>e.dataTransfer.setData("empIds", JSON.stringify([id]))} isStaging={true} isLocked={!canEdit(emp)} selectionMode={selectionMode} isSelected={selectedIds.includes(emp.id)} toggleSelection={(id)=>setSelectedIds(prev=>prev.includes(id)?prev.filter(x=>x!==id):[...prev, id])}/>)}
                                </div>
                                <div className="sidebar-resizer hidden lg:block" onMouseDown={()=>isResizing.current=true}></div>
                                <button className="sidebar-toggle-btn hidden lg:flex" style={{right: '-12px', borderRadius: '50%'}} onClick={()=>setIsSidebarCollapsed(true)}><Icons.ChevronLeft size={14}/></button>
                            </aside>
                            {isSidebarCollapsed && <button className="sidebar-toggle-btn hidden lg:flex" style={{left: '0', borderTopRightRadius: '8px', borderBottomRightRadius: '8px'}} onClick={()=>setIsSidebarCollapsed(false)}><Icons.ChevronRight size={18}/></button>}
                            </>
                        )}

                        <main className="flex-1 bg-gray-100 overflow-auto relative p-8">
                            {viewMode === 'chart' ? (
                                <div className="flex flex-col items-center min-w-max" style={{ transform: `scale(${zoom})`, transformOrigin: 'top center' }}>
                                    <DraggableLogo logo={logo} setLogo={setLogo} isLocked={isLocked} />
                                    <div id="org-chart-full-view" className="bg-white p-8 rounded-2xl border shadow-xl inline-block min-w-[800px] org-chart-container relative">
                                        <div className="mb-8 border-b-2 pb-2"><h1 className="text-3xl font-bold text-gray-800 uppercase">{currentDept} DEPT</h1></div>
                                        <div className="flex gap-16 justify-center">
                                            {rootEmployees.map(root => <EmployeeNode key={root.id} employee={root} allEmployees={filteredAll} onEdit={(e)=>{setEditingEmployee({...e, isNew:false}); setIsModalOpen(true);}} onDrop={(ids, targetId)=>{ const updates = []; const newData = employees.map(e => { if(ids.includes(e.id)) { const u = {...e, reportsTo: targetId}; updates.push(u); return u; } return e; }); updateStateFull(newData, updates, []); }} isLocked={!canEdit(root)} selectionMode={selectionMode} selectedIds={selectedIds} toggleSelection={(id)=>setSelectedIds(prev=>prev.includes(id)?prev.filter(x=>x!==id):[...prev, id])} onAddChild={(p)=>{setEditingEmployee({isNew:true, reportsTo:p.id, dept:p.dept}); setIsModalOpen(true);}} layoutThreshold={4} searchTerm={searchTerm} onReorder={handleReorder}/>)}
                                        </div>
                                    </div>
                                </div>
                            ) : (
                                <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
                                    <table className="min-w-full divide-y">
                                        <thead className="bg-gray-50"><tr><th className="px-4 py-3 text-left text-xs font-bold text-gray-500">Employee</th><th className="px-4 py-3 text-left text-xs font-bold text-gray-500">Dept</th><th className="px-4 py-3 text-left text-xs font-bold text-gray-500">Position</th></tr></thead>
                                        <tbody className="divide-y">{validEmployees.filter(e => currentDept === 'ALL' || e.dept === currentDept).map(emp => <tr key={emp.id} className="hover:bg-gray-50 cursor-pointer" onClick={()=>{setEditingEmployee({...emp, isNew:false}); setIsModalOpen(true);}}><td className="px-4 py-3 text-sm font-medium">{emp.name}</td><td className="px-4 py-3 text-sm text-gray-500">{emp.dept}</td><td className="px-4 py-3 text-sm text-gray-500">{emp.position}</td></tr>)}</tbody>
                                    </table>
                                </div>
                            )}

                            {selectionMode && selectedIds.length > 0 && (
                                <div className="batch-actions">
                                    <span className="text-sm font-bold text-gray-600">{selectedIds.length} Selected</span>
                                    <div className="h-6 w-px bg-gray-200 mx-2"></div>
                                    <span className="text-xs text-gray-400 mr-2">Transfer To:</span>
                                    {departments.map(d => <button key={d} onClick={()=>handleTransferToDept(d)} className="px-2 py-1 text-xs bg-blue-50 text-blue-600 rounded hover:bg-blue-100">{d}</button>)}
                                    <button onClick={()=>{if(confirm('Delete?')) updateStateFull(employees.filter(e=>!selectedIds.includes(e.id)), [], selectedIds); setSelectedIds([]);}} className="p-2 text-red-600 ml-4"><Icons.Trash2 size={16}/></button>
                                </div>
                            )}

                            {viewMode === 'chart' && (
                                <>
                                    <div className="zoom-controls"><button onClick={()=>setZoom(z=>Math.max(0.3,z-0.1))}><Icons.ZoomOut/></button><span className="text-xs font-mono">{Math.round(zoom*100)}%</span><button onClick={()=>setZoom(z=>Math.min(1.5,z+0.1))}><Icons.ZoomIn/></button></div>
                                    {!isLocked && historyIndex > 0 && <div className="undo-controls"><button onClick={handleUndo} className="bg-white text-gray-700 p-3 rounded-full shadow-lg border hover:bg-gray-50 flex items-center gap-2 group undo-btn" title="Undo Last Action"><Icons.RotateCcw size={20}/></button></div>}
                                </>
                            )}
                        </main>
                    </div>

                    {isModalOpen && <EmployeeForm employee={editingEmployee} supervisors={validEmployees} positions={positions} depts={departments} onSave={handleSave} onCancel={()=>setIsModalOpen(false)} onDelete={handleDelete} role={currentUser.role} driveUrl={driveUrl} />}
                    {isAdminPanelOpen && <AdminPanel onClose={()=>setIsAdminPanelOpen(false)} driveUrl={driveUrl} setDriveUrl={setDriveUrl} apiCall={appApiCall} depts={departments} />}
                    {isManageDeptsOpen && <ManageDeptsModal depts={departments} onAdd={(d)=>{const nd = [...departments, d]; setDepartments(nd); localStorage.setItem('orgDepartments', JSON.stringify(nd)); if(driveUrl) appApiCall(driveUrl, 'saveData', {orgDepartments: nd});}} onDelete={(d)=>{const nd = departments.filter(x=>x!==d); setDepartments(nd); localStorage.setItem('orgDepartments', JSON.stringify(nd));}} onClose={()=>setIsManageDeptsOpen(false)} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
