<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ระบบจัดผังองค์กรอัตโนมัติ (HR Auto Organize)</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Sarabun', sans-serif; touch-action: manipulation; }
        ::-webkit-scrollbar { height: 8px; width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .spinner { animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @media print {
            @page { size: landscape; margin: 5mm; }
            body { background: white; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            nav, .no-print, .tools-panel, .sidebar-overlay, .zoom-controls, .debug-console { display: none !important; }
            main { padding: 0; margin: 0; width: 100%; overflow: visible !important; }
            .org-container { border: none !important; box-shadow: none !important; transform: none !important; }
        }

        .draggable-source { cursor: grab; }
        .draggable-source:active { cursor: grabbing; }
        .drop-target-hover { background-color: #dbeafe !important; border-color: #2563eb !important; transform: scale(1.05); }
        .sidebar-resizer { width: 5px; cursor: col-resize; background: transparent; position: absolute; right: 0; top: 0; bottom: 0; z-index: 50; }
        .sidebar-resizer:hover { background: #3b82f6; }
        
        .ruler-tick { position: absolute; background-color: #94a3b8; }
        .ruler-label { position: absolute; font-size: 8px; color: #64748b; pointer-events: none; }
        .paper-marker { position: absolute; border-left: 1px dashed #ef4444; height: 100%; top: 0; pointer-events: none; z-index: 5; }
        .paper-marker-label { position: absolute; top: 2px; left: 4px; font-size: 10px; color: #ef4444; font-weight: bold; background: rgba(255,255,255,0.8); }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 h-screen overflow-hidden">
    <div id="root" class="h-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;
        const { jsPDF } = window.jspdf;

        // --- ICONS ---
        const IconBase = ({ children, size = 18, className = "" }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>);
        const Icons = {
            Camera: (p) => <IconBase {...p}><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></IconBase>,
            Plus: (p) => <IconBase {...p}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></IconBase>,
            Trash2: (p) => <IconBase {...p}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></IconBase>,
            Download: (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></IconBase>,
            Users: (p) => <IconBase {...p}><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></IconBase>,
            X: (p) => <IconBase {...p}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></IconBase>,
            Check: (p) => <IconBase {...p}><polyline points="20 6 9 17 4 12"/></IconBase>,
            Settings: (p) => <IconBase {...p}><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></IconBase>,
            Move: (p) => <IconBase {...p}><polyline points="5 9 2 12 5 15"/><polyline points="9 5 12 2 15 5"/><polyline points="19 9 22 12 19 15"/><polyline points="9 19 12 22 15 19"/><line x1="2" y1="12" x2="22" y2="12"/><line x1="12" y1="2" x2="12" y2="22"/></IconBase>,
            Menu: (p) => <IconBase {...p}><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></IconBase>,
            List: (p) => <IconBase {...p}><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/></IconBase>,
            Grid: (p) => <IconBase {...p}><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></IconBase>,
            ChevronLeft: (p) => <IconBase {...p}><polyline points="15 18 9 12 15 6"/></IconBase>,
            ChevronRight: (p) => <IconBase {...p}><polyline points="9 18 15 12 9 6"/></IconBase>,
            Ruler: (p) => <IconBase {...p}><path d="M21.3 15.3a2.4 2.4 0 0 1 0 3.4l-2.6 2.6a2.4 2.4 0 0 1-3.4 0L2.7 8.7a2.4 2.4 0 0 1 0-3.4l2.6-2.6a2.4 2.4 0 0 1 3.4 0Z"/><line x1="14.5" y1="3.2" x2="18.8" y2="7.5"/></IconBase>,
            Edit: (p) => <IconBase {...p}><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></IconBase>,
            Lock: (p) => <IconBase {...p}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></IconBase>,
            Unlock: (p) => <IconBase {...p}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></IconBase>,
            ZoomIn: (p) => <IconBase {...p}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="11" y1="8" x2="11" y2="14"/><line x1="8" y1="11" x2="14" y2="11"/></IconBase>,
            ZoomOut: (p) => <IconBase {...p}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="8" y1="11" x2="14" y2="11"/></IconBase>,
            LogOut: (p) => <IconBase {...p}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></IconBase>,
            Cloud: (p) => <IconBase {...p}><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></IconBase>,
            Loader: (p) => <IconBase {...p} className={`spinner ${p.className}`}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></IconBase>,
            Alert: (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></IconBase>,
            Terminal: (p) => <IconBase {...p}><polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/></IconBase>
        };

        // --- COMPONENTS ---
        const Button = ({ children, onClick, variant = 'primary', className = '', icon: Icon, disabled, title }) => {
            const baseStyle = "flex items-center justify-center px-3 py-2 sm:px-4 sm:py-2 rounded-lg font-medium transition-all duration-200 active:scale-95 shadow-sm disabled:opacity-50 disabled:cursor-not-allowed text-sm sm:text-base whitespace-nowrap";
            const variants = {
                primary: "bg-blue-600 text-white hover:bg-blue-700",
                secondary: "bg-white text-gray-700 border border-gray-200 hover:bg-gray-50",
                danger: "bg-red-50 text-red-600 hover:bg-red-100 border border-red-100",
                ghost: "bg-transparent text-gray-500 hover:bg-gray-100 shadow-none border-0"
            };
            return (
                <button type="button" onClick={onClick} disabled={disabled} className={`${baseStyle} ${variants[variant]} ${className}`} title={title}>
                    {Icon && <Icon size={18} className="mr-2" />}
                    {children}
                </button>
            );
        };

        const DebugConsole = ({ logs, onClose, onClear }) => {
            const endRef = useRef(null);
            useEffect(() => endRef.current?.scrollIntoView({ behavior: "smooth" }), [logs]);
            return (
                <div className="debug-console fixed bottom-0 left-0 right-0 h-48 bg-gray-900 text-green-400 font-mono text-xs z-50 flex flex-col border-t-2 border-gray-700 shadow-xl">
                    <div className="flex justify-between items-center px-4 py-2 bg-gray-800 border-b border-gray-700 text-white">
                        <span className="flex items-center gap-2"><Icons.Terminal size={14}/> System Log</span>
                        <div className="flex gap-2">
                            <button onClick={onClear} className="bg-gray-700 px-2 py-0.5 rounded hover:bg-gray-600">Clear</button>
                            <button onClick={onClose}><Icons.X size={16}/></button>
                        </div>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 space-y-1">
                        {logs.length === 0 && <span className="text-gray-500">No logs...</span>}
                        {logs.map((log, i) => (
                            <div key={i} className={`border-b border-gray-800 pb-1 ${log.type === 'error' ? 'text-red-400' : log.type === 'info' ? 'text-blue-300' : ''}`}>
                                <span className="text-gray-500 mr-2">[{log.time}]</span>{log.msg}
                                {log.data && <div className="pl-4 text-gray-500 truncate">{JSON.stringify(log.data)}</div>}
                            </div>
                        ))}
                        <div ref={endRef}></div>
                    </div>
                </div>
            );
        };

        const Ruler = ({ orientation = 'horizontal', length = 2000 }) => {
            const pxPerMm = 3.7795;
            const paperSizes = [{ name: 'A4', w: 297 * pxPerMm, h: 210 * pxPerMm }, { name: 'A3', w: 420 * pxPerMm, h: 297 * pxPerMm }];
            const ticks = [];
            for (let i = 0; i <= length / pxPerMm; i += 10) {
                const pos = i * pxPerMm;
                ticks.push(<div key={i} className="ruler-tick" style={orientation==='horizontal'?{left:`${pos}px`,height:'6px',width:'1px',bottom:0}:{top:`${pos}px`,width:'6px',height:'1px',right:0}}><span className="ruler-label" style={orientation==='horizontal'?{left:'2px',bottom:'8px'}:{top:'2px',right:'8px'}}>{i}</span></div>);
            }
            return (
                <div className={`absolute bg-gray-50 border-gray-300 z-10 opacity-80 pointer-events-none ${orientation==='horizontal'?'h-8 border-b w-full top-0 left-8':'w-8 border-r h-full left-0 top-8'}`}>
                    {ticks}
                    {orientation === 'horizontal' && paperSizes.map(s => <div key={s.name} className="paper-marker" style={{left:`${s.w}px`}}><span className="paper-marker-label">{s.name}</span></div>)}
                </div>
            );
        };

        // --- ORG CHART COMPONENTS ---
        const EmployeeCard = ({ employee, onClick, onDragStart, onMoveInit, className = "", isStaging = false, isSelected = false, isLocked = false, isViewOnly = false }) => {
            const isSubcontract = employee.type === 'Subcontract';
            return (
                <div 
                    draggable={!isLocked && !isViewOnly}
                    onDragStart={(e) => !isLocked && !isViewOnly && onDragStart && onDragStart(e, employee.id)}
                    className={`relative flex flex-col items-center p-3 rounded-xl border-b-4 shadow-sm w-36 sm:w-40 transition-transform duration-200 cursor-pointer bg-white ${className} ${isSelected ? 'ring-4 ring-blue-400 scale-105 z-20' : 'hover:scale-105'} ${isLocked || isViewOnly ? 'cursor-default' : 'draggable-source'}`}
                    onClick={(e) => { e.stopPropagation(); if(!isViewOnly || isLocked) onClick(employee); }} 
                >
                    <div className={`absolute top-2 left-2 px-1.5 py-0.5 rounded text-[10px] font-bold text-white ${isSubcontract ? 'bg-orange-500' : 'bg-blue-600'}`}>{isSubcontract ? 'S' : 'P'}</div>
                    <div className="relative">
                        <img src={employee.image || "https://via.placeholder.com/100?text=No+Img"} alt={employee.name} className="w-14 h-14 sm:w-16 sm:h-16 rounded-full object-cover border-2 border-white shadow-sm bg-gray-200 pointer-events-none"/>
                        <div className="absolute -bottom-1 -right-1 bg-white rounded-full p-1 shadow"><div className={`w-3 h-3 rounded-full ${employee.status === 'Active' ? 'bg-green-500' : 'bg-red-500'}`}></div></div>
                    </div>
                    <div className="mt-2 text-center w-full">
                        <p className="text-[10px] sm:text-xs font-bold text-gray-500">{employee.id}</p>
                        <h3 className="text-xs sm:text-sm font-bold text-gray-800 leading-tight truncate w-full">{employee.name}</h3>
                        <p className="text-[10px] sm:text-xs text-gray-600 truncate w-full">{employee.position}</p>
                        {isSubcontract && <p className="text-[9px] text-orange-600 truncate mt-0.5">({employee.company})</p>}
                    </div>
                    {isStaging && !isLocked && !isViewOnly && (
                        <button onClick={(e) => { e.stopPropagation(); onMoveInit(employee); }} className={`absolute top-1 right-1 p-1.5 rounded-full ${isSelected ? 'bg-blue-600 text-white' : 'text-gray-400 hover:text-blue-600 hover:bg-blue-50'}`}><Icons.Move size={14} /></button>
                    )}
                </div>
            );
        };

        const EmployeeNode = ({ employee, allEmployees, onEdit, onDelete, onAddSubordinate, onDrop, onMoveSelect, moveTargetId, isLocked, isViewOnly, level = 0 }) => {
            const [isDragOver, setIsDragOver] = useState(false);
            if (!employee) return null;
            const subordinates = allEmployees.filter(e => e.reportsTo === employee.id);
            const levelColors = ["border-blue-500 bg-blue-50", "border-indigo-500 bg-indigo-50", "border-green-500 bg-green-50", "border-gray-300 bg-white"];
            const cardColor = level < 3 ? levelColors[level] : levelColors[3];

            const handleDropInternal = (e) => {
                if(isLocked || isViewOnly) return;
                e.preventDefault(); setIsDragOver(false);
                const draggedId = e.dataTransfer.getData("empId");
                if (draggedId && draggedId !== employee.id) onDrop(draggedId, employee.id);
            };

            return (
                <div className="flex flex-col items-center">
                    {level > 0 && <div className="h-4 sm:h-6 w-px bg-gray-300"></div>}
                    <div 
                        onDragOver={(e) => { if(!isLocked) { e.preventDefault(); setIsDragOver(true); }}} 
                        onDragLeave={() => setIsDragOver(false)} 
                        onDrop={handleDropInternal}
                        onClick={() => moveTargetId && !isLocked && !isViewOnly && onMoveSelect(employee.id)}
                        className={`relative z-10 group transition-all duration-200 ${isDragOver ? 'drop-target-hover scale-110' : ''} ${moveTargetId ? 'cursor-crosshair' : ''}`}
                    >
                        {moveTargetId && !isLocked && (
                            <div className="absolute -inset-2 border-2 border-dashed border-blue-400 rounded-2xl bg-blue-50/50 z-20 flex items-center justify-center animate-pulse pointer-events-none"><span className="bg-blue-600 text-white text-[10px] px-2 py-0.5 rounded-full">เลือกหัวหน้า</span></div>
                        )}
                        <EmployeeCard employee={employee} onClick={onEdit} onDragStart={(e, id) => e.dataTransfer.setData("empId", id)} className={cardColor} isLocked={isLocked} isViewOnly={isViewOnly} />
                        {!moveTargetId && !isLocked && !isViewOnly && (
                            <button onClick={(e) => { e.stopPropagation(); onAddSubordinate(employee.id); }} className="absolute -bottom-3 left-1/2 transform -translate-x-1/2 bg-white text-blue-600 hover:bg-blue-600 hover:text-white border border-blue-200 rounded-full w-6 h-6 flex items-center justify-center shadow-md z-20"><Icons.Plus size={14} /></button>
                        )}
                    </div>
                    {subordinates.length > 0 && (
                        <>
                            <div className="h-4 sm:h-6 w-px bg-gray-300"></div>
                            <div className="flex relative">
                                {subordinates.length > 1 && <div className="absolute top-0 left-0 right-0 h-px bg-gray-300 mx-[calc(50%/2)] transform -translate-y-px"></div>}
                                <div className="flex gap-4 sm:gap-6 pt-0">
                                    {subordinates.map((sub, index) => (
                                        <div key={sub.id} className="relative flex flex-col items-center">
                                            {subordinates.length > 1 && <div className={`absolute top-0 h-px bg-gray-300 ${index === 0 ? 'w-1/2 right-0' : ''} ${index === subordinates.length - 1 ? 'w-1/2 left-0' : ''} ${index > 0 && index < subordinates.length - 1 ? 'w-full' : ''}`}></div>}
                                            <EmployeeNode employee={sub} allEmployees={allEmployees} onEdit={onEdit} onDelete={onDelete} onAddSubordinate={onAddSubordinate} onDrop={onDrop} onMoveSelect={onMoveSelect} moveTargetId={moveTargetId} level={level + 1} isLocked={isLocked} isViewOnly={isViewOnly} />
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </>
                    )}
                </div>
            );
        };

        // --- AUTH & ADMIN ---
        const LoginScreen = ({ onLogin, driveUrl, apiCall }) => {
            const [user, setUser] = useState('');
            const [pass, setPass] = useState('');
            const [error, setError] = useState('');
            const [isLoading, setIsLoading] = useState(false);

            const handleLogin = async (e) => {
                e.preventDefault(); setIsLoading(true); setError('');
                if (driveUrl) {
                    try {
                        const res = await apiCall(driveUrl, 'login', { username: user, password: pass });
                        if (res?.status === 'success') return onLogin(res.user);
                        setError('Cloud Login Failed: ' + (res?.message || 'Unknown'));
                    } catch (err) { setError('Cloud Failed, trying local...'); }
                }
                const users = JSON.parse(localStorage.getItem('users')) || [{ username: 'admin', password: 'password', role: 'admin', name: 'Admin User' }];
                const valid = users.find(u => u.username === user && u.password === pass);
                if (valid) { if(driveUrl) setError('Offline Mode'); onLogin(valid); }
                else { if(!error) setError('Invalid credentials'); }
                setIsLoading(false);
            };

            return (
                <div className="fixed inset-0 bg-gray-100 flex items-center justify-center z-50">
                    <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm">
                        <div className="flex flex-col items-center mb-6">
                            <div className="bg-red-600 p-3 rounded-lg text-white font-bold text-2xl mb-2">HR</div>
                            <h2 className="text-xl font-bold">เข้าสู่ระบบ</h2>
                        </div>
                        <form onSubmit={handleLogin} className="space-y-4">
                            <input type="text" value={user} onChange={e => setUser(e.target.value)} placeholder="Username" className="w-full p-2 border rounded-lg" required />
                            <input type="password" value={pass} onChange={e => setPass(e.target.value)} placeholder="Password" className="w-full p-2 border rounded-lg" required />
                            {error && <p className="text-red-500 text-xs text-center">{error}</p>}
                            <button type="submit" disabled={isLoading} className="w-full bg-red-600 text-white py-2 rounded-lg font-bold flex justify-center">{isLoading ? <Icons.Loader /> : "Login"}</button>
                        </form>
                        <p className="mt-4 text-xs text-center text-gray-400">Default: admin / password</p>
                    </div>
                </div>
            );
        };

        const AdminPanel = ({ onClose, driveUrl, setDriveUrl, apiCall }) => {
            const [users, setUsers] = useState([]);
            const [newUser, setNewUser] = useState({ username: '', password: '', role: 'leader', name: '' });
            
            useEffect(() => {
                const load = async () => {
                    let loaded = [];
                    if(driveUrl) { try { const res = await apiCall(driveUrl, 'getUsers'); if(res?.status === 'success') loaded = res.users; } catch(e){} }
                    if(loaded.length === 0) loaded = JSON.parse(localStorage.getItem('users')) || [{ username: 'admin', password: 'password', role: 'admin', name: 'Admin User' }];
                    setUsers(loaded);
                };
                load();
            }, [driveUrl]);

            const saveUserAction = async () => {
                if(!newUser.username) return;
                const updated = [...users.filter(u => u.username !== newUser.username), newUser];
                setUsers(updated); localStorage.setItem('users', JSON.stringify(updated));
                if(driveUrl) await apiCall(driveUrl, 'saveUser', { user: newUser });
                setNewUser({ username: '', password: '', role: 'leader', name: '' });
            };

            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[70]">
                    <div className="bg-white w-full max-w-3xl rounded-2xl shadow-xl flex flex-col max-h-[90vh]">
                        <div className="p-6 border-b flex justify-between items-center"><h2 className="text-xl font-bold">Admin Panel</h2><button onClick={onClose}><Icons.X/></button></div>
                        <div className="p-6 overflow-y-auto space-y-6">
                            <div className="bg-blue-50 p-4 rounded-lg border border-blue-100">
                                <h3 className="font-bold text-blue-800 mb-2 flex items-center"><Icons.Cloud className="mr-2"/> Google Apps Script URL</h3>
                                <input type="text" value={driveUrl} onChange={(e) => setDriveUrl(e.target.value)} placeholder="https://script.google.com/macros/s/..." className="w-full p-2 border rounded text-sm"/>
                            </div>
                            <div>
                                <h3 className="font-bold mb-4">Manage Users</h3>
                                <div className="flex gap-2 mb-4 items-end bg-gray-50 p-3 rounded flex-wrap">
                                    <input placeholder="User" value={newUser.username} onChange={e => setNewUser({...newUser, username: e.target.value})} className="border p-2 rounded text-sm flex-1"/>
                                    <input placeholder="Pass" value={newUser.password} onChange={e => setNewUser({...newUser, password: e.target.value})} className="border p-2 rounded text-sm flex-1"/>
                                    <input placeholder="Name" value={newUser.name} onChange={e => setNewUser({...newUser, name: e.target.value})} className="border p-2 rounded text-sm flex-1"/>
                                    <select value={newUser.role} onChange={e => setNewUser({...newUser, role: e.target.value})} className="border p-2 rounded text-sm"><option value="admin">Admin</option><option value="leader">Leader</option><option value="viewer">Viewer</option></select>
                                    <button onClick={saveUserAction} className="bg-green-600 text-white p-2 rounded"><Icons.Plus size={18}/></button>
                                </div>
                                <table className="w-full text-sm text-left">
                                    <thead className="bg-gray-100"><tr><th className="p-2">User</th><th className="p-2">Name</th><th className="p-2">Role</th></tr></thead>
                                    <tbody>{users.map((u, i) => <tr key={i} className="border-b"><td className="p-2">{u.username}</td><td className="p-2">{u.name}</td><td className="p-2">{u.role}</td></tr>)}</tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const EmployeeForm = ({ employee, supervisors, positions, onSave, onCancel, onDelete, role, driveUrl, onAddPosition, onDeletePosition }) => {
            const [formData, setFormData] = useState({ id: '', name: '', position: positions[0] || '', reportsTo: '', image: null, status: 'Active', type: 'Permanent', company: '' });
            const [isManagingPos, setIsManagingPos] = useState(false);
            const [newPosInput, setNewPosInput] = useState("");
            const [isUploading, setIsUploading] = useState(false);
            const isEditMode = employee && !employee.isNew;
            const canEdit = role === 'admin' || role === 'supervisor';

            useEffect(() => {
                if (isEditMode) setFormData({ type: 'Permanent', company: '', ...employee });
                else setFormData({ id: Math.floor(60000 + Math.random() * 9000).toString(), name: '', position: positions[0], reportsTo: employee?.reportsTo || '', image: null, status: 'Active', type: 'Permanent', company: '' });
            }, [employee]);

            const handleImage = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                if (driveUrl) {
                    setIsUploading(true);
                    const reader = new FileReader();
                    reader.onloadend = async () => {
                        try {
                            const payload = { 
                                action: 'upload', 
                                file: reader.result.split(',')[1], 
                                filename: `emp_${formData.id}.jpg`, 
                                mimetype: file.type,
                                oldFileUrl: formData.image 
                            };
                            const res = await fetch(driveUrl, { method: 'POST', headers: {"Content-Type": "text/plain;charset=utf-8"}, body: JSON.stringify(payload) });
                            const json = await res.json();
                            if (json.url) setFormData(p => ({ ...p, image: json.url }));
                        } catch (err) { alert("Upload Failed: " + err); } finally { setIsUploading(false); }
                    };
                    reader.readAsDataURL(file);
                } else {
                    const reader = new FileReader();
                    reader.onloadend = () => setFormData(p => ({ ...p, image: reader.result }));
                    reader.readAsDataURL(file);
                }
            };

            const handleSubmit = () => {
                let finalData = { ...formData };
                // Logic: Operator cannot manage Operator
                if (finalData.position.toLowerCase().includes('operator') && finalData.reportsTo) {
                    const supervisor = supervisors.find(s => s.id === finalData.reportsTo);
                    if (supervisor && supervisor.position.toLowerCase().includes('operator')) {
                        if (supervisor.reportsTo && supervisor.reportsTo !== 'STAGING') {
                            finalData.reportsTo = supervisor.reportsTo;
                            alert(`Auto-Adjust: ${finalData.name} จะขึ้นตรงกับหัวหน้าของ ${supervisor.name} แทน (Operator ไม่ควรคุม Operator)`);
                        }
                    }
                }
                onSave(finalData);
            };

            return (
                <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-[60] p-4">
                    <div className="bg-white w-full max-w-md rounded-2xl shadow-2xl flex flex-col max-h-[90vh]">
                        <div className="bg-gray-50 px-6 py-4 border-b flex justify-between"><h2 className="font-bold">{isEditMode ? 'Edit' : 'Add'} Employee</h2><button onClick={onCancel}><Icons.X/></button></div>
                        <div className="p-6 space-y-4 overflow-y-auto">
                            <div className="flex flex-col items-center mb-6">
                                <label className="w-24 h-24 rounded-full bg-gray-100 border-4 shadow flex items-center justify-center overflow-hidden cursor-pointer relative group">
                                    {isUploading ? <Icons.Loader/> : (formData.image ? <img src={formData.image} className="w-full h-full object-cover" /> : <Icons.Camera size={32} className="text-gray-400" />)}
                                    <input type="file" className="hidden" accept="image/*" onChange={handleImage} />
                                </label>
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div><label className="text-xs text-gray-500">ID</label><input value={formData.id} onChange={e => setFormData({...formData, id: e.target.value})} className="w-full border p-2 rounded" disabled={!canEdit && isEditMode}/></div>
                                <div><label className="text-xs text-gray-500">Status</label><select value={formData.status} onChange={e => setFormData({...formData, status: e.target.value})} className="w-full border p-2 rounded"><option value="Active">Active</option><option value="Resigned">Resigned</option></select></div>
                            </div>
                            <div><label className="text-xs text-gray-500">Name</label><input value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} className="w-full border p-2 rounded"/></div>
                            
                            {/* Position Manager */}
                            <div>
                                <div className="flex justify-between items-center mb-1">
                                    <label className="text-xs text-gray-500">Position</label>
                                    <button type="button" onClick={() => setIsManagingPos(!isManagingPos)} className="text-xs text-blue-600 flex items-center"><Icons.Settings size={12} className="mr-1"/>{isManagingPos ? "Done" : "Manage"}</button>
                                </div>
                                {isManagingPos ? (
                                    <div className="p-3 bg-gray-50 rounded-lg border space-y-2">
                                        <div className="flex gap-2">
                                            <input type="text" value={newPosInput} onChange={(e) => setNewPosInput(e.target.value)} placeholder="New Position..." className="flex-1 px-2 py-1.5 text-sm border rounded"/>
                                            <button type="button" onClick={() => { if(newPosInput.trim()) { onAddPosition(newPosInput); setNewPosInput(""); } }} className="bg-blue-600 text-white px-2 py-1 rounded text-xs">Add</button>
                                        </div>
                                        <div className="max-h-24 overflow-y-auto space-y-1">
                                            {positions.map(p => <div key={p} className="flex justify-between bg-white px-2 py-1 rounded border text-xs"><span>{p}</span><button type="button" onClick={() => onDeletePosition(p)} className="text-red-400"><Icons.X size={12} /></button></div>)}
                                        </div>
                                    </div>
                                ) : (
                                    <select value={formData.position} onChange={e => setFormData({...formData, position: e.target.value})} className="w-full border p-2 rounded">{positions.map(p=><option key={p} value={p}>{p}</option>)}</select>
                                )}
                            </div>

                            <div><label className="text-xs text-gray-500">Head</label><select value={formData.reportsTo} onChange={e => setFormData({...formData, reportsTo: e.target.value})} disabled={!canEdit && isEditMode} className="w-full border p-2 rounded"><option value="STAGING">-- Pending --</option><option value="">-- Top Level --</option>{supervisors.filter(s=>s.id!==formData.id).map(s=><option key={s.id} value={s.id}>{s.name}</option>)}</select></div>
                        </div>
                        <div className="bg-gray-50 px-6 py-4 border-t flex justify-between">
                            {isEditMode && canEdit ? <Button variant="danger" onClick={() => onDelete(formData.id)} icon={Icons.Trash2}>Del</Button> : <div></div>}
                            <div className="flex gap-2"><Button variant="secondary" onClick={onCancel}>Cancel</Button><Button onClick={handleSubmit} icon={Icons.Check}>Save</Button></div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        const App = () => {
            const [currentUser, setCurrentUser] = useState(() => JSON.parse(localStorage.getItem('currentUser')));
            const [employees, setEmployees] = useState(() => JSON.parse(localStorage.getItem('orgData')) || []);
            const [positions, setPositions] = useState(() => JSON.parse(localStorage.getItem('orgPositions')) || ["Manager", "Supervisor", "Leader", "Operator"]);
            const [driveUrl, setDriveUrl] = useState(() => localStorage.getItem('driveUrl') || "");
            const [deptName, setDeptName] = useState(() => localStorage.getItem('deptName') || "Assembly Dept");
            
            const [viewMode, setViewMode] = useState('chart');
            const [zoom, setZoom] = useState(1);
            const [cloudStatus, setCloudStatus] = useState('offline'); 
            const [debugLogs, setDebugLogs] = useState([]);
            const [showDebug, setShowDebug] = useState(false);
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);
            const [sidebarWidth, setSidebarWidth] = useState(256);
            
            const [modal, setModal] = useState({ open: false, data: null });
            const [adminOpen, setAdminOpen] = useState(false);
            const [moveSource, setMoveSource] = useState(null);

            const addLog = (msg, data = null, type = 'info') => {
                setDebugLogs(prev => [...prev.slice(-49), { time: new Date().toLocaleTimeString(), msg, data, type }]);
            };

            // *** FIXED API CALL (CORS BYPASS) ***
            const appApiCall = async (url, action, payload) => {
                addLog(`Request: ${action}`, payload);
                if (!url) return null;
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { "Content-Type": "text/plain;charset=utf-8" }, // Key Fix!
                        body: JSON.stringify({ action, ...payload })
                    });
                    const resJson = await response.json();
                    addLog(`Response: ${action}`, resJson, resJson.status === 'error' ? 'error' : 'info');
                    return resJson;
                } catch (error) {
                    addLog(`Network Error: ${action}`, error.toString(), 'error');
                    throw error;
                }
            };

            useEffect(() => {
                localStorage.setItem('orgData', JSON.stringify(employees));
                localStorage.setItem('orgPositions', JSON.stringify(positions)); // Save Positions
                if (driveUrl && currentUser) {
                    setCloudStatus('syncing');
                    const timer = setTimeout(() => setCloudStatus(s => s==='syncing'?'error':s), 15000);
                    appApiCall(driveUrl, 'saveData', { orgData: employees, orgPositions: positions })
                        .then(res => setCloudStatus(res?.status === 'success' ? 'online' : 'error'))
                        .catch(() => setCloudStatus('error'))
                        .finally(() => clearTimeout(timer));
                }
            }, [employees, positions]);

            useEffect(() => {
                if (driveUrl && currentUser) {
                    appApiCall(driveUrl, 'getData').then(res => {
                        if (res?.status === 'success' && res.data) {
                            if (res.data.orgData) setEmployees(res.data.orgData);
                            if (res.data.orgPositions) setPositions(res.data.orgPositions);
                            setCloudStatus('online');
                        }
                    });
                }
            }, [driveUrl, currentUser]);

            const handleSaveEmp = (data) => {
                setEmployees(prev => {
                    const exists = prev.find(e => e.id === data.id);
                    return exists ? prev.map(e => e.id === data.id ? data : e) : [...prev, data];
                });
                setModal({ open: false, data: null });
            };
            const handleDeleteEmp = (id) => { setEmployees(prev => prev.filter(e => e.id !== id)); setModal({ open: false, data: null }); };
            const handleDrop = (srcId, targetId) => setEmployees(prev => prev.map(e => e.id === srcId ? { ...e, reportsTo: targetId } : e));
            const handleAddPosition = (pos) => { if (!positions.includes(pos)) setPositions([...positions, pos]); };
            const handleDeletePosition = (pos) => { setPositions(positions.filter(p => p !== pos)); };

            const handleExport = async () => {
                const el = document.getElementById('org-chart-full-view');
                if(!el) return;
                const oldZoom = zoom; setZoom(1); await new Promise(r => setTimeout(r, 200));
                try {
                    const canvas = await html2canvas(el, { scale: 2, useCORS: true });
                    const pdf = new jsPDF('l', 'mm', 'a4');
                    const props = pdf.getImageProperties(canvas.toDataURL('image/jpeg'));
                    const w = pdf.internal.pageSize.getWidth() - 20;
                    const h = (props.height * w) / props.width;
                    pdf.addImage(props.data, 'JPEG', 10, 10, w, h);
                    pdf.save('org-chart.pdf');
                } catch(e) { alert("Export Error"); } finally { setZoom(oldZoom); }
            };

            if (!currentUser) return <LoginScreen onLogin={u => { setCurrentUser(u); localStorage.setItem('currentUser', JSON.stringify(u)); }} driveUrl={driveUrl} apiCall={appApiCall} />;

            const staging = employees.filter(e => e.reportsTo === 'STAGING');
            const roots = employees.filter(e => (!e.reportsTo) && e.reportsTo !== 'STAGING');
            const role = currentUser.role;
            const isLocked = role !== 'admin' && role !== 'supervisor';

            return (
                <div className="flex flex-col h-full bg-gray-50">
                    <nav className="bg-white shadow-sm border-b sticky top-0 z-40 h-14 flex items-center justify-between px-4">
                        <div className="flex items-center gap-2">
                            <button onClick={() => setIsSidebarOpen(!isSidebarOpen)} className="md:hidden p-2"><Icons.Menu/></button>
                            <div className="bg-red-600 px-2 py-1 rounded text-white font-bold">HR</div>
                            <input value={deptName} onChange={e => {setDeptName(e.target.value); localStorage.setItem('deptName', e.target.value);}} className="font-bold text-gray-800 outline-none bg-transparent border-b border-transparent focus:border-blue-500 transition-colors" disabled={role!=='admin'}/>
                            <span className={`text-xs flex items-center ${cloudStatus==='online'?'text-green-600':cloudStatus==='error'?'text-red-500':'text-gray-400'}`}>
                                {cloudStatus==='online' ? <Icons.Cloud size={12}/> : cloudStatus==='error' ? <Icons.Alert size={12}/> : null}
                                <span className="ml-1 hidden sm:inline capitalize">{cloudStatus}</span>
                            </span>
                        </div>
                        <div className="flex items-center gap-2">
                            <button onClick={() => setViewMode(m => m==='chart'?'list':'chart')} className="p-2 hover:bg-gray-100 rounded-full text-gray-600">{viewMode==='chart'?<Icons.List/>:<Icons.Grid/>}</button>
                            <button onClick={handleExport} className="p-2 hover:bg-gray-100 rounded-full text-gray-600"><Icons.Download/></button>
                            {!isLocked && <Button onClick={() => setModal({ open: true, data: { isNew: true, reportsTo: 'STAGING' } })} variant="primary" icon={Icons.Plus} className="hidden sm:flex">Add</Button>}
                            {role==='admin' && <button onClick={() => setAdminOpen(true)} className="p-2 hover:bg-gray-100 rounded-full"><Icons.Settings/></button>}
                            <button onClick={() => { setCurrentUser(null); localStorage.removeItem('currentUser'); }} className="p-2 text-red-500 hover:bg-red-50 rounded-full"><Icons.LogOut/></button>
                        </div>
                    </nav>

                    {moveSource && <div className="bg-blue-600 text-white p-2 text-center text-sm sticky top-14 z-50 animate-bounce cursor-pointer" onClick={() => setMoveSource(null)}>Moving: <b>{moveSource.name}</b> (Tap destination) - Tap here to Cancel</div>}

                    <div className="flex flex-1 overflow-hidden relative">
                        {viewMode === 'chart' && (
                            <aside className={`fixed inset-y-0 left-0 z-30 bg-white border-r shadow-xl md:shadow-none md:relative transform transition-transform duration-300 ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full md:translate-x-0'}`} style={{ width: sidebarWidth }}>
                                <div className="p-4 h-full overflow-y-auto pb-20">
                                    <h2 className="text-sm font-bold text-gray-500 mb-4 uppercase">Staging Area ({staging.length})</h2>
                                    <div className="space-y-3">
                                        {staging.map(emp => <EmployeeCard key={emp.id} employee={emp} isStaging={true} onClick={e => setModal({open:true, data:e})} onMoveInit={setMoveSource} isSelected={moveSource?.id===emp.id} isLocked={isLocked}/>)}
                                        {staging.length===0 && <div className="text-center py-8 text-gray-300 border-2 border-dashed rounded">Empty</div>}
                                    </div>
                                </div>
                                <div className="sidebar-resizer hidden md:block" onMouseDown={e => { const move = ev => setSidebarWidth(ev.clientX); document.addEventListener('mousemove', move); document.addEventListener('mouseup', () => document.removeEventListener('mousemove', move), {once:true}); }}></div>
                            </aside>
                        )}

                        <main className="flex-1 bg-gray-100 p-8 overflow-auto relative touch-pan-x touch-pan-y" style={viewMode==='chart' ? { backgroundImage: 'radial-gradient(#cbd5e1 1px, transparent 1px)', backgroundSize: '20px 20px' } : {}}>
                            {viewMode === 'chart' && <Ruler orientation="horizontal" length={3000} />}
                            {viewMode === 'chart' && <Ruler orientation="vertical" length={2000} />}
                            
                            {viewMode === 'chart' ? (
                                <div className="min-h-full flex flex-col items-center origin-top-left transition-transform mt-8 ml-8" style={{ transform: `scale(${zoom})` }}>
                                    <div id="org-chart-full-view" className="bg-white p-8 rounded-2xl border shadow-xl inline-block min-w-max">
                                        <div className="text-center mb-6 border-b-2 border-red-600 pb-2"><h1 className="text-3xl font-bold uppercase">{deptName}</h1></div>
                                        <div className="flex gap-16 justify-center">
                                            {roots.map(root => <EmployeeNode key={root.id} employee={root} allEmployees={employees} onEdit={e => setModal({open:true, data:e})} onDelete={handleDeleteEmp} onAddSubordinate={id => setModal({open:true, data:{isNew:true, reportsTo:id}})} onDrop={handleDrop} onMoveSelect={t => { handleDrop(moveSource.id, t); setMoveSource(null); }} moveTargetId={moveSource?.id} isLocked={isLocked}/>)}
                                        </div>
                                    </div>
                                    <div className="zoom-controls fixed bottom-5 right-5 bg-white p-2 rounded shadow flex gap-2 border items-center z-40">
                                        <button onClick={() => setZoom(z => Math.max(0.3, z-0.1))}><Icons.ZoomOut/></button>
                                        <span className="text-xs w-8 text-center">{Math.round(zoom*100)}%</span>
                                        <button onClick={() => setZoom(z => Math.min(1.5, z+0.1))}><Icons.ZoomIn/></button>
                                    </div>
                                </div>
                            ) : (
                                <div className="bg-white rounded-xl shadow border overflow-hidden">
                                    <table className="min-w-full divide-y divide-gray-200">
                                        <thead className="bg-gray-50"><tr><th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Employee</th><th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Position</th><th className="px-6 py-3 text-right">Action</th></tr></thead>
                                        <tbody className="divide-y divide-gray-200">{employees.map(e => <tr key={e.id}><td className="px-6 py-4 flex items-center gap-3"><img src={e.image||"https://via.placeholder.com/100"} className="h-10 w-10 rounded-full bg-gray-200"/><div><div className="font-medium text-gray-900">{e.name}</div></div></td><td className="px-6 py-4 text-sm text-gray-500">{e.position}</td><td className="px-6 py-4 text-right"><button onClick={() => setModal({open:true, data:e})} className="text-blue-600 hover:text-blue-900 text-sm">Edit</button></td></tr>)}</tbody>
                                    </table>
                                </div>
                            )}
                        </main>
                    </div>

                    {showDebug && <DebugConsole logs={debugLogs} onClose={() => setShowDebug(false)} onClear={() => setDebugLogs([])} />}
                    <div className="fixed bottom-4 left-4 z-50"><button onClick={() => setShowDebug(!showDebug)} className="bg-gray-800 text-white p-2 rounded-full opacity-50 hover:opacity-100"><Icons.Terminal size={16}/></button></div>

                    {modal.open && <EmployeeForm 
                        employee={modal.data} 
                        supervisors={employees} 
                        positions={positions} 
                        onSave={handleSaveEmp} 
                        onCancel={() => setModal({ open: false })} 
                        onDelete={handleDeleteEmp} 
                        role={role} 
                        driveUrl={driveUrl} 
                        onAddPosition={handleAddPosition} 
                        onDeletePosition={handleDeletePosition} 
                    />}
                    {adminOpen && <AdminPanel onClose={() => setAdminOpen(false)} driveUrl={driveUrl} setDriveUrl={setDriveUrl} apiCall={appApiCall} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
