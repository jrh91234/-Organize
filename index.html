<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HR System V15 (Central Admin)</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; touch-action: manipulation; }
        .draggable-source { cursor: grab; } .draggable-source:active { cursor: grabbing; }
        .zoom-controls { position: fixed; bottom: 20px; right: 20px; background: white; padding: 10px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 40; display: flex; align-items: center; gap: 8px; border: 1px solid #e2e8f0; }
        .undo-controls { position: fixed; bottom: 80px; right: 20px; z-index: 40; display: flex; flex-direction: column; gap: 8px; }
        .batch-actions { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: white; padding: 10px 20px; border-radius: 50px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); z-index: 50; display: flex; gap: 12px; align-items: center; border: 1px solid #e2e8f0; animation: slideUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .sidebar-resizer { width: 5px; cursor: col-resize; background-color: transparent; position: absolute; right: 0; top: 0; bottom: 0; z-index: 50; } .sidebar-resizer:hover, .sidebar-resizer.resizing { background-color: #3b82f6; }
        .sidebar-toggle-btn { position: absolute; top: 50%; transform: translateY(-50%); width: 24px; height: 40px; background: white; border: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 50; box-shadow: 2px 0 5px rgba(0,0,0,0.1); color: #4b5563; }
        .reorder-controls { position: absolute; top: 50%; transform: translateY(-50%); display: flex; flex-direction: column; gap: 2px; z-index: 30; opacity: 0; transition: opacity 0.2s; } .group:hover .reorder-controls { opacity: 1; }
        .reorder-btn { background: white; border: 1px solid #e2e8f0; border-radius: 50%; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #64748b; box-shadow: 0 1px 2px rgba(0,0,0,0.1); font-size: 8px; } .reorder-btn:hover { background: #f1f5f9; color: #2563eb; transform: scale(1.1); }
        .flash-active { animation: flash-glow 1.5s infinite; border-color: #eab308 !important; border-width: 2px; z-index: 50 !important; }
        @keyframes flash-glow { 0% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0.7); transform: scale(1); } 50% { box-shadow: 0 0 0 15px rgba(234, 179, 8, 0); transform: scale(1.1); } 100% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0); transform: scale(1); } }
        th { cursor: pointer; user-select: none; } th:hover { background-color: #f3f4f6; }
        .spinner { animation: spin 1s linear infinite; } @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        /* Grid Control Pill Style */
        .grid-control-pill { display: flex; align-items: center; background: rgba(255, 255, 255, 0.9); border-radius: 9999px; border: 1px solid #e2e8f0; box-shadow: 0 2px 4px rgba(0,0,0,0.05); overflow: hidden; }
        .grid-btn { padding: 2px 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #64748b; transition: all 0.2s; }
        .grid-btn:hover { background-color: #f1f5f9; color: #2563eb; }
        .grid-btn:active { background-color: #e2e8f0; }
        .grid-val { padding: 0 4px; font-size: 10px; font-weight: bold; color: #334155; min-width: 16px; text-align: center; user-select: none; }
        /* Tab Button Style */
        .tab-btn { padding: 8px 16px; font-size: 14px; font-weight: 600; border-bottom: 2px solid transparent; color: #64748b; transition: all 0.2s; }
        .tab-btn.active { color: #2563eb; border-bottom-color: #2563eb; }
        .tab-btn:hover:not(.active) { color: #334155; background-color: #f8fafc; border-radius: 8px 8px 0 0; }
        @media print { nav, .zoom-controls, .undo-controls, .batch-actions, .sidebar-resizer, .sidebar-toggle-btn, aside, .grid-control-pill { display: none !important; } }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 h-screen overflow-hidden">
    <div id="root" class="h-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback, useMemo } = React;

        // --- Utils ---
        const formatDriveUrl = (url) => { if (!url) return "https://placehold.co/100x100?text=No+Img"; if (url.includes('drive.google.com') || url.includes('docs.google.com')) { let id = null; const idMatch1 = url.match(/id=([a-zA-Z0-9_-]+)/); if (idMatch1) id = idMatch1[1]; else { const idMatch2 = url.match(/\/d\/([a-zA-Z0-9_-]+)/); if (idMatch2) id = idMatch2[1]; } if (id) return `https://lh3.googleusercontent.com/d/$$${id}`; } return url; };
        const compressImage = (file, targetSizeKB = 512) => { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = (event) => { const img = new Image(); img.src = event.target.result; img.onload = () => { const canvas = document.createElement('canvas'); let width = img.width, height = img.height; const MAX = 1600; if (width > MAX || height > MAX) { if (width > height) { height *= MAX / width; width = MAX; } else { width *= MAX / height; height = MAX; } } canvas.width = width; canvas.height = height; const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height); let quality = 0.9, dataUrl = canvas.toDataURL('image/jpeg', quality); while (dataUrl.length * 0.75 > targetSizeKB * 1024 && quality > 0.1) { quality -= 0.1; dataUrl = canvas.toDataURL('image/jpeg', quality); } resolve(dataUrl); }; img.onerror = reject; }; reader.onerror = reject; }); };
        const formatDate = (dateString) => { if (!dateString) return ""; const date = new Date(dateString); if (isNaN(date.getTime())) return dateString; return date.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: '2-digit' }); };
        const formatDateTime = (dateString) => { if (!dateString) return "-"; const date = new Date(dateString); if (isNaN(date.getTime())) return "-"; return date.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: '2-digit', hour: '2-digit', minute: '2-digit' }); };
        const calculateTenure = (dateString) => { if (!dateString) return ""; const start = new Date(dateString); const now = new Date(); if (isNaN(start.getTime())) return ""; let years = now.getFullYear() - start.getFullYear(); let months = now.getMonth() - start.getMonth(); if (months < 0 || (months === 0 && now.getDate() < start.getDate())) { years--; months += 12; } if (years < 0) return "New"; return `${years} ‡∏õ‡∏µ ${months} ‡∏î.`; };
        const safeLocalLoad = (key, fallback) => { try { const item = localStorage.getItem(key); return item ? JSON.parse(item) : fallback; } catch (e) { console.warn(`Error loading ${key}, using fallback.`, e); return fallback; } };

        const getPositionRank = (position) => {
            const p = (position || "").toLowerCase();
            if (p.includes('manager')) return 5;
            if (p.includes('supervisor') || p.includes('sup')) return 4;
            if (p.includes('engineer') || p.includes('eng')) return 3;
            if (p.includes('leader')) return 2;
            return 1;
        };
        const getUserRoleRank = (role) => {
            if (role === 'admin') return 10;
            if (role === 'supervisor') return 4; 
            if (role === 'leader') return 2;     
            return 0; // Viewer
        };
        const canEditEmployee = (currentUser, targetEmp) => {
            if (!currentUser) return false;
            if (currentUser.role === 'admin') return true; 
            if (currentUser.dept !== 'ALL' && currentUser.dept !== targetEmp.dept) return false;
            const myRank = getUserRoleRank(currentUser.role);
            const targetRank = getPositionRank(targetEmp.position);
            return myRank > targetRank;
        };

        const IconBase = ({ children, size = 18, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>;
        const Icons = { 
            Camera: (p)=><IconBase {...p}><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></IconBase>, Plus: (p)=><IconBase {...p}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></IconBase>, Trash2: (p)=><IconBase {...p}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></IconBase>, 
            X: (p)=><IconBase {...p}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></IconBase>, Check: (p)=><IconBase {...p}><polyline points="20 6 9 17 4 12"/></IconBase>, 
            Settings: (p) => ( <svg xmlns="http://www.w3.org/2000/svg" width={p.size || 18} height={p.size || 18} viewBox="0 0 24 24" fill="currentColor" stroke="none" className={p.className}> <path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.488.488 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 0 0-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/> </svg> ),
            Move: (p)=><IconBase {...p}><polyline points="5 9 2 12 5 15"/><polyline points="9 5 12 2 15 5"/><polyline points="19 9 22 12 19 15"/><polyline points="9 19 12 22 15 19"/><line x1="2" y1="12" x2="22" y2="12"/><line x1="12" y1="2" x2="12" y2="22"/></IconBase>, Menu: (p)=><IconBase {...p}><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></IconBase>, 
            Grid: (p)=><IconBase {...p}><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></IconBase>, List: (p)=><IconBase {...p}><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></IconBase>, 
            ChevronLeft: (p)=><IconBase {...p}><polyline points="15 18 9 12 15 6"/></IconBase>, ChevronRight: (p)=><IconBase {...p}><polyline points="9 18 15 12 9 6"/></IconBase>, 
            ArrowUp: (p)=><IconBase {...p}><line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/></IconBase>, ArrowDown: (p)=><IconBase {...p}><line x1="12" y1="5" x2="12" y2="19"/><polyline points="19 12 12 19 5 12"/></IconBase>, ArrowLeft: (p)=><IconBase {...p}><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></IconBase>, ArrowRight: (p)=><IconBase {...p}><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></IconBase>, 
            RotateCcw: (p)=><IconBase {...p}><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></IconBase>, 
            RulerIcon: (p)=><IconBase {...p}><path d="M21.3 15.3a2.4 2.4 0 0 1 0 3.4l-2.6 2.6a2.4 2.4 0 0 1-3.4 0L2.7 8.7a2.4 2.4 0 0 1 0-3.4l2.6-2.6a2.4 2.4 0 0 1 3.4 0Z"/><line x1="14.5" y1="3.2" x2="18.8" y2="7.5"/><line x1="12.5" y1="5.2" x2="16.8" y2="9.5"/><line x1="10.5" y1="7.2" x2="14.8" y2="11.5"/><line x1="8.5" y1="9.2" x2="12.8" y2="13.5"/><line x1="6.5" y1="11.2" x2="10.8" y2="15.5"/><line x1="4.5" y1="13.2" x2="8.8" y2="17.5"/></IconBase>, 
            Edit: (p)=><IconBase {...p}><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></IconBase>, Lock: (p)=><IconBase {...p}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></IconBase>, Unlock: (p)=><IconBase {...p}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></IconBase>, 
            ZoomIn: (p)=><IconBase {...p}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="11" y1="8" x2="11" y2="14"/><line x1="8" y1="11" x2="14" y2="11"/></IconBase>, ZoomOut: (p)=><IconBase {...p}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="8" y1="11" x2="14" y2="11"/></IconBase>, 
            LogOut: (p)=><IconBase {...p}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></IconBase>, Cloud: (p)=><IconBase {...p}><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></IconBase>, Loader: (p)=><IconBase {...p} className={`spinner ${p.className}`}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></IconBase>, 
            Alert: (p)=><IconBase {...p}><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></IconBase>, Paint: (p)=><IconBase {...p}><path d="M18.375 2.625a2.121 2.121 0 1 1 3 3L12 15l-4 1 1-4Z"/><path d="m15 6.5 3 3"/><path d="M6 20h1a2 2 0 0 0 2-2V8a2 2 0 0 0-4 0v10a2 2 0 0 0 1 2Z"/></IconBase>, 
            FileSpreadsheet: (p)=><IconBase {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M8 13h2"/><path d="M8 17h2"/><path d="M14 13h2"/><path d="M14 17h2"/></IconBase>, Chart: (p)=><IconBase {...p}><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></IconBase>, 
            Image: (p)=><IconBase {...p}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></IconBase>, Briefcase: (p)=><IconBase {...p}><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></IconBase>, 
            CheckSquare: (p)=><IconBase {...p}><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></IconBase>, Type: (p)=><IconBase {...p}><polyline points="4 7 4 4 20 4 20 7"/><line x1="9" y1="20" x2="15" y2="20"/><line x1="12" y1="4" x2="12" y2="20"/></IconBase>, 
            Link: (p)=><IconBase {...p}><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></IconBase>, Search: (p)=><IconBase {...p}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></IconBase>, 
            Upload: (p)=><IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></IconBase>, RefreshCw: (p)=><IconBase {...p}><path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/><path d="M3 22v-6h6"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"/></IconBase>, Fingerprint: (p)=><IconBase {...p}><path d="M2 12a10 10 0 0 1 18-6"/><path d="M5 15a10 10 0 0 1 12-10"/><path d="M8 18a10 10 0 0 1 6-12"/><path d="M11 21a10 10 0 0 1 0-14"/><path d="M14 18a10 10 0 0 1-6 0"/><path d="M17 15a10 10 0 0 1-12 0"/><path d="M20 12a10 10 0 0 1-18 6"/></IconBase>,
            Users: (p)=><IconBase {...p}><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></IconBase>,
            Sort: (p)=><IconBase {...p}><path d="m3 16 4 4 4-4"/><path d="M7 20V4"/><path d="m21 8-4-4-4 4"/><path d="M17 4v16"/></IconBase>,
            Wifi: (p)=><IconBase {...p}><path d="M5 12.55a11 11 0 0 1 14.08 0"/><path d="M1.42 9a16 16 0 0 1 21.16 0"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" y1="20" x2="12.01" y2="20"/></IconBase>,
            WifiOff: (p)=><IconBase {...p}><line x1="1" y1="1" x2="23" y2="23"/><path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55"/><path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39"/><path d="M10.71 5.05A16 16 0 0 1 22.58 9"/><path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" y1="20" x2="12.01" y2="20"/></IconBase>,
            LayoutGrid: (p)=><IconBase {...p}><rect width="7" height="7" x="3" y="3" rx="1" /><rect width="7" height="7" x="14" y="3" rx="1" /><rect width="7" height="7" x="14" y="14" rx="1" /><rect width="7" height="7" x="3" y="14" rx="1" /></IconBase>,
            Minus: (p)=><IconBase {...p}><line x1="5" y1="12" x2="19" y2="12"/></IconBase>
        };

        const Button = ({ children, onClick, variant = 'primary', className = '', icon: Icon, disabled, title }) => { const base = "flex items-center justify-center px-3 py-2 sm:px-4 sm:py-2 rounded-lg font-medium transition-all active:scale-95 shadow-sm disabled:opacity-50 text-sm sm:text-base whitespace-nowrap"; const variants = { primary: "bg-blue-600 text-white hover:bg-blue-700", secondary: "bg-white text-gray-700 border border-gray-200 hover:bg-gray-50", danger: "bg-red-50 text-red-600 hover:bg-red-100 border border-red-100", success: "bg-green-600 text-white hover:bg-green-700", warning: "bg-orange-500 text-white hover:bg-orange-600", }; return <button type="button" onClick={onClick} disabled={disabled} className={`${base} ${variants[variant]} ${className}`} title={title}>{Icon && <Icon size={18} className="mr-2" />} {children}</button>; };
        const THEMES = { blue: { name: 'Blue', lv0: 'bg-blue-100 border-blue-600', lv1: 'bg-blue-50 border-blue-400', lvN: 'bg-white border-blue-200' }, teal: { name: 'Teal', lv0: 'bg-teal-100 border-teal-600', lv1: 'bg-teal-50 border-teal-400', lvN: 'bg-white border-teal-200' }, indigo: { name: 'Indigo', lv0: 'bg-indigo-100 border-indigo-600', lv1: 'bg-indigo-50 border-indigo-400', lvN: 'bg-white border-indigo-200' }, rose: { name: 'Rose', lv0: 'bg-rose-100 border-rose-600', lv1: 'bg-rose-50 border-rose-400', lvN: 'bg-white border-rose-200' }, slate: { name: 'Slate', lv0: 'bg-slate-200 border-slate-600', lv1: 'bg-slate-100 border-slate-400', lvN: 'bg-white border-slate-300' }, orange: { name: 'Orange', lv0: 'bg-orange-100 border-orange-600', lv1: 'bg-orange-50 border-orange-400', lvN: 'bg-white border-orange-200' } };
        const SHAPES = { rounded: { name: 'Rounded', cls: 'rounded-xl' }, sharp: { name: 'Square', cls: 'rounded-none' }, pill: { name: 'Pill', cls: 'rounded-[2rem]' }, leaf: { name: 'Leaf', cls: 'rounded-tr-3xl rounded-bl-3xl rounded-tl-md rounded-br-md' } };

        // [V15 NEW] Unified Admin Panel
        const AdminPanel = ({ onClose, driveUrl, setDriveUrl, apiCall, depts, onAddDept, onDeleteDept }) => { 
            const [activeTab, setActiveTab] = useState('users'); // users, depts, system
            const [users, setUsers] = useState([]);
            const [newUser, setNewUser] = useState({ username: '', password: '', role: 'leader', name: '' }); 
            const [editingUsername, setEditingUsername] = useState(null);
            const [newDeptName, setNewDeptName] = useState('');
            const [loading, setLoading] = useState(false); 
            
            useEffect(() => { const loadUsers = async () => { setLoading(true); let loadedUsers = []; if (driveUrl) { try { const res = await apiCall(driveUrl, 'getUsers'); if (res?.status === 'success') loadedUsers = res.users; } catch (e) {} } if (loadedUsers.length === 0) loadedUsers = safeLocalLoad('users', []) || [{ username: 'admin', password: 'password', role: 'admin', name: 'Admin User' }]; setUsers(loadedUsers); setLoading(false); }; loadUsers(); }, [driveUrl]);
            const saveUserAction = async () => { if (!newUser.username || !newUser.password) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å User/Pass"); setLoading(true); let updatedUsers;
            if (editingUsername) updatedUsers = users.map(u => u.username === editingUsername ? newUser : u);
            else { if (users.some(u => u.username === newUser.username)) { setLoading(false); return alert('‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡πâ‡∏≥'); } updatedUsers = [...users, newUser]; } setUsers(updatedUsers);
            localStorage.setItem('users', JSON.stringify(updatedUsers)); if (driveUrl) try { await apiCall(driveUrl, 'saveUser', { user: newUser }); } catch (e) { alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Cloud ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
            } setEditingUsername(null); setNewUser({ username: '', password: '', role: 'leader', name: '' }); setLoading(false); };
            const deleteUserAction = async (username) => { if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö?')) return; setLoading(true); const updated = users.filter(u => u.username !== username); setUsers(updated);
            localStorage.setItem('users', JSON.stringify(updated)); if (driveUrl) await apiCall(driveUrl, 'deleteUser', { username }); setLoading(false); };
            
            return ( <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[70]"><div className="bg-white w-full max-w-3xl rounded-2xl shadow-xl overflow-hidden flex flex-col max-h-[90vh]"> 
                
                {/* Header with Tabs */}
                <div className="bg-white border-b">
                    <div className="p-6 pb-4 flex justify-between items-center"><h2 className="text-xl font-bold flex items-center gap-2"><Icons.Settings/> Admin Panel</h2><button onClick={onClose}><Icons.X /></button></div> 
                    <div className="flex px-6 gap-6">
                        <button onClick={()=>setActiveTab('users')} className={`tab-btn ${activeTab==='users'?'active':''}`}>User Management</button>
                        <button onClick={()=>setActiveTab('depts')} className={`tab-btn ${activeTab==='depts'?'active':''}`}>Departments</button>
                        <button onClick={()=>setActiveTab('system')} className={`tab-btn ${activeTab==='system'?'active':''}`}>System Config</button>
                    </div>
                </div>

                <div className="p-6 overflow-y-auto space-y-6 flex-1 bg-gray-50"> 
                    
                    {/* Tab 1: Users */}
                    {activeTab === 'users' && (
                    <div>
                        <div className="flex gap-2 mb-4 items-end bg-white p-4 rounded-xl shadow-sm flex-wrap border">
                            <div className="flex-1 min-w-[100px]"><label className="text-xs text-gray-500">User</label><input value={newUser.username} onChange={e => setNewUser({...newUser, username: e.target.value})} className="border p-2 rounded text-sm w-full" disabled={!!editingUsername}/></div>
                            <div className="flex-1 min-w-[100px]"><label className="text-xs text-gray-500">Pass</label><input value={newUser.password} onChange={e => setNewUser({...newUser, password: e.target.value})} className="border p-2 rounded text-sm w-full"/></div>
                            <div className="flex-1 min-w-[100px]"><label className="text-xs text-gray-500">Name</label><input value={newUser.name} onChange={e => setNewUser({...newUser, name: e.target.value})} className="border p-2 rounded text-sm w-full"/></div>
                            <div className="w-24"><label className="text-xs text-gray-500">Role</label><select value={newUser.role} onChange={e => setNewUser({...newUser, role: e.target.value})} className="border p-2 rounded text-sm w-full"><option value="admin">Admin</option><option value="supervisor">Sup</option><option value="leader">Leader</option><option value="viewer">View</option></select></div>
                            <button onClick={saveUserAction} className={`${editingUsername ? 'bg-orange-500' : 'bg-green-600'} text-white p-2 rounded h-[38px] w-[38px] flex justify-center items-center shadow-sm`}>{editingUsername ? <Icons.Check size={18}/> : <Icons.Plus size={18}/>}</button>
                        </div> 
                        <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
                            <table className="w-full text-sm text-left"><thead className="bg-gray-100 text-gray-600 uppercase text-xs"><tr><th className="p-3">User</th><th className="p-3">Name</th><th className="p-3">Role</th><th className="p-3">Action</th></tr></thead>
                            <tbody className="divide-y">{users.map((u, i) => <tr key={i} className="hover:bg-gray-50"><td className="p-3 font-medium">{u.username}</td><td className="p-3">{u.name}</td><td className="p-3"><span className={`px-2 py-0.5 rounded text-xs font-bold ${u.role==='admin'?'bg-red-100 text-red-800':u.role==='supervisor'?'bg-blue-100 text-blue-800':'bg-gray-100 text-gray-600'}`}>{u.role}</span></td><td className="p-3 flex gap-2"><button onClick={() => { setNewUser(u); setEditingUsername(u.username); }} className="text-orange-500 hover:bg-orange-50 p-1 rounded"><Icons.Edit size={16}/></button>{u.username !== 'admin' && <button onClick={() => deleteUserAction(u.username)} className="text-red-500 hover:bg-red-50 p-1 rounded"><Icons.Trash2 size={16}/></button>}</td></tr>)}</tbody></table> 
                        </div>
                    </div>
                    )}

                    {/* Tab 2: Departments */}
                    {activeTab === 'depts' && (
                    <div className="bg-white p-6 rounded-xl shadow-sm border">
                        <h3 className="font-bold text-gray-800 mb-4 flex items-center gap-2"><Icons.Grid/> Manage Departments</h3>
                        <div className="flex gap-2 mb-4">
                            <input value={newDeptName} onChange={e=>setNewDeptName(e.target.value)} placeholder="Enter new department name..." className="flex-1 border p-2 rounded text-sm"/>
                            <button onClick={()=>{if(newDeptName){onAddDept(newDeptName);setNewDeptName('');}}} className="bg-green-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-green-700 shadow-sm flex items-center gap-2"><Icons.Plus size={18}/> Add</button>
                        </div>
                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-2 max-h-[400px] overflow-y-auto">
                            {depts.map(d => (
                                <div key={d} className="flex justify-between items-center p-3 bg-gray-50 rounded-lg border hover:border-blue-300 group transition-all">
                                    <span className="font-medium text-gray-700">{d}</span>
                                    <button onClick={()=>onDeleteDept(d)} className="text-gray-400 hover:text-red-600 p-1 rounded-full hover:bg-red-50 transition-all opacity-0 group-hover:opacity-100"><Icons.Trash2 size={16}/></button>
                                </div>
                            ))}
                        </div>
                    </div>
                    )}

                    {/* Tab 3: System */}
                    {activeTab === 'system' && (
                        <div className="bg-white p-6 rounded-xl shadow-sm border">
                            <h3 className="font-bold text-gray-800 mb-4 flex items-center gap-2"><Icons.Cloud/> System Connection</h3>
                            <div className="space-y-2">
                                <label className="text-sm font-bold text-gray-600">Google Apps Script URL (Backend)</label>
                                <div className="flex gap-2">
                                    <input type="text" value={driveUrl} onChange={(e) => setDriveUrl(e.target.value)} className="w-full p-2 border rounded text-sm bg-gray-50 font-mono text-gray-600"/>
                                </div>
                                <p className="text-xs text-gray-400 mt-2">Use this URL to connect your frontend to the Google Sheets backend.</p>
                            </div>
                        </div>
                    )}

                </div> </div></div> );
        };

        const EmployeeCard = React.memo(({ employee, onClick, onDragStart, onMoveInit, className="", isStaging=false, isSelected=false, isLocked=false, isViewOnly=false, themeConf, shapeClass, selectionMode, toggleSelection, onReorder, onGridColChange, currentUser }) => {
            const isSub = employee.type === 'Subcontract';
            const isLeader = (employee.position || "").toLowerCase().includes('leader');
            let bgClass = "bg-white"; let borderClass = "border-gray-200"; let radiusClass = shapeClass?.cls || 'rounded-xl'; let badgeClass = isSub ? 'bg-orange-500' : 'bg-blue-600';
            if (employee.customColor && THEMES[employee.customColor]) { const styles = THEMES[employee.customColor].lv0.split(' '); bgClass = styles.find(s => s.startsWith('bg-')) || bgClass; borderClass = styles.find(s => s.startsWith('border-')) || borderClass; } else if (className) { const styles = className.split(' '); bgClass = styles.find(s => s.startsWith('bg-')) || bgClass; borderClass = styles.find(s => s.startsWith('border-')) || borderClass; }
            if (employee.customShape && SHAPES[employee.customShape]) radiusClass = SHAPES[employee.customShape].cls;
            const textColorStyle = employee.textColor ? { color: employee.textColor } : {};
            
            const currentGrid = employee.gridCols ? parseInt(employee.gridCols) : 0;
            const displayGrid = (isNaN(currentGrid) || currentGrid === 0) ? 'Auto' : currentGrid;

            // [V10] Determine if draggable based on smart lock logic
            // Admin/Sup can always drag. Leaders can drag ONLY if they have permission over this node.
            // But root nodes (Managers) shouldn't be draggable by Leaders.
            // Logic: !isLocked OR (isLeaderRole AND canEdit)
            const isLeaderRole = currentUser?.role === 'leader';
            const canEditThis = canEditEmployee(currentUser, employee);
            // Draggable if: (Not Locked global) OR (Is Leader AND Can Edit This Node)
            const canDrag = !isLocked || (isLeaderRole && canEditThis);

            return (
                <div draggable={canDrag && !isViewOnly} onDragStart={(e) => canDrag && !isViewOnly && onDragStart && onDragStart(e, employee.id)} className={`relative flex flex-col items-center p-3 border-b-4 shadow-sm w-36 sm:w-40 transition-transform duration-200 cursor-pointer group ${bgClass} ${borderClass} ${radiusClass} ${isSelected?'ring-4 ring-purple-500 scale-105 z-20 shadow-xl':'hover:scale-105'} ${(!canDrag || isViewOnly)?'cursor-default':'draggable-source'} ${className}`} onClick={(e) => { e.stopPropagation(); if(selectionMode) toggleSelection(employee.id); else if(!isViewOnly || (isLeaderRole && canEditThis) || !isLocked) onClick(employee); }} id={`node-${employee.id}`}>
                    <div className={`absolute top-2 left-2 px-1.5 py-0.5 rounded text-[10px] font-bold text-white ${badgeClass}`}>{isSub?'S':'P'}</div>
                    
                    {/* [NEW] Capsule Grid Control (+/-) */}
                    {isLeader && canDrag && !isViewOnly && !isStaging && (
                        <div className="absolute top-2 right-2 grid-control-pill z-20" onClick={e=>e.stopPropagation()}>
                            <div className="grid-btn" onClick={()=>onGridColChange(employee.id, -1)}><Icons.Minus size={10}/></div>
                            <div className="grid-val">{displayGrid}</div>
                            <div className="grid-btn" onClick={()=>onGridColChange(employee.id, 1)}><Icons.Plus size={10}/></div>
                        </div>
                    )}

                    {selectionMode && <div className={`absolute top-2 right-2 w-5 h-5 rounded-full border-2 flex items-center justify-center ${isSelected?'bg-purple-600 border-purple-600':'border-gray-300 bg-white'}`}>{isSelected && <Icons.Check size={12} className="text-white"/>}</div>}
                    {canDrag && !isStaging && !selectionMode && !isViewOnly && !isLeader && ( <> 
                        <div className="reorder-controls" style={{left: '-10px'}}> <button className="reorder-btn" onClick={(e)=>{ e.stopPropagation(); onReorder(employee.id, -4); }}><Icons.ArrowUp size={8}/></button> <button className="reorder-btn" onClick={(e)=>{e.stopPropagation(); onReorder(employee.id, -1)}}><Icons.ArrowLeft size={8}/></button> </div> 
                        <div className="reorder-controls" style={{right: '-10px'}}> <button className="reorder-btn" onClick={(e)=>{ e.stopPropagation(); onReorder(employee.id, 4); }}><Icons.ArrowDown size={8}/></button> <button className="reorder-btn" onClick={(e)=>{e.stopPropagation(); onReorder(employee.id, 1)}}><Icons.ArrowRight size={8}/></button> </div> 
                    </> )}
                    <div className="relative"><img src={formatDriveUrl(employee.image)} referrerPolicy="no-referrer" loading="eager" onError={(e)=>{e.target.onerror=null; e.target.src="https://placehold.co/100x100?text=No+Img"}} className="w-14 h-14 sm:w-16 sm:h-16 rounded-full object-cover border-2 border-white shadow-sm bg-gray-200 pointer-events-none"/><div className="absolute -bottom-1 -right-1 bg-white rounded-full p-1 shadow"><div className={`w-3 h-3 rounded-full ${employee.status==='Active'?'bg-green-500':'bg-red-500'}`}></div></div></div>
                    <div className="mt-2 text-center w-full" style={textColorStyle}>
                        <p className="text-[10px] sm:text-xs font-bold opacity-60">{employee.id}</p>
                        <h3 className="text-xs sm:text-sm font-bold leading-tight truncate w-full">{employee.name}</h3>
                        <p className="text-[10px] sm:text-xs opacity-70 truncate w-full">{employee.position}</p>
                        {employee.showPhone && employee.phone && <p className="text-[10px] bg-gray-100 rounded px-1 mt-0.5 inline-block text-gray-600">üìû {employee.phone}</p>}
                        {isSub && employee.company && <p className="text-[9px] text-orange-600 truncate mt-0.5 font-bold">üè¢ {employee.company}</p>}
                        {employee.startDate && <div className="text-[9px] bg-green-50 text-green-700 px-1 rounded mt-1 border border-green-100 font-medium">‚è≥ {calculateTenure(employee.startDate)}</div>}
                    </div>
                    {isStaging && canDrag && !isViewOnly && !selectionMode && <button onClick={(e)=>{e.stopPropagation();onMoveInit(employee);}} className="absolute top-1 right-1 p-1.5 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-full"><Icons.Move size={14}/></button>}
                </div>
            );
        });

        const EmployeeNode = React.memo(({ employee, allEmployees, onEdit, onDelete, onDrop, onMoveSelect, moveTargetId, isLocked, isViewOnly, level = 0, themeConf, shapeClass, selectionMode, selectedIds, toggleSelection, onReorder, onAddChild, layoutThreshold, searchTerm, visitedIds = new Set(), onGridColChange, currentUser }) => {
            const [isDragOver, setIsDragOver] = useState(false);
            const [isDragOverGroup, setIsDragOverGroup] = useState(false);
            if (!employee || visitedIds.has(employee.id)) return null;
            const newVisited = new Set(visitedIds).add(employee.id);
            
            const subordinates = allEmployees.filter(e => e.reportsTo === employee.id && !newVisited.has(e.id)).sort((a, b) => { const isSubA = a.type === 'Subcontract' ? 1 : 0; const isSubB = b.type === 'Subcontract' ? 1 : 0; if (isSubA !== isSubB) return isSubA - isSubB; return (a.order || 0) - (b.order || 0); });
            
            let cardColor = "bg-white border-gray-300"; if (themeConf) { if (level === 0) cardColor = themeConf.lv0; else if (level === 1) cardColor = themeConf.lv1; else cardColor = themeConf.lvN; }
            const isMatch = searchTerm && employee.name.toLowerCase().includes(searchTerm.toLowerCase());
            if (isMatch) cardColor += " flash-active";
            
            const isLeader = (employee.position || "").toLowerCase().includes('leader');
            const isGrid = isLeader; 
            
            const gridStyle = isGrid ? { 
                display: 'grid', 
                gridTemplateColumns: `repeat(${employee.gridCols || 'auto-fit'}, minmax(140px, 1fr))` 
            } : {};

            const isLeaderRole = currentUser?.role === 'leader';
            const canDrag = !isLocked || (isLeaderRole && canEditEmployee(currentUser, employee));

            const handleDropInternal = (e) => { 
                if(!canDrag && isLocked) return; // Allow if leader rule met
                e.preventDefault(); setIsDragOver(false); 
                const rawData = e.dataTransfer.getData("empIds"); const droppedIds = rawData ? JSON.parse(rawData) : []; 
                if(droppedIds.length > 0 && !droppedIds.includes(employee.id)) onDrop(droppedIds, employee.id); 
            };
            const handleDropOnGroup = (e) => { 
                if(!canDrag && isLocked) return;
                e.preventDefault(); e.stopPropagation(); setIsDragOverGroup(false); 
                const rawData = e.dataTransfer.getData("empIds"); const droppedIds = rawData ? JSON.parse(rawData) : []; 
                if(droppedIds.length > 0 && !droppedIds.includes(employee.id)) onDrop(droppedIds, employee.id); 
            };

            return (
                <div className="flex flex-col items-center">
                    {level > 0 && <div className="h-4 sm:h-6 w-px bg-gray-300"></div>}
                    <div onDragOver={(e)=>{if(canDrag||!isLocked){e.preventDefault();setIsDragOver(true);}}} onDragLeave={()=>setIsDragOver(false)} onDrop={handleDropInternal} onClick={()=>moveTargetId && (canDrag || !isLocked) && onMoveSelect(employee.id)} className={`relative z-10 group transition-all ${isDragOver?'scale-110 drop-target-hover':''} ${moveTargetId?'cursor-crosshair':''}`}>
                        {moveTargetId && (canDrag || !isLocked) && <div className="absolute -inset-2 border-2 border-dashed border-blue-400 rounded-2xl bg-blue-50/50 z-20 flex items-center justify-center animate-pulse pointer-events-none"><span className="bg-blue-600 text-white text-[10px] px-2 py-0.5 rounded-full">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤</span></div>}
                        <EmployeeCard employee={employee} onClick={onEdit} onDragStart={(e, id)=>{ const payload = (selectionMode && selectedIds.includes(id)) ? selectedIds : [id]; e.dataTransfer.setData("empIds", JSON.stringify(payload)); }} className={cardColor} isLocked={isLocked} isViewOnly={isViewOnly} themeConf={themeConf} shapeClass={shapeClass} selectionMode={selectionMode} selectedIds={selectedIds} isSelected={selectedIds.includes(employee.id)} toggleSelection={toggleSelection} onReorder={onReorder} onGridColChange={onGridColChange} currentUser={currentUser}/>
                        {!moveTargetId && (canDrag || !isLocked) && !isViewOnly && !selectionMode && <button onClick={(e)=>{e.stopPropagation();onAddChild(employee);}} className="add-btn absolute -bottom-3 left-1/2 -translate-x-1/2 bg-white text-blue-600 border border-blue-200 rounded-full w-6 h-6 flex items-center justify-center shadow-md active:scale-95"><Icons.Plus size={14}/></button>}
                    </div>
                    
                    {subordinates.length > 0 && ( <> 
                        <div className="h-4 sm:h-6 w-px bg-gray-300"></div> 
                        <div className="flex relative"> 
                            {isGrid ? ( 
                                <div className={`gap-4 p-4 items-start rounded-xl border border-dashed transition-colors ${isDragOverGroup ? 'bg-blue-100 border-blue-500 ring-2 ring-blue-300' : 'bg-gray-50/50 border-gray-300'}`} style={gridStyle} onDragOver={(e)=>{if(canDrag||!isLocked){e.preventDefault();e.stopPropagation();setIsDragOverGroup(true);}}} onDragLeave={(e)=>{e.stopPropagation();setIsDragOverGroup(false);}} onDrop={handleDropOnGroup}> 
                                    {subordinates.map((sub) => (<EmployeeNode key={sub.id} employee={sub} allEmployees={allEmployees} onEdit={onEdit} onDrop={onDrop} onMoveSelect={onMoveSelect} moveTargetId={moveTargetId} level={level + 1} isLocked={isLocked} isViewOnly={isViewOnly} themeConf={themeConf} shapeClass={shapeClass} selectionMode={selectionMode} selectedIds={selectedIds} toggleSelection={toggleSelection} onReorder={onReorder} onAddChild={onAddChild} layoutThreshold={layoutThreshold} searchTerm={searchTerm} visitedIds={newVisited} onGridColChange={onGridColChange} currentUser={currentUser}/>))} 
                                    {(canDrag || !isLocked) && !isViewOnly && ( <button onClick={(e)=>{e.stopPropagation();onAddChild(employee);}} className="flex flex-col items-center justify-center w-36 h-32 border-2 border-dashed border-gray-300 rounded-xl text-gray-400 hover:text-blue-600 hover:border-blue-400 hover:bg-blue-50 transition-all gap-2 group"><div className="p-2 rounded-full bg-gray-100 group-hover:bg-blue-100"><Icons.Plus size={24}/></div><span className="text-xs font-bold">Add Member</span></button> )} 
                                </div> 
                            ) : ( 
                                <div className={`flex gap-4 sm:gap-6 pt-0 p-4 rounded-xl transition-colors ${isDragOverGroup ? 'bg-blue-50/50 ring-2 ring-blue-200' : ''}`} onDragOver={(e)=>{if(canDrag||!isLocked){e.preventDefault();e.stopPropagation();setIsDragOverGroup(true);}}} onDragLeave={(e)=>{e.stopPropagation();setIsDragOverGroup(false);}} onDrop={handleDropOnGroup}> 
                                    {subordinates.map((sub, i) => (<div key={sub.id} className="relative flex flex-col items-center"> {subordinates.length > 1 && <div className={`absolute top-0 h-px bg-gray-300 ${i===0?'w-1/2 right-0':''} ${i===subordinates.length-1?'w-1/2 left-0':''} ${i>0 && i<subordinates.length-1?'w-full':''}`}></div>} <EmployeeNode employee={sub} allEmployees={allEmployees} onEdit={onEdit} onDrop={onDrop} onMoveSelect={onMoveSelect} moveTargetId={moveTargetId} level={level + 1} isLocked={isLocked} isViewOnly={isViewOnly} themeConf={themeConf} shapeClass={shapeClass} selectionMode={selectionMode} selectedIds={selectedIds} toggleSelection={toggleSelection} onReorder={onReorder} onAddChild={onAddChild} layoutThreshold={layoutThreshold} searchTerm={searchTerm} visitedIds={newVisited} onGridColChange={onGridColChange} currentUser={currentUser}/> </div>))} 
                                </div> 
                            )} 
                        </div> 
                    </> )}
                </div>
            );
        });

        const EmployeeForm = ({ employee, supervisors, positions, depts, onSave, onCancel, onDelete, currentUser, driveUrl, onManagePositions }) => {
            const safePositions = positions || [];
            const safeDepts = depts || [];
            const [formData, setFormData] = useState({ id: '', name: '', position: '', dept: '', reportsTo: '', image: null, status: 'Active', type: 'Permanent', company: '', customColor: '', textColor: '#1f2937', startDate: '', phone: '', showPhone: true });
            const [showDeleteConfirm, setShowDeleteConfirm] = useState(false); const [isUploading, setIsUploading] = useState(false); const [tab, setTab] = useState('info');
            const fileInputRef = useRef(null); 
            const isEditMode = employee && !employee.isNew;
            
            const hasPermission = useMemo(() => { if (!currentUser) return false; return !isEditMode || canEditEmployee(currentUser, employee); }, [currentUser, isEditMode, employee]);
            useEffect(() => { if (isEditMode && employee) { setFormData({ type: 'Permanent', company: '', phone: '', showPhone: true, startDate: '', ...employee }); } else { setFormData({ id: Math.floor(60000 + Math.random() * 9000).toString(), name: '', position: employee?.position || '', dept: employee?.dept || (safeDepts[0] || ''), reportsTo: employee?.reportsTo || '', image: null, status: 'Active', type: 'Permanent', company: '', customColor: '', textColor: '#1f2937', startDate: '', phone: '', showPhone: true }); } }, [employee]);
            const handleImageUpload = async (e) => { const file = e.target.files[0]; if (!file) return; try { setIsUploading(true); const compressedBase64 = await compressImage(file, 512); if (driveUrl) { const res = await fetch(driveUrl, { method: 'POST', body: JSON.stringify({ action: 'upload', file: compressedBase64.split(',')[1], filename: `emp_${formData.id}.jpg`, mimetype: 'image/jpeg', oldFileUrl: formData.image }) }); const result = await res.json(); if (result?.url) { setFormData(prev => ({ ...prev, image: result.url })); } } else { setFormData(prev => ({ ...prev, image: compressedBase64 })); } } catch (err) { alert(err.message); } finally { setIsUploading(false); } };
            const filteredSupervisors = useMemo(() => { if (!supervisors) return []; return supervisors.filter(s => { if (!s || s.id === formData.id) return false; if (currentUser?.dept !== 'ALL' && s.dept !== formData.dept) return false; const lowerPos = (s.position || "").toLowerCase(); const isInvalidBoss = lowerPos.includes('operator') || lowerPos.includes('feeder'); if (formData.reportsTo === s.id) return true; return !isInvalidBoss; }); }, [supervisors, formData.id, formData.dept, formData.reportsTo, currentUser]);
            const tenureText = useMemo(() => calculateTenure(formData.startDate), [formData.startDate]);
            if (!hasPermission) { return ( <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-[60] p-4"> <div className="bg-white p-6 rounded-xl shadow-xl text-center"> <Icons.Lock size={48} className="mx-auto text-red-500 mb-4"/> <h2 className="text-xl font-bold text-gray-700">Access Denied</h2> <p className="text-gray-500 mt-2">‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡πà‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Å</p> <button onClick={onCancel} className="mt-6 bg-gray-200 px-4 py-2 rounded-lg">Close</button> </div> </div> ); }

            return (
                <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-[60] p-4">
                    <div className="bg-white w-full max-w-md rounded-2xl shadow-2xl flex flex-col max-h-[90vh]">
                        <div className="bg-gray-50 px-6 py-4 border-b flex justify-between items-center"><h2 className="text-lg font-bold">{isEditMode ? 'Edit Employee' : 'Add Employee'}</h2><button onClick={onCancel}><Icons.X/></button></div>
                        <div className="flex border-b"><button onClick={()=>setTab('info')} className={`flex-1 py-3 text-sm font-medium ${tab==='info'?'text-blue-600 border-b-2 border-blue-600':'text-gray-500'}`}>General Info</button><button onClick={()=>setTab('style')} className={`flex-1 py-3 text-sm font-medium ${tab==='style'?'text-blue-600 border-b-2 border-blue-600':'text-gray-500'}`}>Details & Style</button></div>
                        <form className="p-6 space-y-4 overflow-y-auto grow">
                            {tab === 'info' ? (<> 
                            <div className="flex flex-col items-center mb-4"><div className="w-20 h-20 rounded-full bg-gray-100 border-4 border-white shadow-md flex items-center justify-center overflow-hidden cursor-pointer relative group" onClick={()=>fileInputRef.current.click()}>{isUploading ? <Icons.Loader/> : (formData.image ? <img src={formatDriveUrl(formData.image)} className="w-full h-full object-cover"/> : <Icons.Camera size={24} className="text-gray-400"/>)}</div><input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={handleImageUpload} /></div>
                            <div className="grid grid-cols-2 gap-4"><div><label className="text-xs text-gray-500">ID</label><input name="id" value={formData.id} onChange={e=>setFormData({...formData, id: e.target.value})} className="w-full border p-2 rounded" /></div><div><label className="text-xs text-gray-500">Department</label><select name="dept" value={formData.dept} onChange={e=>setFormData({...formData, dept: e.target.value})} className="w-full border p-2 rounded bg-blue-50" disabled={currentUser.role !== 'admin' && currentUser.dept !== 'ALL'}>{safeDepts.map(d=><option key={d} value={d}>{d}</option>)}</select></div></div>
                            <div><label className="text-xs text-gray-500">Name</label><input value={formData.name} onChange={e=>setFormData({...formData, name: e.target.value})} className="w-full border p-2 rounded" required/></div>
                            <div className="flex gap-2 items-end">
                                <div className="flex-1"><label className="text-xs text-gray-500 flex justify-between">Position</label><select value={formData.position} onChange={e=>setFormData({...formData, position: e.target.value})} className="w-full border p-2 rounded">{safePositions.map(p=><option key={p} value={p}>{p}</option>)}{!safePositions.includes(formData.position) && formData.position && <option value={formData.position}>{formData.position}</option>}</select></div>
                                <button type="button" onClick={onManagePositions} className="p-2 border rounded bg-orange-50 text-orange-600 hover:bg-orange-100 mb-0.5" title="Manage Positions"><Icons.Settings size={18}/></button>
                            </div>
                            <div className="grid grid-cols-2 gap-4"><div><label className="text-xs text-gray-500">Reports To</label><select value={formData.reportsTo} onChange={e=>setFormData({...formData, reportsTo: e.target.value})} className="w-full border p-2 rounded bg-gray-50"><option value="STAGING">-- Waiting Area --</option><option value="">-- Top Management --</option>{filteredSupervisors.map(s=><option key={s.id} value={s.id}>{s.name} ({s.position})</option>)}</select></div><div><label className="text-xs text-gray-500">Type</label><select value={formData.type} onChange={e=>setFormData({...formData, type: e.target.value})} className="w-full border p-2 rounded"><option value="Permanent">Permanent</option><option value="Subcontract">Subcontract</option></select></div></div>
                            {formData.type === 'Subcontract' && <div><label className="text-xs text-gray-500">Company Name</label><input value={formData.company} onChange={e=>setFormData({...formData, company: e.target.value})} className="w-full border p-2 rounded" placeholder="Subcontractor Company..."/></div>}
                            </>) : (<div className="space-y-4">
                                <div className="grid grid-cols-2 gap-4 bg-blue-50 p-3 rounded-lg border border-blue-100"><div className="col-span-2"><label className="text-xs text-gray-500 flex items-center justify-between">Phone Number <label className="flex items-center gap-1 cursor-pointer"><input type="checkbox" checked={formData.showPhone} onChange={e=>setFormData({...formData, showPhone: e.target.checked})}/><span className="text-[10px]">Show on card</span></label></label><input type="tel" value={formData.phone} onChange={e=>setFormData({...formData, phone: e.target.value})} className="w-full border p-2 rounded text-sm" placeholder="0xx-xxx-xxxx"/></div><div><label className="text-xs text-gray-500">Start Date</label><input type="date" value={formData.startDate} onChange={e=>setFormData({...formData, startDate: e.target.value})} className="w-full border p-2 rounded text-sm"/></div><div className="flex flex-col justify-end"><div className="text-xs text-gray-500 mb-1">Tenure</div><div className="bg-white border px-2 py-2 rounded text-sm font-bold text-green-700 h-[38px] flex items-center">{tenureText || '-'}</div></div></div>
                                <div><label className="text-xs text-gray-500 mb-2 block">Card Color Override</label><div className="grid grid-cols-5 gap-2"><button type="button" onClick={()=>setFormData({...formData, customColor: ''})} className={`h-8 rounded-lg border bg-white text-xs ${formData.customColor===''?'ring-2 ring-blue-500':''}`}>None</button>{Object.entries(THEMES).map(([k,t]) => (<button type="button" key={k} onClick={()=>setFormData({...formData, customColor: k})} className={`h-8 rounded-lg ${t.lv0} ${formData.customColor===k?'ring-2 ring-blue-500':''}`}></button>))}</div></div>
                                <div><label className="text-xs text-gray-500 mb-2 block">Shape Override</label><div className="flex flex-wrap gap-2"><button type="button" onClick={()=>setFormData({...formData, customShape: ''})} className={`px-3 py-1 border rounded bg-white text-xs ${formData.customShape===''?'bg-gray-200':''}`}>Default</button>{Object.entries(SHAPES).map(([k,s]) => (<button type="button" key={k} onClick={()=>setFormData({...formData, customShape: k})} className={`px-3 py-1 border text-xs ${s.cls} ${formData.customShape===k?'bg-blue-100 border-blue-500':''}`}>{s.name}</button>))}</div></div>
                                <div><label className="text-xs text-gray-500">Employee Status</label><select value={formData.status} onChange={e=>setFormData({...formData, status: e.target.value})} className="w-full border p-2 rounded"><option value="Active">Active</option><option value="Resigned">Resigned</option></select></div>
                            </div>)}
                        </form>
                        <div className="bg-gray-50 px-6 py-4 border-t flex justify-between">{isEditMode && currentUser?.role!=='leader' && (!showDeleteConfirm ? <Button variant="danger" onClick={()=>setShowDeleteConfirm(true)} icon={Icons.Trash2}>Delete</Button> : <div className="flex gap-2"><Button variant="danger" onClick={()=>onDelete(formData.id)}>Confirm</Button><Button variant="secondary" onClick={()=>setShowDeleteConfirm(false)}>No</Button></div>)}{!showDeleteConfirm && <div className="flex gap-2 ml-auto"><Button variant="secondary" onClick={onCancel}>Cancel</Button><Button variant="primary" onClick={()=>onSave(formData)}>Save</Button></div>}</div>
                    </div>
                </div>
            );
        };

        const DraggableLogo = ({ logo, setLogo, isLocked }) => { const elementRef = useRef(null); if (!logo.url) return null;
            const handleMouseDown = (e) => { if (isLocked) return; e.preventDefault(); const element = elementRef.current; const startX = e.clientX - logo.x; const startY = e.clientY - logo.y; const onMouseMove = (moveEvent) => { if (element) { element.style.left = `${moveEvent.clientX - startX}px`; element.style.top = `${moveEvent.clientY - startY}px`; } }; const onMouseUp = (upEvent) => { document.removeEventListener("mousemove", onMouseMove); document.removeEventListener("mouseup", onMouseUp); setLogo(prev => ({ ...prev, x: upEvent.clientX - startX, y: upEvent.clientY - startY })); }; document.addEventListener("mousemove", onMouseMove); document.addEventListener("mouseup", onMouseUp); };
            return ( <div ref={elementRef} className={`absolute z-30 group draggable-element ${!isLocked ? 'cursor-move hover:ring-2 hover:ring-blue-400' : ''}`} style={{ left: logo.x, top: logo.y, width: logo.width || 150 }} onMouseDown={handleMouseDown}> <img src={logo.url} className="w-full h-auto object-contain pointer-events-none" /> {!isLocked && <button onClick={() => setLogo({ url: null, x: 50, y: 50 })} className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity shadow-sm"><Icons.X size={12}/></button>} </div> );
        };
        const DraggableAnnotation = ({ ann, onUpdate, onDelete, isLocked, onLinkStart }) => { const elementRef = useRef(null);
            const handleMouseDown = (e) => { if (isLocked) return; e.stopPropagation(); const element = elementRef.current; const startX = e.clientX - ann.x; const startY = e.clientY - ann.y; const onMouseMove = (moveEvent) => { if (element) { element.style.left = `${moveEvent.clientX - startX}px`; element.style.top = `${moveEvent.clientY - startY}px`; } }; const onMouseUp = (upEvent) => { document.removeEventListener("mousemove", onMouseMove); document.removeEventListener("mouseup", onMouseUp); onUpdate(ann.id, { x: upEvent.clientX - startX, y: upEvent.clientY - startY }); }; document.addEventListener("mousemove", onMouseMove); document.addEventListener("mouseup", onMouseUp); };
            return ( <div ref={elementRef} className={`absolute z-30 draggable-element group p-3 rounded shadow-md border min-w-[150px] ${!isLocked ? 'cursor-move hover:ring-2 hover:ring-blue-300' : ''}`} style={{ left: ann.x, top: ann.y, backgroundColor: ann.bg || '#ffffff', color: ann.color || '#000' }} onMouseDown={handleMouseDown}> {!isLocked ? ( <textarea value={ann.text} onChange={(e)=>onUpdate(ann.id, {text: e.target.value})} className="w-full bg-transparent outline-none resize-none overflow-hidden text-center" style={{fontSize: '14px'}} placeholder="Type here..."/> ) : ( <div className="text-center whitespace-pre-wrap">{ann.text}</div> )} {!isLocked && (<div className="absolute -top-3 -right-3 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity"><button onClick={(e)=>{e.stopPropagation(); onLinkStart(ann.id);}} className="bg-blue-500 text-white p-1 rounded-full shadow" title="Link to Node"><Icons.Link size={10}/></button><button onClick={(e)=>{e.stopPropagation(); onDelete(ann.id);}} className="bg-red-500 text-white p-1 rounded-full shadow"><Icons.X size={10}/></button></div>)} {!isLocked && (<div className="absolute -bottom-8 left-0 right-0 flex justify-center gap-1 opacity-0 group-hover:opacity-100 bg-white/90 p-1 rounded shadow text-xs"><input type="color" value={ann.bg||'#ffffff'} onChange={(e)=>onUpdate(ann.id, {bg: e.target.value})} title="Background" className="w-4 h-4"/><input type="color" value={ann.color||'#000000'} onChange={(e)=>onUpdate(ann.id, {color: e.target.value})} title="Text Color" className="w-4 h-4"/></div>)} </div> );
        };
        const Ruler = ({ orientation = 'horizontal', length = 3000 }) => { const pxPerMm = 3.7795; const paperSizes = [ { name: 'A4', w: 210, h: 297 }, { name: 'A3', w: 297, h: 420 }, { name: 'A2', w: 420, h: 594 }, { name: 'A1', w: 594, h: 841 }, { name: 'A0', w: 841, h: 1189 } ];
            const ticks = []; for (let i = 0; i <= length / pxPerMm; i += 10) { ticks.push( <div key={i} className="absolute bg-gray-400" style={orientation==='horizontal'?{left:`${i*pxPerMm}px`,height:'6px',width:'1px',bottom:0}:{top:`${i*pxPerMm}px`,width:'6px',height:'1px',right:0}}> <span className="absolute text-[8px] text-gray-500 font-mono" style={orientation==='horizontal'?{left:'2px',bottom:'8px'}:{top:'2px',right:'8px'}}>{i}</span> </div> ); } const markers = []; paperSizes.forEach(size => { if (orientation === 'horizontal') { markers.push(<div key={`w-${size.name}`} className="paper-marker" style={{left: `${size.h * pxPerMm}px`, top: '2px'}}>{size.name}</div>); markers.push(<div key={`l-${size.name}`} className="paper-line" style={{left: `${size.h * pxPerMm}px`, height: '2000px', top: '30px', width: '0px'}}></div>); } else { markers.push(<div key={`h-${size.name}`} className="paper-marker" style={{top: `${size.w * pxPerMm}px`, left: '2px', transform: 'rotate(-90deg)'}}>{size.name}</div>); markers.push(<div key={`vl-${size.name}`} className="paper-line" style={{top: `${size.w * pxPerMm}px`, width: '2000px', left: '30px', height: '0px'}}></div>); } });
            return ( <div className={`ruler-container ${orientation==='horizontal'?'ruler-h':'ruler-v'}`} style={{position: 'absolute'}}> <div className="relative w-full h-full"> {ticks} {markers} </div> </div> ); };
        
        // [FIXED] SummaryDashboard with Department Updates
        const SummaryDashboard = ({ employees, onClose, departments }) => { 
            const [activeTab, setActiveTab] = useState('Overview');
            
            const stats = useMemo(() => {
                try {
                    const safeEmps = Array.isArray(employees) ? employees : [];
                    const targetEmps = activeTab === 'Overview' ? safeEmps : safeEmps.filter(e => e.dept === activeTab);
                    
                    const total = targetEmps.length;
                    const byType = { Permanent: 0, Subcontract: 0 };
                    const byPosition = {};
                    let totalYears = 0; let countTenure = 0;
                    
                    // [V11] Ops Counters
                    let opsSub = 0;
                    let opsPerm = 0;

                    targetEmps.forEach(e => {
                        if (e.type === 'Permanent') byType.Permanent++; 
                        else byType.Subcontract++;

                        const pos = e.position || "Unknown";
                        byPosition[pos] = (byPosition[pos] || 0) + 1;
                        
                        // [V11] Calculate Operational Ratio (Rank < 3)
                        const rank = getPositionRank(e.position);
                        if (rank < 3) { 
                            if (e.type === 'Subcontract') opsSub++;
                            else opsPerm++;
                        }

                        if (e.startDate) {
                            const start = new Date(e.startDate);
                            if (!isNaN(start.getTime())) {
                                const now = new Date();
                                const diffTime = Math.abs(now - start);
                                const diffYears = diffTime / (1000 * 60 * 60 * 24 * 365);
                                totalYears += diffYears;
                                countTenure++;
                            }
                        }
                    });

                    const avgTenure = countTenure > 0 ? (totalYears / countTenure).toFixed(1) : 0;
                    
                    // [V11] Ratio Formatting
                    const totalOps = opsSub + opsPerm;
                    const opsRatioText = totalOps > 0 
                        ? `${Math.round((opsSub / totalOps) * 100)}% (${opsSub} : ${opsPerm})` 
                        : "No Data";

                    return { total, byType, byPosition, avgTenure, opsRatioText };
                } catch (error) {
                    console.error("Dashboard calculation error:", error);
                    return { total: 0, byType: {Permanent:0, Subcontract:0}, byPosition: {}, avgTenure: 0, opsRatioText: "-" };
                }
            }, [employees, activeTab]);

            // [V12 FIX] Filter out ghost departments
            const deptUpdates = useMemo(() => {
                const updates = {};
                // Initialize only valid departments
                departments.forEach(d => updates[d] = null);
                
                (employees || []).forEach(e => {
                    // Check if department is valid before updating timestamp
                    if (e.dept && e.lastModified && updates.hasOwnProperty(e.dept)) {
                        const t = new Date(e.lastModified).getTime();
                        if (!updates[e.dept] || t > updates[e.dept]) {
                            updates[e.dept] = t;
                        }
                    }
                });
                return updates;
            }, [employees, departments]);

            return ( 
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[80] animate-in fade-in"> 
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col overflow-hidden"> 
                        <div className="flex justify-between items-center p-6 border-b bg-gray-50"><h2 className="text-2xl font-bold text-gray-800 flex items-center"><Icons.Chart className="mr-2 text-blue-600"/> Dashboard</h2><button onClick={onClose} className="p-2 hover:bg-gray-200 rounded-full"><Icons.X/></button></div>
                        <div className="flex overflow-x-auto p-4 gap-2 border-b bg-white"><button onClick={()=>setActiveTab('Overview')} className={`px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap ${activeTab==='Overview'?'bg-blue-600 text-white':'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}>Overview</button>{departments.map(d => (<button key={d} onClick={()=>setActiveTab(d)} className={`px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap ${activeTab===d?'bg-blue-600 text-white':'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}>{d}</button>))}</div>
                        <div className="p-6 overflow-y-auto bg-gray-50 flex-1">
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6"> 
                                <div className="bg-white p-5 rounded-xl shadow-sm border-l-4 border-blue-500"><h3 className="text-gray-500 text-xs font-bold uppercase">Total Employees</h3><p className="text-4xl font-bold text-gray-800 mt-2">{stats.total}</p></div> 
                                <div className="bg-white p-5 rounded-xl shadow-sm border-l-4 border-green-500"><h3 className="text-gray-500 text-xs font-bold uppercase">Permanent</h3><p className="text-4xl font-bold text-gray-800 mt-2">{stats.byType.Permanent}</p></div> 
                                <div className="bg-white p-5 rounded-xl shadow-sm border-l-4 border-orange-500"><h3 className="text-gray-500 text-xs font-bold uppercase">Subcontract</h3><p className="text-4xl font-bold text-gray-800 mt-2">{stats.byType.Subcontract}</p></div> 
                                <div className="bg-white p-5 rounded-xl shadow-sm border-l-4 border-purple-500"><h3 className="text-gray-500 text-xs font-bold uppercase">Avg Tenure (Years)</h3><p className="text-4xl font-bold text-gray-800 mt-2">{stats.avgTenure}</p></div> 
                                
                                {/* [V11] New Operational Ratio Card */}
                                <div className="bg-white p-5 rounded-xl shadow-sm border-l-4 border-purple-500 relative group md:col-span-2 lg:col-span-4 xl:col-span-1">
                                    <h3 className="text-gray-500 text-xs font-bold uppercase flex items-center gap-1">Ops. Sub Ratio <Icons.Alert size={10} className="text-gray-400"/></h3>
                                    <p className="text-4xl font-bold text-gray-800 mt-2">{stats.opsRatioText}</p>
                                    <div className="absolute top-full left-0 mt-1 hidden group-hover:block bg-black text-white text-[10px] p-2 rounded w-48 z-10 shadow-lg">
                                        * ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô Subcontract ‡πÉ‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£ (‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏° Engineer, Supervisor, Manager)
                                    </div>
                                </div>
                            </div> 
                            
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <div className="bg-white rounded-xl shadow-sm p-6 border">
                                    <h3 className="font-bold text-gray-800 mb-4 border-b pb-2">Position Breakdown ({activeTab})</h3>
                                    <div className="space-y-4 max-h-60 overflow-y-auto pr-2">{Object.entries(stats.byPosition).sort((a,b)=>b[1]-a[1]).map(([pos, count]) => (<div key={pos} className="flex items-center group"><div className="w-40 text-sm font-medium text-gray-600 truncate pr-2 group-hover:text-blue-600">{pos}</div><div className="flex-1 bg-gray-100 rounded-full h-3 overflow-hidden"><div className="bg-blue-500 h-full rounded-full transition-all duration-500" style={{width: `${(count/stats.total)*100}%`}}></div></div><div className="w-12 text-right text-sm font-bold text-gray-800">{count}</div><div className="w-12 text-right text-xs text-gray-400">({Math.round((count/stats.total)*100)}%)</div></div>))}</div>
                                </div>
                                
                                {/* [NEW] Department Updates Table */}
                                <div className="bg-white rounded-xl shadow-sm p-6 border">
                                    <h3 className="font-bold text-gray-800 mb-4 border-b pb-2">Last Updates by Department</h3>
                                    <div className="space-y-2 max-h-60 overflow-y-auto">
                                        {Object.entries(deptUpdates).map(([dept, timestamp]) => (
                                            <div key={dept} className="flex justify-between items-center p-2 hover:bg-gray-50 rounded">
                                                <div className="font-medium text-sm text-gray-700">{dept}</div>
                                                <div className={`text-xs px-2 py-1 rounded-full ${timestamp ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-400'}`}>
                                                    {timestamp ? formatDateTime(new Date(timestamp).toISOString()) : 'No Data'}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div> 
                    </div> </div> 
            );
        };

        const ManagePositionsModal = ({ positions, onAdd, onDelete, onClose }) => { const [newPos, setNewPos] = useState("");
            return ( <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[70]"> <div className="bg-white rounded-xl shadow-xl p-6 w-full max-w-sm"> <div className="flex justify-between items-center mb-4"><h3 className="font-bold flex items-center"><Icons.Briefcase className="mr-2"/> Manage Positions</h3><button onClick={onClose}><Icons.X/></button></div> <div className="flex gap-2 mb-4"><input value={newPos} onChange={e=>setNewPos(e.target.value)} placeholder="New Position..." className="flex-1 border p-2 rounded text-sm"/><button onClick={()=>{if(newPos){onAdd(newPos);setNewPos('');}}} className="bg-green-600 text-white p-2 rounded"><Icons.Plus/></button></div> <div className="max-h-60 overflow-y-auto space-y-2">{positions.map(p => (<div key={p} className="flex justify-between items-center p-2 bg-gray-50 rounded text-sm group"><span>{p}</span><button onClick={()=>onDelete(p)} className="text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100"><Icons.Trash2 size={16}/></button></div>))}</div> </div> </div> );
        };
        const LoginScreen = ({ onLogin, driveUrl, apiCall }) => { const [creds, setCreds] = useState({ username: '', password: '' });
            const [loading, setLoading] = useState(false); const handleSubmit = async (e) => { e.preventDefault(); setLoading(true);
            try { if (driveUrl) { const res = await apiCall(driveUrl, 'login', creds); if (res?.status === 'success') { onLogin(res.user); return; } } if (creds.username === 'admin' && creds.password === 'password') { onLogin({ username: 'admin', name: 'System Admin', role: 'admin' }); } else { alert("Login failed"); } } catch (err) { alert("Error"); } finally { setLoading(false); } };
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏° Reset Data ‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏•‡πà‡∏≤‡∏á
            return ( <div className="h-screen flex items-center justify-center bg-slate-900 px-4 relative"> <div className="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm"> <div className="flex flex-col items-center mb-8"> <div className="bg-red-600 p-3 rounded-xl text-white font-bold text-2xl mb-2">HR</div> <h1 className="text-xl font-bold text-gray-800">Organize System</h1> </div> <form onSubmit={handleSubmit} className="space-y-4"> <input type="text" placeholder="Username" className="w-full p-3 border rounded-lg" onChange={e => setCreds({...creds, username: e.target.value})} required /> <input type="password" placeholder="Password" className="w-full p-3 border rounded-lg" onChange={e => setCreds({...creds, password: e.target.value})} required /> <button type="submit" disabled={loading} className="w-full bg-blue-600 text-white p-3 rounded-lg font-bold hover:bg-blue-700 transition-colors"> {loading ? 'Logging in...' : 'Login'} </button> </form> </div> <button onClick={()=>{if(confirm('‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤?')) { localStorage.clear(); location.reload(); }}} className="absolute bottom-4 right-4 text-xs text-gray-500 hover:text-white underline">Reset Data (Emergency)</button> </div> );
        };

        // [New] Loading Overlay Component
        const LoadingScreen = () => (
            <div className="fixed inset-0 bg-white z-[100] flex flex-col items-center justify-center">
                <Icons.Loader size={48} className="text-blue-600 mb-4 animate-spin"/>
                <p className="text-gray-500 font-bold">Loading Organization Data...</p>
            </div>
        );

        // [NEW] Status Indicator Component
        const StatusIndicator = ({ status }) => {
            let color = "bg-gray-400";
            let text = "Unknown";
            let icon = <Icons.WifiOff size={14} className="text-gray-600"/>;

            if (status === 'online') { 
                color = "bg-green-500"; 
                text = "Online"; 
                icon = <Icons.Wifi size={14} className="text-green-600"/>;
            }
            else if (status === 'syncing') { 
                color = "bg-yellow-500"; 
                text = "Syncing"; 
                icon = <Icons.RefreshCw size={14} className="text-yellow-600 animate-spin"/>;
            }
            else if (status === 'offline') { 
                color = "bg-red-500"; 
                text = "Offline"; 
                icon = <Icons.WifiOff size={14} className="text-red-600"/>;
            }
            else if (status === 'error') { 
                color = "bg-red-600"; 
                text = "Error"; 
                icon = <Icons.Alert size={14} className="text-red-600"/>;
            }

            return (
                <div className="flex items-center gap-2 px-3 py-1.5 bg-white rounded-full shadow-sm border border-gray-200" title={`Connection Status: ${text}`}>
                    {icon}
                    <span className={`w-2 h-2 rounded-full ${color}`}></span>
                    <span className="text-[10px] font-bold text-gray-500 uppercase tracking-wider hidden sm:inline-block">{text}</span>
                </div>
            );
        };

        const App = () => {
            // [FIXED] ‡πÉ‡∏ä‡πâ safeLocalLoad ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô JSON Parse Error (‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏´‡∏•‡∏±‡∏Å‡∏à‡∏≠‡∏Ç‡∏≤‡∏ß)
            const [currentUser, setCurrentUser] = useState(() => safeLocalLoad('currentUser', null));
            const [employees, setEmployees] = useState(() => safeLocalLoad('orgData', []));
            const [positions, setPositions] = useState(() => safeLocalLoad('orgPositions', ["Manager", "Supervisor", "Engineer", "Leader", "Operator"]));
            const [departments, setDepartments] = useState(() => safeLocalLoad('orgDepartments', ["ASSEMBLY", "QC", "HR"]));
            
            const [currentDept, setCurrentDept] = useState(departments[0] || "ASSEMBLY");
            const [driveUrl, setDriveUrl] = useState("https://script.google.com/macros/s/AKfycbxYxBWD4blG_bP9hdTm_W8RP9PtM9CLZovmSFQVVsQTcBl18uxcaAxrhW5lZKFmEj8H/exec");
            
            // [FIXED] ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ isDataReady ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô White Screen
            const [isDataReady, setIsDataReady] = useState(false);
            
            const [viewMode, setViewMode] = useState('chart'); 
            const [zoom, setZoom] = useState(1);
            const [searchTerm, setSearchTerm] = useState('');
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingEmployee, setEditingEmployee] = useState(null);
            const [selectionMode, setSelectionMode] = useState(false);
            const [selectedIds, setSelectedIds] = useState([]);
            const [cloudStatus, setCloudStatus] = useState('offline');
            const [isSidebarCollapsed, setIsSidebarCollapsed] = useState(false);
            const [isAdminPanelOpen, setIsAdminPanelOpen] = useState(false);
            const [isSummaryOpen, setIsSummaryOpen] = useState(false);
            const [appTheme, setAppTheme] = useState('blue');
            const [appShape, setAppShape] = useState(SHAPES.rounded);
            const [layoutThreshold, setLayoutThreshold] = useState(4);
            const [deptName, setDeptName] = useState(currentDept + " DEPT");
            const [isManageDeptsOpen, setIsManageDeptsOpen] = useState(false);
            const [isManagePositionsOpen, setIsManagePositionsOpen] = useState(false);
            const [logo, setLogo] = useState({ url: null, x: 50, y: 50 });
            const [annotations, setAnnotations] = useState([]);
            const [linkStartId, setLinkStartId] = useState(null);
            const [showRulers, setShowRulers] = useState(false);
            const [history, setHistory] = useState([]);
            const [historyIndex, setHistoryIndex] = useState(-1);
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);
            const [sidebarWidth, setSidebarWidth] = useState(256);
            const sidebarRef = useRef(null);
            const isResizing = useRef(false);
            const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
            const [sortConfig, setSortConfig] = useState({ key: null, direction: 'ascending' });

            const appApiCall = async (url, action, payload) => { try { const res = await fetch(url, { method: 'POST', body: JSON.stringify({ action, ...payload }) }); return await res.json(); } catch (e) { throw e; } };
            const syncUpdatesToCloud = async (updates = [], deletes = []) => { if (!driveUrl) return; setCloudStatus('syncing'); try { const res = await appApiCall(driveUrl, 'updateEmployees', { updates, deletes }); setCloudStatus(res?.status === 'success' ? 'online' : 'error'); } catch (e) { setCloudStatus('error'); } };
            
            // [FIXED] Logic ‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ‡∏£‡∏≠‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡πà‡∏≠‡∏¢‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏Å‡∏±‡∏ô‡∏à‡∏≠‡∏Ç‡∏≤‡∏ß)
            useEffect(() => { 
                if (currentUser) {
                    setIsDataReady(false); // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÇ‡∏´‡∏•‡∏î
                    
                    // 1. ‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å Local Storage ‡∏Å‡πà‡∏≠‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
                    const localData = safeLocalLoad('orgData', null);
                    if (localData && Array.isArray(localData)) {
                        setEmployees(localData);
                        setIsDataReady(true); // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Local ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
                    }

                    // 2. ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ Drive URL ‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å Cloud ‡∏°‡∏≤‡∏ó‡∏±‡∏ö
                    if (driveUrl) {
                        appApiCall(driveUrl, 'getData').then(res => { 
                            if (res?.status === 'success' && res.data) { 
                                if (res.data.orgData) setEmployees(res.data.orgData); 
                                if (res.data.orgPositions) setPositions(res.data.orgPositions); 
                                if (res.data.orgDepartments) setDepartments(res.data.orgDepartments); 
                                setCloudStatus('online'); 
                            }
                            setIsDataReady(true); // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Cloud ‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß
                        }).catch(() => {
                            setIsDataReady(true); // ‡∏ñ‡∏∂‡∏á Error ‡∏Å‡πá‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡∏î‡πâ‡∏ß‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤
                        });
                    } else {
                        setIsDataReady(true);
                    }
                }
            }, [driveUrl, currentUser]);

            useEffect(() => { localStorage.setItem('orgData', JSON.stringify(employees)); }, [employees]);
            useEffect(() => { setDeptName(currentDept + " DEPT"); }, [currentDept]);
            
            const pushToHistory = (newData) => { const newHistory = history.slice(0, historyIndex + 1); newHistory.push(newData); if (newHistory.length > 10) newHistory.shift(); setHistory(newHistory); setHistoryIndex(newHistory.length - 1); };
            const handleUndo = () => { if (historyIndex > 0) { const prevState = history[historyIndex - 1]; setEmployees(prevState); setHistoryIndex(prev => prev - 1); localStorage.setItem('orgData', JSON.stringify(prevState)); } };
            const updateStateFull = useCallback((newState, updates = [], deletes = []) => { 
                pushToHistory(employees); 
                // [NEW] Add Timestamps
                const timestamp = new Date().toISOString();
                const stampedUpdates = updates.map(u => ({ ...u, lastModified: timestamp }));
                
                const finalState = newState.map(e => {
                    const up = stampedUpdates.find(u => u.id === e.id);
                    return up ? up : e;
                });

                setEmployees(finalState); 
                if(stampedUpdates.length > 0 || deletes.length > 0) syncUpdatesToCloud(stampedUpdates, deletes); 
            }, [employees, driveUrl, history, historyIndex]);
            
            // [V15 NEW] Unified Admin Actions
            const handleAddDept = (dept) => {
                const newDepts = [...departments, dept];
                setDepartments(newDepts);
                localStorage.setItem('orgDepartments', JSON.stringify(newDepts));
                if(driveUrl) appApiCall(driveUrl, 'saveData', {orgDepartments: newDepts});
            };

            const handleDeleteDept = (dept) => {
                const newDepts = departments.filter(d => d !== dept);
                setDepartments(newDepts);
                localStorage.setItem('orgDepartments', JSON.stringify(newDepts));
                if(driveUrl) appApiCall(driveUrl, 'saveData', {orgDepartments: newDepts});
            };

            const handleReorder = useCallback((id, offset) => {
                const target = employees.find(e => e.id === id); if (!target) return;
                
                // [V8] Logic for Root Node Reordering (Swapping)
                if (!target.reportsTo || target.reportsTo === 'STAGING') {
                    // This is a root node (Department Head or Staging)
                    // Get all root nodes in the current view
                    const roots = employees
                        .filter(e => (!e.reportsTo || e.reportsTo === 'STAGING') && (currentDept === 'ALL' || e.dept === currentDept))
                        .sort((a, b) => (a.order || 0) - (b.order || 0));
                    
                    const currentIndex = roots.findIndex(e => e.id === id);
                    if (currentIndex === -1) return;

                    let newIndex = currentIndex + offset;
                    if (newIndex < 0) newIndex = 0;
                    if (newIndex >= roots.length) newIndex = roots.length - 1;
                    if (newIndex === currentIndex) return;

                    // Swap mechanism
                    const itemToMove = roots[currentIndex];
                    roots.splice(currentIndex, 1);
                    roots.splice(newIndex, 0, itemToMove);

                    // Re-assign order based on new array position
                    const updates = roots.map((root, index) => ({ ...root, order: index + 1 }));
                    
                    // Merge updates
                    const newData = employees.map(e => {
                        const updatedRoot = updates.find(u => u.id === e.id);
                        return updatedRoot ? updatedRoot : e;
                    });
                    
                    updateStateFull(newData, updates, []);
                    return;
                }

                // Normal sibling reordering
                const siblings = employees.filter(e => e.reportsTo === target.reportsTo).sort((a, b) => { const orderA = a.order || 0; const orderB = b.order || 0; if (orderA !== orderB) return orderA - orderB; return (a.id || "").localeCompare(b.id || ""); });
                const currentIndex = siblings.findIndex(e => e.id === id); if (currentIndex === -1) return;
                let newIndex = currentIndex + offset; if (newIndex < 0) newIndex = 0; if (newIndex >= siblings.length) newIndex = siblings.length - 1; if (newIndex === currentIndex) return;
                const itemToMove = siblings[currentIndex]; siblings.splice(currentIndex, 1); siblings.splice(newIndex, 0, itemToMove);
                const updates = siblings.map((sib, index) => ({ ...sib, order: index + 1 }));
                const newData = employees.map(e => { const updatedSibling = updates.find(u => u.id === e.id); return updatedSibling ? updatedSibling : e; });
                updateStateFull(newData, updates, []);
            }, [employees, updateStateFull, currentDept]);

            // [V8] Grid Column Cycler (+/-)
            const handleGridColChange = useCallback((id, delta) => {
                const target = employees.find(e => e.id === id);
                if (!target) return;
                
                const current = target.gridCols ? parseInt(target.gridCols) : 0; // 0 or NaN = Auto
                let nextVal = current === 0 ? 4 : current; // Default starting point if Auto
                
                if (current === 0 && delta > 0) nextVal = 2; // From Auto to 2
                else if (current === 0 && delta < 0) nextVal = 6; // From Auto back to 6? Or stay auto? Let's say Auto -> 6
                else {
                    nextVal += delta;
                }

                // Limits
                if (nextVal > 6) nextVal = 0; // Loop back to Auto
                if (nextVal < 2 && nextVal !== 0) nextVal = 0; // Loop to Auto

                const updatedEmp = { ...target, gridCols: nextVal === 0 ? '' : nextVal.toString() };
                const newData = employees.map(e => e.id === id ? updatedEmp : e);
                
                // Save immediately
                updateStateFull(newData, [updatedEmp], []);
            }, [employees, updateStateFull]);

            // [V8] Updated Drop Logic for Root Swapping
            const handleDropNode = useCallback((sourceIds, targetId) => {
                const targetNode = employees.find(e => e.id === targetId);
                const sourceNode = employees.find(e => e.id === sourceIds[0]); // Handle first item for logic check

                // Check if dragging a Root onto another Root (Swap)
                const isTargetRoot = targetNode && (!targetNode.reportsTo || targetNode.reportsTo === 'STAGING');
                const isSourceRoot = sourceNode && (!sourceNode.reportsTo || sourceNode.reportsTo === 'STAGING');

                if (isTargetRoot && isSourceRoot && sourceIds.length === 1) {
                    // Logic to swap roots by re-ordering list
                    // Similar to handleReorder but by target ID
                    const roots = employees
                        .filter(e => (!e.reportsTo || e.reportsTo === 'STAGING') && (currentDept === 'ALL' || e.dept === currentDept))
                        .sort((a, b) => (a.order || 0) - (b.order || 0));
                    
                    const sourceIndex = roots.findIndex(e => e.id === sourceNode.id);
                    const targetIndex = roots.findIndex(e => e.id === targetNode.id);

                    if (sourceIndex === -1 || targetIndex === -1) return;

                    // Move item
                    roots.splice(sourceIndex, 1);
                    roots.splice(targetIndex, 0, sourceNode);

                    // Re-index all
                    const updates = roots.map((root, index) => ({ ...root, order: index + 1 }));
                    
                    // Merge updates
                    const newData = employees.map(e => {
                        const updatedRoot = updates.find(u => u.id === e.id);
                        return updatedRoot ? updatedRoot : e;
                    });
                    
                    updateStateFull(newData, updates, []);

                } else {
                    // Standard: Reparent
                    const updates = []; 
                    const newData = employees.map(e => { 
                        if(sourceIds.includes(e.id)) { 
                            const u = {...e, reportsTo: targetId}; 
                            updates.push(u); 
                            return u; 
                        } 
                        return e; 
                    }); 
                    updateStateFull(newData, updates, []);
                }
            }, [employees, updateStateFull, currentDept]);

            const resize = useCallback((e) => { if (isResizing.current) { let w = e.clientX; if (w > 150 && w < 500) setSidebarWidth(w); } }, []);
            const stopResizing = useCallback(() => { isResizing.current = false; }, []);
            useEffect(() => { window.addEventListener("mousemove", resize); window.addEventListener("mouseup", stopResizing); return () => { window.removeEventListener("mousemove", resize); window.removeEventListener("mouseup", stopResizing); }; }, [resize, stopResizing]);
            
            // [V13] Updated handleTransfer to handle dept validation
            const handleTransferToDept = (targetDept) => { if(selectedIds.length === 0) return; const updates = []; const newData = employees.map(e => { if (selectedIds.includes(e.id)) { const u = { ...e, dept: targetDept, reportsTo: 'STAGING' }; updates.push(u); return u; } return e; }); updateStateFull(newData, updates, []); setSelectedIds([]); setSelectionMode(false); alert(`Moved ${updates.length} employees to ${targetDept} (Waiting Area)`); };

            const requestSort = (key) => {
                let direction = 'ascending';
                if (sortConfig.key === key && sortConfig.direction === 'ascending') { direction = 'descending'; }
                setSortConfig({ key, direction });
            };

            const exportCSV = () => {
                const headers = ["ID", "Name", "Department", "Position", "Type", "Status", "Phone", "Start Date", "Company"];
                const csvRows = [headers.join(",")];
                processedEmployees.forEach(e => {
                    const row = [e.id, `"${e.name}"`, e.dept, e.position, e.type, e.status, `"${e.phone||''}"`, e.startDate, `"${e.company||''}"`];
                    csvRows.push(row.join(","));
                });
                const blob = new Blob([csvRows.join("\n")], { type: "text/csv" });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.setAttribute("hidden", "");
                a.setAttribute("href", url);
                a.setAttribute("download", `employees_${currentDept}_${new Date().toISOString().slice(0,10)}.csv`);
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            };

            // *** FIXED ZONE: ALL HOOKS ARE ABOVE THIS LINE ***

            const validEmployees = employees.filter(e => e.id);
            const stagingEmployees = validEmployees.filter(e => e.reportsTo === 'STAGING' && (currentDept === 'ALL' || e.dept === currentDept) && (!searchTerm || e.name.toLowerCase().includes(searchTerm.toLowerCase())));
            const filteredAll = validEmployees.filter(e => e.reportsTo !== 'STAGING' && (currentDept === 'ALL' || e.dept === currentDept));
            // [V9 Fix] Sort root nodes by order!
            const rootEmployees = filteredAll
                .filter(e => { const boss = filteredAll.find(b => b.id === e.reportsTo); return !boss; })
                .sort((a, b) => (a.order || 0) - (b.order || 0));

            const isLocked = currentUser?.role !== 'admin' && currentUser?.role !== 'supervisor';

            const processedEmployees = useMemo(() => {
                let data = [...validEmployees];
                if (currentDept !== 'ALL') data = data.filter(e => e.dept === currentDept);
                if (searchTerm) {
                    const lower = searchTerm.toLowerCase();
                    data = data.filter(e => 
                        (e.name || "").toLowerCase().includes(lower) ||
                        (e.id || "").toLowerCase().includes(lower) ||
                        (e.position || "").toLowerCase().includes(lower) ||
                        (e.dept || "").toLowerCase().includes(lower) ||
                        (e.company || "").toLowerCase().includes(lower)
                    );
                }
                if (sortConfig.key) {
                    data.sort((a, b) => {
                        let aVal = a[sortConfig.key] || "";
                        let bVal = b[sortConfig.key] || "";
                        if (aVal < bVal) return sortConfig.direction === 'ascending' ? -1 : 1;
                        if (aVal > bVal) return sortConfig.direction === 'ascending' ? 1 : -1;
                        return 0;
                    });
                }
                return data;
            }, [validEmployees, currentDept, searchTerm, sortConfig]);

            // *** NOW IT IS SAFE TO RETURN ***
            
            if (!currentUser) return <LoginScreen onLogin={(u)=>{setCurrentUser(u); localStorage.setItem('currentUser', JSON.stringify(u));}} driveUrl={driveUrl} apiCall={appApiCall} />;
            
            if (!isDataReady) return <LoadingScreen />;

            return (
                <div className="flex flex-col h-full bg-gray-50">
                    <nav className="bg-white shadow-sm border-b sticky top-0 z-40 h-14 flex items-center px-4 justify-between shrink-0">
                        <div className="flex items-center gap-4">
                            <button onClick={()=>setIsMobileMenuOpen(true)} className="lg:hidden p-2 text-gray-600"><Icons.Menu/></button>
                            <div className="bg-red-600 p-1 rounded text-white font-bold hidden sm:block">HR</div>
                            
                            <select value={currentDept} onChange={e=>setCurrentDept(e.target.value)} className="font-bold text-sm border-none bg-blue-50 rounded px-2 py-1 outline-none cursor-pointer hover:bg-blue-100 transition-colors">{departments.map(d => <option key={d} value={d}>{d}</option>)}<option value="ALL">ALL DEPTS</option></select>
                            
                            {/* Status Indicator */}
                            <StatusIndicator status={cloudStatus} />

                        </div>
                        <div className="hidden lg:flex items-center gap-3">
                            <div className="hidden sm:flex items-center bg-gray-100 rounded-full px-3 py-1"><Icons.Search size={14} className="text-gray-400"/><input value={searchTerm} onChange={e=>setSearchTerm(e.target.value)} placeholder="Search..." className="bg-transparent border-none text-xs ml-2 w-24 outline-none"/></div>
                            <div className="flex bg-gray-100 rounded-lg p-1 gap-1">
                                <button onClick={()=>setViewMode('chart')} className={`p-1 rounded ${viewMode==='chart'?'bg-white shadow-sm text-blue-600':'text-gray-500'}`}><Icons.Grid size={16}/></button>
                                <button onClick={()=>setViewMode('list')} className={`p-1 rounded ${viewMode==='list'?'bg-white shadow-sm text-blue-600':'text-gray-500'}`}><Icons.List size={16}/></button>
                            </div>
                            {!isLocked && <button onClick={()=>{setSelectionMode(!selectionMode); setSelectedIds([]);}} className={`p-1.5 rounded border ${selectionMode?'bg-purple-600 text-white':'text-gray-600'}`}><Icons.CheckSquare size={18}/></button>}
                            <button onClick={()=>setIsSummaryOpen(true)} className="p-2 text-blue-600"><Icons.Chart size={20}/></button>
                            <button onClick={()=>setShowRulers(!showRulers)} className={`p-2 rounded-full ${showRulers ? 'bg-blue-50 text-blue-600' : 'text-gray-600'}`}><Icons.RulerIcon size={20}/></button>
                            
                            {/* Admin Panel Button Only */}
                            {currentUser.role === 'admin' && <button onClick={()=>setIsAdminPanelOpen(true)} className="p-2 text-gray-700 hover:text-gray-900" title="Admin Panel"><Icons.Settings size={20}/></button>}
                            
                            <button onClick={()=>{localStorage.removeItem('currentUser'); setCurrentUser(null);}} className="text-red-500 p-2"><Icons.LogOut size={20}/></button>
                        </div>
                    </nav>

                    {isMobileMenuOpen && ( <div className="fixed inset-0 z-[110] lg:hidden"> <div className="absolute inset-0 bg-black/50" onClick={()=>setIsMobileMenuOpen(false)}></div> <div className="absolute left-0 top-0 h-full w-64 bg-white shadow-xl flex flex-col p-4 animate-in slide-in-from-left duration-200"> <div className="flex justify-between items-center mb-6 border-b pb-2"><span className="font-bold">‡πÄ‡∏°‡∏ô‡∏π‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</span><button onClick={()=>setIsMobileMenuOpen(false)}><Icons.X/></button></div> <div className="flex flex-col gap-4 overflow-y-auto"> <button onClick={()=>{setViewMode('chart'); setIsMobileMenuOpen(false);}} className="flex items-center gap-3 p-2 hover:bg-gray-100 rounded"><Icons.Grid/> ‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏ú‡∏±‡∏á</button> <button onClick={()=>{setViewMode('list'); setIsMobileMenuOpen(false);}} className="flex items-center gap-3 p-2 hover:bg-gray-100 rounded"><Icons.List/> ‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á</button> {!isLocked && <button onClick={()=>{setEditingEmployee({isNew:true, reportsTo: 'STAGING', dept: currentDept}); setIsModalOpen(true); setIsMobileMenuOpen(false);}} className="flex items-center gap-3 p-2 bg-blue-50 text-blue-600 rounded font-bold">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</button>} <button onClick={()=>{setIsSummaryOpen(true); setIsMobileMenuOpen(false);}} className="flex items-center gap-3 p-2 hover:bg-gray-100 rounded"><Icons.Chart/> ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏™‡∏£‡∏∏‡∏õ</button> <button onClick={()=>{setShowRulers(!showRulers); setIsMobileMenuOpen(false);}} className="flex items-center gap-3 p-2 hover:bg-gray-100 rounded"><Icons.RulerIcon/> {showRulers?'‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏°‡πâ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î':'‡πÅ‡∏™‡∏î‡∏á‡πÑ‡∏°‡πâ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î'}</button> <button onClick={()=>{localStorage.removeItem('currentUser'); setCurrentUser(null);}} className="flex items-center gap-3 p-2 text-red-600 hover:bg-red-50 mt-auto border-t"><Icons.LogOut/> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button> </div> </div> </div> )}

                    <div className="flex flex-1 overflow-hidden relative">
                        {viewMode === 'chart' && (
                            <>
                            <aside ref={sidebarRef} className={`fixed inset-y-0 left-0 z-40 bg-white border-r transform transition-transform duration-300 pt-14 lg:pt-0 ${isSidebarOpen?'translate-x-0':'-translate-x-full'} ${isSidebarCollapsed?'w-0 overflow-hidden':''} lg:relative lg:translate-x-0`} style={{ width: isSidebarCollapsed?'0px':(window.innerWidth>1024?`${sidebarWidth}px`:'16rem') }}>
                                <div className="p-4 flex justify-between items-center shrink-0">
                                    <h2 className="font-bold text-xs text-gray-400 uppercase">Waiting Area ({stagingEmployees.length})</h2>
                                    {!isLocked && <button onClick={()=>{setEditingEmployee({isNew:true, reportsTo:'STAGING', dept: currentDept}); setIsModalOpen(true);}}><Icons.Plus size={18} className="text-blue-600"/></button>}
                                    <button onClick={()=>setIsSidebarOpen(false)} className="lg:hidden text-gray-400 hover:text-red-500"><Icons.X size={18}/></button>
                                </div>
                                <div className="flex-1 overflow-y-auto px-4 space-y-3 pb-20">
                                    {stagingEmployees.map(emp => <EmployeeCard key={emp.id} employee={emp} onClick={()=> {setEditingEmployee({...emp, isNew:false}); setIsModalOpen(true);}} onDragStart={(e,id)=>e.dataTransfer.setData("empIds", JSON.stringify([id]))} isStaging={true} isLocked={isLocked} selectionMode={selectionMode} isSelected={selectedIds.includes(emp.id)} toggleSelection={(id)=>setSelectedIds(prev=>prev.includes(id)?prev.filter(x=>x!==id):[...prev, id])}/>)}
                                </div>
                                <div className="sidebar-resizer hidden lg:block" onMouseDown={()=>isResizing.current=true}></div>
                                <button className="sidebar-toggle-btn hidden lg:flex" style={{right: '-12px', borderRadius: '50%'}} onClick={()=>setIsSidebarCollapsed(true)}><Icons.ChevronLeft size={14}/></button>
                            </aside>
                            {isSidebarCollapsed && <button className="sidebar-toggle-btn hidden lg:flex" style={{left: '0', borderTopRightRadius: '8px', borderBottomRightRadius: '8px'}} onClick={()=>setIsSidebarCollapsed(false)}><Icons.ChevronRight size={18}/></button>}
                            </>
                        )}

                        <main className="flex-1 bg-gray-100 overflow-auto relative p-8">
                            {showRulers && viewMode === 'chart' && <><Ruler orientation="horizontal" length={3000} /><Ruler orientation="vertical" length={2000} /></>}
                            {viewMode === 'chart' ? (
                                <div className="flex flex-col items-center min-w-max" style={{ transform: `scale(${zoom})`, transformOrigin: 'top center' }}>
                                    <DraggableLogo logo={logo} setLogo={setLogo} isLocked={isLocked} />
                                    {annotations.map(ann => <DraggableAnnotation key={ann.id} ann={ann} onUpdate={(id, up) => setAnnotations(prev=>prev.map(a=>a.id===id?{...a,...up}:a))} onDelete={(id)=>setAnnotations(prev=>prev.filter(a=>a.id!==id))} isLocked={isLocked} onLinkStart={setLinkStartId} />)}
                                    <div id="org-chart-full-view" className="bg-white p-8 rounded-2xl border shadow-xl inline-block min-w-[800px] org-chart-container relative">
                                        <div className="mb-8 border-b-2 pb-2"><h1 className="text-3xl font-bold text-gray-800 uppercase">{deptName}</h1></div>
                                        <div className="flex gap-16 justify-center">
                                            {rootEmployees.map(root => <EmployeeNode key={root.id} employee={root} allEmployees={filteredAll} onEdit={(e)=>{setEditingEmployee({...e, isNew:false}); setIsModalOpen(true);}} onDrop={handleDropNode} isLocked={isLocked} themeConf={THEMES[appTheme]} shapeClass={appShape} selectionMode={selectionMode} selectedIds={selectedIds} toggleSelection={(id)=>setSelectedIds(prev=>prev.includes(id)?prev.filter(x=>x!==id):[...prev, id])} onAddChild={(p)=>{setEditingEmployee({isNew:true, reportsTo:p.id, dept:p.dept}); setIsModalOpen(true);}} layoutThreshold={layoutThreshold} searchTerm={searchTerm} onReorder={handleReorder} onGridColChange={handleGridColChange}/>)}
                                        </div>
                                    </div>
                                </div>
                            ) : (
                                <div className="flex flex-col h-full bg-white rounded-xl shadow-sm border overflow-hidden">
                                    <div className="p-4 border-b flex justify-between items-center bg-gray-50">
                                        <div className="text-sm font-bold text-gray-500">Showing {processedEmployees.length} employees</div>
                                        <button onClick={exportCSV} className="flex items-center gap-2 bg-green-600 text-white px-3 py-1.5 rounded-lg text-sm hover:bg-green-700 shadow-sm"><Icons.FileSpreadsheet size={16}/> Export CSV</button>
                                    </div>
                                    <div className="overflow-auto flex-1">
                                        <table className="min-w-full divide-y">
                                            <thead className="bg-gray-100 sticky top-0 z-10 shadow-sm">
                                                <tr>
                                                    {['ID','Name','Dept','Position','Type','Status','Phone','Start Date','Company'].map(h => (
                                                        <th key={h} className="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider hover:bg-gray-200 transition-colors" onClick={()=>requestSort(h==='ID'?'id':h==='Name'?'name':h==='Dept'?'dept':h==='Position'?'position':h==='Type'?'type':h==='Status'?'status':h==='Phone'?'phone':h==='Start Date'?'startDate':'company')}>
                                                            <div className="flex items-center">{h} <Icons.Sort size={12} className="ml-1 opacity-50"/></div>
                                                        </th>
                                                    ))}
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y bg-white">
                                                {processedEmployees.map(emp => (
                                                    <tr key={emp.id} className="hover:bg-blue-50 cursor-pointer transition-colors" onClick={()=>{setEditingEmployee({...emp, isNew:false}); setIsModalOpen(true);}}>
                                                        <td className="px-4 py-3 text-sm font-mono text-gray-500">{emp.id}</td>
                                                        <td className="px-4 py-3 text-sm font-medium text-gray-900 flex items-center gap-2"><img src={formatDriveUrl(emp.image)} className="w-6 h-6 rounded-full bg-gray-200"/>{emp.name}</td>
                                                        <td className="px-4 py-3 text-sm text-gray-600"><span className="px-2 py-0.5 rounded-full bg-gray-100 text-xs">{emp.dept}</span></td>
                                                        <td className="px-4 py-3 text-sm text-gray-600">{emp.position}</td>
                                                        <td className="px-4 py-3 text-sm"><span className={`px-2 py-1 rounded-full text-xs font-bold ${emp.type==='Permanent'?'bg-green-100 text-green-800':'bg-orange-100 text-orange-800'}`}>{emp.type}</span></td>
                                                        <td className="px-4 py-3 text-sm"><span className={`w-2 h-2 rounded-full inline-block mr-2 ${emp.status==='Active'?'bg-green-500':'bg-red-500'}`}></span>{emp.status}</td>
                                                        <td className="px-4 py-3 text-sm text-gray-500">{emp.phone}</td>
                                                        <td className="px-4 py-3 text-sm text-gray-500"><div>{formatDate(emp.startDate)}</div><div className="text-[10px] text-gray-400">{calculateTenure(emp.startDate)}</div></td>
                                                        <td className="px-4 py-3 text-sm text-gray-500">{emp.company}</td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            )}

                            {selectionMode && selectedIds.length > 0 && (
                                <div className="batch-actions">
                                    <span className="text-sm font-bold text-gray-600">{selectedIds.length} Selected</span>
                                    <div className="h-6 w-px bg-gray-200 mx-2"></div>
                                    <span className="text-xs text-gray-400 mr-2">Transfer To:</span>
                                    {departments.map(d => <button key={d} onClick={()=>handleTransferToDept(d)} className="px-2 py-1 text-xs bg-blue-50 text-blue-600 rounded hover:bg-blue-100">{d}</button>)}
                                    <button onClick={()=>{if(confirm('Delete?')) updateStateFull(employees.filter(e=>!selectedIds.includes(e.id)), [], selectedIds); setSelectedIds([]);}} className="p-2 text-red-600 ml-4"><Icons.Trash2 size={16}/></button>
                                </div>
                            )}

                            {viewMode === 'chart' && (
                                <>
                                    <div className="zoom-controls"><button onClick={()=>setZoom(z=>Math.max(0.3,z-0.1))}><Icons.ZoomOut/></button><span className="text-xs font-mono">{Math.round(zoom*100)}%</span><button onClick={()=>setZoom(z=>Math.min(1.5,z+0.1))}><Icons.ZoomIn/></button></div>
                                    {!isLocked && historyIndex > 0 && <div className="undo-controls"><button onClick={handleUndo} className="bg-white text-gray-700 p-3 rounded-full shadow-lg border hover:bg-gray-50 flex items-center gap-2 group undo-btn" title="Undo Last Action"><Icons.RotateCcw size={20}/></button></div>}
                                </>
                            )}
                        </main>
                    </div>

                    {isModalOpen && <EmployeeForm employee={editingEmployee} supervisors={employees} positions={positions} depts={departments} onSave={handleSave} onCancel={()=>setIsModalOpen(false)} onDelete={handleDelete} currentUser={currentUser} driveUrl={driveUrl} onManagePositions={()=>setIsManagePositionsOpen(true)}/>}
                    
                    {/* [V15] Admin Panel is now the central hub */}
                    {isAdminPanelOpen && <AdminPanel onClose={()=>setIsAdminPanelOpen(false)} driveUrl={driveUrl} setDriveUrl={setDriveUrl} apiCall={appApiCall} depts={departments} onAddDept={handleAddDept} onDeleteDept={handleDeleteDept} />}
                    
                    {isManagePositionsOpen && <ManagePositionsModal positions={positions} onAdd={(p)=>{const np = [...positions, p]; setPositions(np); localStorage.setItem('orgPositions', JSON.stringify(np)); if(driveUrl) appApiCall(driveUrl, 'saveData', {orgPositions: np});}} onDelete={(p)=>{const np = positions.filter(x=>x!==p); setPositions(np); localStorage.setItem('orgPositions', JSON.stringify(np));}} onClose={()=>setIsManagePositionsOpen(false)} />}
                    {isSummaryOpen && <SummaryDashboard employees={employees} onClose={()=>setIsSummaryOpen(false)} departments={departments} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
