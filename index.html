<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HR Organize System (Final Deep Clean)</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; touch-action: manipulation; background-color: #f9fafb; }
        .draggable-source { cursor: grab; } .draggable-source:active { cursor: grabbing; }
        .zoom-controls { position: fixed; bottom: 20px; right: 20px; background: white; padding: 10px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 40; display: flex; align-items: center; gap: 8px; border: 1px solid #e2e8f0; }
        .undo-controls { position: fixed; bottom: 80px; right: 20px; z-index: 40; display: flex; flex-direction: column; gap: 8px; }
        .batch-actions { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: white; padding: 10px 20px; border-radius: 50px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); z-index: 50; display: flex; gap: 12px; align-items: center; border: 1px solid #e2e8f0; animation: slideUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes slideUp { from { transform: translate(-50%, 100%); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }
        .sidebar-resizer { width: 5px; cursor: col-resize; background-color: transparent; position: absolute; right: 0; top: 0; bottom: 0; z-index: 50; } .sidebar-resizer:hover, .sidebar-resizer.resizing { background-color: #3b82f6; }
        .sidebar-toggle-btn { position: absolute; top: 50%; transform: translateY(-50%); width: 24px; height: 40px; background: white; border: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 50; box-shadow: 2px 0 5px rgba(0,0,0,0.1); color: #4b5563; }
        .reorder-controls { position: absolute; top: 50%; transform: translateY(-50%); display: flex; flex-direction: column; gap: 2px; z-index: 30; opacity: 0; transition: opacity 0.2s; } .group:hover .reorder-controls { opacity: 1; }
        .reorder-btn { background: white; border: 1px solid #e2e8f0; border-radius: 50%; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #64748b; box-shadow: 0 1px 2px rgba(0,0,0,0.1); font-size: 8px; } .reorder-btn:hover { background: #f1f5f9; color: #2563eb; transform: scale(1.1); }
        .paper-marker { position: absolute; font-size: 9px; color: #ef4444; font-weight: bold; pointer-events: none; display: flex; align-items: center; justify-content: center; z-index: 15; opacity: 0.8; background: rgba(255,255,255,0.8); padding: 0 2px; border-radius: 2px; }
        .paper-line { position: absolute; background-color: #ef4444; pointer-events: none; z-index: 14; opacity: 0.4; border-left: 1px dashed #ef4444; border-top: 1px dashed #ef4444; }
        @media print { nav, .zoom-controls, .undo-controls, .batch-actions, .sidebar-resizer, .sidebar-toggle-btn, aside { display: none !important; } }
    </style>
</head>
<body>
    <div id="root" class="h-screen flex flex-col"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback, useMemo } = React;

        // --- ERROR BOUNDARY ---
        class ErrorBoundary extends React.Component {
            constructor(props) { super(props); this.state = { hasError: false }; }
            static getDerivedStateFromError(error) { return { hasError: true }; }
            componentDidCatch(error, errorInfo) { console.error(error, errorInfo); }
            render() {
                if (this.state.hasError) {
                    return <div className="h-screen flex items-center justify-center flex-col gap-4 text-center p-4">
                        <h1 className="text-2xl font-bold text-red-600">เกิดข้อผิดพลาด (System Error)</h1>
                        <button onClick={() => { localStorage.clear(); window.location.reload(); }} className="bg-red-600 text-white px-4 py-2 rounded shadow hover:bg-red-700">ล้างข้อมูลและเริ่มใหม่ (Hard Reset)</button>
                    </div>;
                }
                return this.props.children;
            }
        }

        // --- UTILS & ICONS ---
        const formatDriveUrl = (url) => { if (!url) return "https://via.placeholder.com/100?text=No+Img"; if (url.includes('drive.google.com') || url.includes('docs.google.com')) { let id = null; const idMatch1 = url.match(/id=([a-zA-Z0-9_-]+)/); if (idMatch1) id = idMatch1[1]; else { const idMatch2 = url.match(/\/d\/([a-zA-Z0-9_-]+)/); if (idMatch2) id = idMatch2[1]; } if (id) return `https://lh3.googleusercontent.com/d/${id}`; } return url; };
        const compressImage = (file, targetSizeKB = 512) => { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = (event) => { const img = new Image(); img.src = event.target.result; img.onload = () => { const canvas = document.createElement('canvas'); let width = img.width, height = img.height; const MAX = 1600; if (width > MAX || height > MAX) { if (width > height) { height *= MAX / width; width = MAX; } else { width *= MAX / height; height = MAX; } } canvas.width = width; canvas.height = height; const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height); let quality = 0.9, dataUrl = canvas.toDataURL('image/jpeg', quality); while (dataUrl.length * 0.75 > targetSizeKB * 1024 && quality > 0.1) { quality -= 0.1; dataUrl = canvas.toDataURL('image/jpeg', quality); } resolve(dataUrl); }; img.onerror = reject; }; reader.onerror = reject; }); };
        const calculateTenure = (dateString) => { if (!dateString) return ""; const start = new Date(dateString); const now = new Date(); if (isNaN(start)) return ""; let years = now.getFullYear() - start.getFullYear(); let months = now.getMonth() - start.getMonth(); if (months < 0 || (months === 0 && now.getDate() < start.getDate())) { years--; months += 12; } if (years < 0) return "New"; return `${years}Y ${months}M`; };
        const exportToExcel = (employees) => { let csvContent = "data:text/csv;charset=utf-8,\uFEFFID,Name,Position,Dept,Type,Status,ReportsTo,StartDate,Phone,Order\n"; employees.forEach(e => { csvContent += `"${e.id}","${e.name}","${e.position}","${e.dept||''}","${e.type}","${e.status}","${e.reportsTo}","${e.startDate||''}","${e.phone||''}","${e.order||0}"\n`; }); const link = document.createElement("a"); link.setAttribute("href", encodeURI(csvContent)); link.setAttribute("download", "employees.csv"); document.body.appendChild(link); link.click(); document.body.removeChild(link); };

        const IconBase = ({ children, size = 18, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>;
        const Icons = { Camera: (p)=><IconBase {...p}><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></IconBase>, Plus: (p)=><IconBase {...p}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></IconBase>, Trash2: (p)=><IconBase {...p}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></IconBase>, X: (p)=><IconBase {...p}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></IconBase>, Check: (p)=><IconBase {...p}><polyline points="20 6 9 17 4 12"/></IconBase>, Settings: (p)=><IconBase {...p}><path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></IconBase>, Move: (p)=><IconBase {...p}><polyline points="5 9 2 12 5 15"/><polyline points="9 5 12 2 15 5"/><polyline points="19 9 22 12 19 15"/><polyline points="9 19 12 22 15 19"/><line x1="2" y1="12" x2="22" y2="12"/><line x1="12" y1="2" x2="12" y2="22"/></IconBase>, Menu: (p)=><IconBase {...p}><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></IconBase>, List: (p)=><IconBase {...p}><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></IconBase>, Grid: (p)=><IconBase {...p}><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></IconBase>, ChevronLeft: (p)=><IconBase {...p}><polyline points="15 18 9 12 15 6"/></IconBase>, ChevronRight: (p)=><IconBase {...p}><polyline points="9 18 15 12 9 6"/></IconBase>, ArrowUp: (p)=><IconBase {...p}><line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/></IconBase>, ArrowDown: (p)=><IconBase {...p}><line x1="12" y1="5" x2="12" y2="19"/><polyline points="19 12 12 19 5 12"/></IconBase>, ArrowLeft: (p)=><IconBase {...p}><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></IconBase>, ArrowRight: (p)=><IconBase {...p}><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></IconBase>, RotateCcw: (p)=><IconBase {...p}><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></IconBase>, RulerIcon: (p)=><IconBase {...p}><path d="M21.3 15.3a2.4 2.4 0 0 1 0 3.4l-2.6 2.6a2.4 2.4 0 0 1-3.4 0L2.7 8.7a2.4 2.4 0 0 1 0-3.4l2.6-2.6a2.4 2.4 0 0 1 3.4 0Z"/><line x1="14.5" y1="3.2" x2="18.8" y2="7.5"/><line x1="12.5" y1="5.2" x2="16.8" y2="9.5"/><line x1="10.5" y1="7.2" x2="14.8" y2="11.5"/><line x1="8.5" y1="9.2" x2="12.8" y2="13.5"/><line x1="6.5" y1="11.2" x2="10.8" y2="15.5"/><line x1="4.5" y1="13.2" x2="8.8" y2="17.5"/></IconBase>, Edit: (p)=><IconBase {...p}><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></IconBase>, Lock: (p)=><IconBase {...p}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></IconBase>, Unlock: (p)=><IconBase {...p}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></IconBase>, ZoomIn: (p)=><IconBase {...p}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="11" y1="8" x2="11" y2="14"/><line x1="8" y1="11" x2="14" y2="11"/></IconBase>, ZoomOut: (p)=><IconBase {...p}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="8" y1="11" x2="14" y2="11"/></IconBase>, LogOut: (p)=><IconBase {...p}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></IconBase>, Cloud: (p)=><IconBase {...p}><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></IconBase>, Loader: (p)=><IconBase {...p} className={`spinner ${p.className}`}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></IconBase>, Alert: (p)=><IconBase {...p}><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></IconBase>, Paint: (p)=><IconBase {...p}><path d="M18.375 2.625a2.121 2.121 0 1 1 3 3L12 15l-4 1 1-4Z"/><path d="m15 6.5 3 3"/><path d="M6 20h1a2 2 0 0 0 2-2V8a2 2 0 0 0-4 0v10a2 2 0 0 0 1 2Z"/></IconBase>, FileSpreadsheet: (p)=><IconBase {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M8 13h2"/><path d="M8 17h2"/><path d="M14 13h2"/><path d="M14 17h2"/></IconBase>, Chart: (p)=><IconBase {...p}><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></IconBase>, Image: (p)=><IconBase {...p}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></IconBase>, Briefcase: (p)=><IconBase {...p}><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></IconBase>, CheckSquare: (p)=><IconBase {...p}><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></IconBase>, Type: (p)=><IconBase {...p}><polyline points="4 7 4 4 20 4 20 7"/><line x1="9" y1="20" x2="15" y2="20"/><line x1="12" y1="4" x2="12" y2="20"/></IconBase>, Link: (p)=><IconBase {...p}><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></IconBase>, Search: (p)=><IconBase {...p}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></IconBase>, Upload: (p)=><IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></IconBase>, RefreshCw: (p)=><IconBase {...p}><path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/><path d="M3 22v-6h6"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"/></IconBase>, Fingerprint: (p)=><IconBase {...p}><path d="M2 12a10 10 0 0 1 18-6"/><path d="M5 15a10 10 0 0 1 12-10"/><path d="M8 18a10 10 0 0 1 6-12"/><path d="M11 21a10 10 0 0 1 0-14"/><path d="M14 18a10 10 0 0 1-6 0"/><path d="M17 15a10 10 0 0 1-12 0"/><path d="M20 12a10 10 0 0 1-18 6"/></IconBase>, Home: (p)=><IconBase {...p}><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></IconBase> };

        const Button = ({ children, onClick, variant = 'primary', className = '', icon: Icon, disabled, title }) => { const base = "flex items-center justify-center px-3 py-2 sm:px-4 sm:py-2 rounded-lg font-medium transition-all active:scale-95 shadow-sm disabled:opacity-50 text-sm sm:text-base whitespace-nowrap"; const variants = { primary: "bg-blue-600 text-white hover:bg-blue-700", secondary: "bg-white text-gray-700 border border-gray-200 hover:bg-gray-50", danger: "bg-red-50 text-red-600 hover:bg-red-100 border border-red-100", success: "bg-green-600 text-white hover:bg-green-700", warning: "bg-orange-500 text-white hover:bg-orange-600", }; return <button type="button" onClick={onClick} disabled={disabled} className={`${base} ${variants[variant]} ${className}`} title={title}>{Icon && <Icon size={18} className="mr-2" />} {children}</button>; };
        const THEMES = { blue: { name: 'Blue', lv0: 'bg-blue-100 border-blue-600', lv1: 'bg-blue-50 border-blue-400', lvN: 'bg-white border-blue-200' }, teal: { name: 'Teal', lv0: 'bg-teal-100 border-teal-600', lv1: 'bg-teal-50 border-teal-400', lvN: 'bg-white border-teal-200' }, indigo: { name: 'Indigo', lv0: 'bg-indigo-100 border-indigo-600', lv1: 'bg-indigo-50 border-indigo-400', lvN: 'bg-white border-indigo-200' }, rose: { name: 'Rose', lv0: 'bg-rose-100 border-rose-600', lv1: 'bg-rose-50 border-rose-400', lvN: 'bg-white border-rose-200' }, slate: { name: 'Slate', lv0: 'bg-slate-200 border-slate-600', lv1: 'bg-slate-100 border-slate-400', lvN: 'bg-white border-slate-300' }, orange: { name: 'Orange', lv0: 'bg-orange-100 border-orange-600', lv1: 'bg-orange-50 border-orange-400', lvN: 'bg-white border-orange-200' } };
        const SHAPES = { rounded: { name: 'Rounded', cls: 'rounded-xl' }, sharp: { name: 'Square', cls: 'rounded-none' }, pill: { name: 'Pill', cls: 'rounded-[2rem]' }, leaf: { name: 'Leaf', cls: 'rounded-tr-3xl rounded-bl-3xl rounded-tl-md rounded-br-md' } };

        // --- Components ---
        const AdminPanel = ({ onClose, driveUrl, setDriveUrl, apiCall, depts }) => { 
            const [users, setUsers] = useState([]);
            const [newUser, setNewUser] = useState({ username: '', password: '', role: 'leader', name: '', dept: 'ALL' }); 
            const [editingUsername, setEditingUsername] = useState(null);
            const [loading, setLoading] = useState(false); 
            useEffect(() => { const loadUsers = async () => { setLoading(true); let loadedUsers = []; if (driveUrl) { try { const res = await apiCall(driveUrl, 'getUsers'); if (res?.status === 'success') loadedUsers = res.users; } catch (e) {} } if (loadedUsers.length === 0) loadedUsers = JSON.parse(localStorage.getItem('users')) || [{ username: 'admin', password: 'password', role: 'admin', name: 'Admin User', dept: 'ALL' }]; setUsers(loadedUsers); setLoading(false); }; loadUsers(); }, [driveUrl]);
            const saveUserAction = async () => { if (!newUser.username || !newUser.password) return alert("กรุณากรอก User/Pass"); setLoading(true); let updatedUsers; if (editingUsername) updatedUsers = users.map(u => u.username === editingUsername ? newUser : u); else { if (users.some(u => u.username === newUser.username)) { setLoading(false); return alert('ชื่อซ้ำ'); } updatedUsers = [...users, newUser]; } setUsers(updatedUsers); localStorage.setItem('users', JSON.stringify(updatedUsers)); if (driveUrl) try { await apiCall(driveUrl, 'saveUser', { user: newUser }); } catch (e) { alert("บันทึก Cloud ไม่สำเร็จ"); } setEditingUsername(null); setNewUser({ username: '', password: '', role: 'leader', name: '', dept: 'ALL' }); setLoading(false); };
            const deleteUserAction = async (username) => { if (!confirm('ยืนยันลบ?')) return; setLoading(true); const updated = users.filter(u => u.username !== username); setUsers(updated); localStorage.setItem('users', JSON.stringify(updated)); if (driveUrl) await apiCall(driveUrl, 'deleteUser', { username }); setLoading(false); };
            return ( <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[70]"><div className="bg-white w-full max-w-4xl rounded-2xl shadow-xl overflow-hidden flex flex-col max-h-[90vh]"> <div className="p-6 border-b flex justify-between items-center"><h2 className="text-xl font-bold">Admin Panel</h2><button onClick={onClose}><Icons.X /></button></div> <div className="p-6 overflow-y-auto space-y-6"> <div className="bg-blue-50 p-4 rounded-lg border border-blue-100"><h3 className="font-bold text-blue-800 mb-2 flex items-center"><Icons.Cloud className="mr-2"/> Google Script URL</h3><input type="text" value={driveUrl} onChange={(e) => setDriveUrl(e.target.value)} className="w-full p-2 border rounded text-sm"/></div> <div><h3 className="font-bold mb-4 flex items-center"><Icons.Users className="mr-2"/> Users {loading && <Icons.Loader className="ml-2"/>}</h3> <div className="flex gap-2 mb-4 items-end bg-gray-50 p-3 rounded flex-wrap"><div className="w-32"><label className="text-xs text-gray-500">User</label><input value={newUser.username} onChange={e => setNewUser({...newUser, username: e.target.value})} className="border p-2 rounded text-sm w-full" disabled={!!editingUsername}/></div><div className="w-32"><label className="text-xs text-gray-500">Pass</label><input value={newUser.password} onChange={e => setNewUser({...newUser, password: e.target.value})} className="border p-2 rounded text-sm w-full"/></div><div className="flex-1"><label className="text-xs text-gray-500">Name</label><input value={newUser.name} onChange={e => setNewUser({...newUser, name: e.target.value})} className="border p-2 rounded text-sm w-full"/></div><div className="w-28"><label className="text-xs text-gray-500">Role</label><select value={newUser.role} onChange={e => setNewUser({...newUser, role: e.target.value})} className="border p-2 rounded text-sm w-full"><option value="admin">Admin</option><option value="supervisor">Sup</option><option value="leader">Leader</option></select></div><div className="w-32"><label className="text-xs text-gray-500">Dept (Auth)</label><select value={newUser.dept} onChange={e => setNewUser({...newUser, dept: e.target.value})} className="border p-2 rounded text-sm w-full"><option value="ALL">ALL (Admin)</option>{depts.map(d=><option key={d} value={d}>{d}</option>)}</select></div><button onClick={saveUserAction} className={`${editingUsername ? 'bg-orange-500' : 'bg-green-600'} text-white p-2 rounded h-[38px] w-[38px] flex justify-center items-center`}>{editingUsername ? <Icons.Check size={18}/> : <Icons.Plus size={18}/>}</button></div> <table className="w-full text-sm text-left"><thead className="bg-gray-100"><tr><th className="p-2">User</th><th className="p-2">Name</th><th className="p-2">Role</th><th className="p-2">Dept</th><th className="p-2">Act</th></tr></thead><tbody>{users.map((u, i) => <tr key={i} className="border-b"><td className="p-2 font-medium">{u.username}</td><td className="p-2">{u.name}</td><td className="p-2"><span className={`px-2 py-0.5 rounded text-xs ${u.role==='admin'?'bg-red-100 text-red-800':u.role==='supervisor'?'bg-blue-100 text-blue-800':'bg-gray-100'}`}>{u.role}</span></td><td className="p-2 font-bold text-blue-600">{u.dept||'ALL'}</td><td className="p-2 flex gap-2"><button onClick={() => { setNewUser(u); setEditingUsername(u.username); }} className="text-orange-500 p-1"><Icons.Edit size={16}/></button>{u.username !== 'admin' && <button onClick={() => deleteUserAction(u.username)} className="text-red-500 p-1"><Icons.Trash2 size={16}/></button>}</td></tr>)}</tbody></table> </div> </div> </div></div> ); };

        const ManageDeptsModal = ({ depts, onAdd, onDelete, onClose }) => { const [newD, setNewD] = useState(""); return ( <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[70]"> <div className="bg-white rounded-xl shadow-xl p-6 w-full max-w-sm"> <div className="flex justify-between items-center mb-4"><h3 className="font-bold flex items-center"><Icons.Grid className="mr-2"/> Manage Departments</h3><button onClick={onClose}><Icons.X/></button></div> <div className="flex gap-2 mb-4"><input value={newD} onChange={e=>setNewD(e.target.value)} placeholder="New Dept..." className="flex-1 border p-2 rounded text-sm"/><button onClick={()=>{if(newD){onAdd(newD);setNewD('');}}} className="bg-green-600 text-white p-2 rounded"><Icons.Plus/></button></div> <div className="max-h-60 overflow-y-auto space-y-2">{depts.map(d => (<div key={d} className="flex justify-between items-center p-2 bg-gray-50 rounded text-sm group"><span>{d}</span><button onClick={()=>onDelete(d)} className="text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100"><Icons.Trash2 size={16}/></button></div>))}</div> </div> </div> ); };

        const ManagePositionsModal = ({ positions, onAdd, onDelete, onClose }) => { const [newPos, setNewPos] = useState(""); return ( <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[70]"> <div className="bg-white rounded-xl shadow-xl p-6 w-full max-w-sm"> <div className="flex justify-between items-center mb-4"><h3 className="font-bold flex items-center"><Icons.Briefcase className="mr-2"/> Manage Positions</h3><button onClick={onClose}><Icons.X/></button></div> <div className="flex gap-2 mb-4"><input value={newPos} onChange={e=>setNewPos(e.target.value)} placeholder="New Position..." className="flex-1 border p-2 rounded text-sm"/><button onClick={()=>{if(newPos){onAdd(newPos);setNewPos('');}}} className="bg-green-600 text-white p-2 rounded"><Icons.Plus/></button></div> <div className="max-h-60 overflow-y-auto space-y-2">{positions.map(p => (<div key={p} className="flex justify-between items-center p-2 bg-gray-50 rounded text-sm group"><span>{p}</span><button onClick={()=>onDelete(p)} className="text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100"><Icons.Trash2 size={16}/></button></div>))}</div> </div> </div> ); };

        const DraggableLogo = ({ logo, setLogo, isLocked }) => { const elementRef = useRef(null); if (!logo.url) return null; const handleMouseDown = (e) => { if (isLocked) return; e.preventDefault(); const element = elementRef.current; const startX = e.clientX - logo.x; const startY = e.clientY - logo.y; const onMouseMove = (moveEvent) => { const newX = moveEvent.clientX - startX; const newY = moveEvent.clientY - startY; if (element) { element.style.left = `${newX}px`; element.style.top = `${newY}px`; } }; const onMouseUp = (upEvent) => { document.removeEventListener("mousemove", onMouseMove); document.removeEventListener("mouseup", onMouseUp); const finalX = upEvent.clientX - startX; const finalY = upEvent.clientY - startY; setLogo(prev => ({ ...prev, x: finalX, y: finalY })); }; document.addEventListener("mousemove", onMouseMove); document.addEventListener("mouseup", onMouseUp); }; return ( <div ref={elementRef} className={`absolute z-30 group draggable-element ${!isLocked ? 'cursor-move hover:ring-2 hover:ring-blue-400' : ''}`} style={{ left: logo.x, top: logo.y, width: logo.width || 150 }} onMouseDown={handleMouseDown}> <img src={logo.url} className="w-full h-auto object-contain pointer-events-none" /> {!isLocked && <button onClick={() => setLogo({ url: null, x: 50, y: 50 })} className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity shadow-sm"><Icons.X size={12}/></button>} </div> ); };
        const DraggableAnnotation = ({ ann, onUpdate, onDelete, isLocked, onLinkStart }) => { const elementRef = useRef(null); const handleMouseDown = (e) => { if (isLocked) return; e.stopPropagation(); const element = elementRef.current; const startX = e.clientX - ann.x; const startY = e.clientY - ann.y; const onMouseMove = (moveEvent) => { const newX = moveEvent.clientX - startX; const newY = moveEvent.clientY - startY; if (element) { element.style.left = `${newX}px`; element.style.top = `${newY}px`; } }; const onMouseUp = (upEvent) => { document.removeEventListener("mousemove", onMouseMove); document.removeEventListener("mouseup", onMouseUp); const finalX = upEvent.clientX - startX; const finalY = upEvent.clientY - startY; onUpdate(ann.id, { x: finalX, y: finalY }); }; document.addEventListener("mousemove", onMouseMove); document.addEventListener("mouseup", onMouseUp); }; return ( <div ref={elementRef} className={`absolute z-30 draggable-element group p-3 rounded shadow-md border min-w-[150px] ${!isLocked ? 'cursor-move hover:ring-2 hover:ring-blue-300' : ''}`} style={{ left: ann.x, top: ann.y, backgroundColor: ann.bg || '#ffffff', color: ann.color || '#000' }} onMouseDown={handleMouseDown}> {!isLocked ? ( <textarea value={ann.text} onChange={(e)=>onUpdate(ann.id, {text: e.target.value})} className="w-full bg-transparent outline-none resize-none overflow-hidden text-center" style={{fontSize: '14px'}} placeholder="Type here..."/> ) : ( <div className="text-center whitespace-pre-wrap">{ann.text}</div> )} {!isLocked && (<div className="absolute -top-3 -right-3 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity"><button onClick={(e)=>{e.stopPropagation(); onLinkStart(ann.id);}} className="bg-blue-500 text-white p-1 rounded-full shadow" title="Link to Node"><Icons.Link size={10}/></button><button onClick={(e)=>{e.stopPropagation(); onDelete(ann.id);}} className="bg-red-500 text-white p-1 rounded-full shadow"><Icons.X size={10}/></button></div>)} {!isLocked && (<div className="absolute -bottom-8 left-0 right-0 flex justify-center gap-1 opacity-0 group-hover:opacity-100 bg-white/90 p-1 rounded shadow text-xs"><input type="color" value={ann.bg||'#ffffff'} onChange={(e)=>onUpdate(ann.id, {bg: e.target.value})} title="Background" className="w-4 h-4"/><input type="color" value={ann.color||'#000000'} onChange={(e)=>onUpdate(ann.id, {color: e.target.value})} title="Text Color" className="w-4 h-4"/></div>)} </div> ); };
        const Ruler = ({ orientation = 'horizontal', length = 3000 }) => { const pxPerMm = 3.7795; const paperSizes = [ { name: 'A4', w: 210, h: 297 }, { name: 'A3', w: 297, h: 420 }, { name: 'A2', w: 420, h: 594 }, { name: 'A1', w: 594, h: 841 }, { name: 'A0', w: 841, h: 1189 } ]; const ticks = []; for (let i = 0; i <= length / pxPerMm; i += 10) { ticks.push( <div key={i} className="absolute bg-gray-400" style={orientation==='horizontal'?{left:`${i*pxPerMm}px`,height:'6px',width:'1px',bottom:0}:{top:`${i*pxPerMm}px`,width:'6px',height:'1px',right:0}}> <span className="absolute text-[8px] text-gray-500 font-mono" style={orientation==='horizontal'?{left:'2px',bottom:'8px'}:{top:'2px',right:'8px'}}>{i}</span> </div> ); } const markers = []; paperSizes.forEach(size => { if (orientation === 'horizontal') { markers.push(<div key={`w-${size.name}`} className="paper-marker" style={{left: `${size.h * pxPerMm}px`, top: '2px'}}>{size.name}</div>); markers.push(<div key={`l-${size.name}`} className="paper-line" style={{left: `${size.h * pxPerMm}px`, height: '2000px', top: '30px', width: '0px'}}></div>); } else { markers.push(<div key={`h-${size.name}`} className="paper-marker" style={{top: `${size.w * pxPerMm}px`, left: '2px', transform: 'rotate(-90deg)'}}>{size.name}</div>); markers.push(<div key={`vl-${size.name}`} className="paper-line" style={{top: `${size.w * pxPerMm}px`, width: '2000px', left: '30px', height: '0px'}}></div>); } }); return ( <div className={`ruler-container ${orientation==='horizontal'?'ruler-h':'ruler-v'}`} style={{position: 'absolute'}}> <div className="relative w-full h-full"> {ticks} {markers} </div> </div> ); };
        const ThemePanel = ({ onClose, currentTheme, setAppTheme, currentShape, setAppShape, layoutThreshold, setLayoutThreshold }) => { return ( <div className="fixed top-16 right-4 bg-white p-4 rounded-xl shadow-xl border w-64 z-[60] animate-in slide-in-from-top-2"> <div className="flex justify-between items-center mb-4"><h3 className="font-bold">Appearance</h3><button onClick={onClose}><Icons.X size={16}/></button></div> <div className="mb-4"><label className="text-xs text-gray-500 block mb-2">Theme</label><div className="grid grid-cols-4 gap-2">{Object.entries(THEMES).map(([key, t]) => (<button key={key} onClick={()=>setAppTheme(key)} className={`w-10 h-10 rounded-lg ${t.lv0} shadow-sm border-2 ${currentTheme===key?'border-gray-800 scale-110 ring-2 ring-offset-1':'border-transparent'}`} title={t.name}></button>))}</div></div> <div className="mb-4"><label className="text-xs text-gray-500 block mb-2">Global Shape</label><div className="flex flex-wrap gap-2">{Object.entries(SHAPES).map(([key, s]) => (<button key={key} onClick={()=>setAppShape(s)} className={`px-3 py-1 bg-gray-100 border text-xs ${s.cls} ${currentShape.name===s.name?'bg-blue-100 border-blue-500 text-blue-700':''}`}>{s.name}</button>))}</div></div> <div> <label className="text-xs text-gray-500 block mb-2">Layout Threshold (Max Rows)</label> <div className="flex items-center gap-2"> <input type="number" min="1" max="20" value={layoutThreshold} onChange={(e)=>setLayoutThreshold(Number(e.target.value))} className="border p-2 rounded text-sm w-full" /> <span className="text-xs text-gray-400">nodes</span> </div> <p className="text-[10px] text-gray-400 mt-1">If subordinates > {layoutThreshold}, switch to Grid.</p> </div> </div> ); };
        const SummaryDashboard = ({ employees, onClose }) => { const stats = useMemo(() => { const total = employees.length; const byType = { Permanent: 0, Subcontract: 0 }; const byPosition = {}; employees.forEach(e => { if (e.type === 'Permanent') byType.Permanent++; else byType.Subcontract++; byPosition[e.position] = (byPosition[e.position] || 0) + 1; }); return { total, byType, byPosition }; }, [employees]); return ( <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[80] animate-in fade-in"> <div className="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-2xl max-h-[80vh] overflow-y-auto"> <div className="flex justify-between items-center mb-6 border-b pb-2"><h2 className="text-2xl font-bold text-gray-800 flex items-center"><Icons.Chart className="mr-2"/> Summary Dashboard</h2><button onClick={onClose}><Icons.X/></button></div> <div className="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-8"> <div className="bg-blue-50 p-4 rounded-xl text-center border border-blue-100"><h3 className="text-gray-500 text-sm font-medium">Total Employees</h3><p className="text-3xl font-bold text-blue-700">{stats.total}</p></div> <div className="bg-green-50 p-4 rounded-xl text-center border border-green-100"><h3 className="text-gray-500 text-sm font-medium">Permanent</h3><p className="text-3xl font-bold text-green-700">{stats.byType.Permanent}</p></div> <div className="bg-orange-50 p-4 rounded-xl text-center border border-orange-100"><h3 className="text-gray-500 text-sm font-medium">Subcontract</h3><p className="text-3xl font-bold text-orange-700">{stats.byType.Subcontract}</p></div> </div> <div><h3 className="font-bold text-gray-700 mb-4">By Position</h3><div className="space-y-3">{Object.entries(stats.byPosition).sort((a,b)=>b[1]-a[1]).map(([pos, count]) => (<div key={pos} className="flex items-center"><div className="w-1/3 text-sm font-medium text-gray-600 truncate pr-2">{pos}</div><div className="flex-1 bg-gray-100 rounded-full h-4 overflow-hidden"><div className="bg-blue-500 h-full rounded-full" style={{width: `${(count/stats.total)*100}%`}}></div></div><div className="w-10 text-right text-sm font-bold text-gray-800">{count}</div></div>))}</div></div> </div> </div> ); };
        const LoginScreen = ({ onLogin, driveUrl, apiCall }) => { const [creds, setCreds] = useState({ username: '', password: '' }); const [loading, setLoading] = useState(false); const handleSubmit = async (e) => { e.preventDefault(); setLoading(true); try { if (driveUrl) { const res = await apiCall(driveUrl, 'login', creds); if (res?.status === 'success') { onLogin(res.user); return; } } if (creds.username === 'admin' && creds.password === 'password') { onLogin({ username: 'admin', name: 'System Admin', role: 'admin', dept: 'ALL' }); } else { alert("Login failed"); } } catch (err) { alert("Error"); } finally { setLoading(false); } }; return ( <div className="h-screen flex items-center justify-center bg-slate-900 px-4"> <div className="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm"> <div className="flex flex-col items-center mb-8"> <div className="bg-red-600 p-3 rounded-xl text-white font-bold text-2xl mb-2">HR</div> <h1 className="text-xl font-bold text-gray-800">Organize System</h1> </div> <form onSubmit={handleSubmit} className="space-y-4"> <input type="text" placeholder="Username" className="w-full p-3 border rounded-lg" onChange={e => setCreds({...creds, username: e.target.value})} required /> <input type="password" placeholder="Password" className="w-full p-3 border rounded-lg" onChange={e => setCreds({...creds, password: e.target.value})} required /> <button type="submit" disabled={loading} className="w-full bg-blue-600 text-white p-3 rounded-lg font-bold hover:bg-blue-700 transition-colors"> {loading ? 'Logging in...' : 'Login'} </button> </form> </div> </div> ); };
        
        // [FIX] Improved Landing Page - Handles empty data
        const LandingPage = ({ departments, user, onSelectDept }) => {
            // [KEY FIX] Ensure we have valid departments to show
            const availableDepts = useMemo(() => {
                if (!departments || departments.length === 0) return ["ASSEMBLY", "QC", "HR"]; // Force defaults if empty
                if (user.dept === 'ALL') return departments;
                return [user.dept];
            }, [departments, user]);
            
            return (
                <div className="h-screen flex items-center justify-center bg-gray-50 px-4">
                    <div className="w-full max-w-4xl">
                        <h1 className="text-3xl font-bold text-center mb-8 text-gray-800">เลือกแผนกเพื่อเข้าใช้งาน</h1>
                        <p className="text-center text-gray-500 mb-8">สวัสดี, {user.name} ({user.role})</p>
                        <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
                            {availableDepts.map(dept => (
                                <button key={dept} onClick={() => onSelectDept(dept)} className="bg-white p-8 rounded-2xl shadow-lg hover:shadow-xl transition-all border border-gray-100 flex flex-col items-center group hover:border-blue-500">
                                    <div className="w-16 h-16 bg-blue-50 rounded-full flex items-center justify-center text-blue-600 mb-4 group-hover:bg-blue-600 group-hover:text-white transition-colors"><Icons.Briefcase size={32}/></div>
                                    <h3 className="text-xl font-bold text-gray-800">{dept || "Unknown Dept"}</h3>
                                    <p className="text-sm text-gray-400 mt-2">Click to enter</p>
                                </button>
                            ))}
                        </div>
                        <button onClick={()=>{localStorage.clear(); window.location.reload();}} className="mt-12 block mx-auto text-red-400 text-sm hover:underline font-bold bg-white px-4 py-2 rounded border border-red-100 shadow-sm">⚠️ ล้างข้อมูลและเริ่มใหม่ (กดเมื่อค้าง)</button>
                    </div>
                </div>
            );
        };

        const App = () => {
            // [FIX] Auto-Repair User Data
            const [currentUser, setCurrentUser] = useState(() => {
                try {
                    const u = JSON.parse(localStorage.getItem('currentUser'));
                    if (u && !u.dept) { localStorage.clear(); return null; } 
                    return u;
                } catch { localStorage.clear(); return null; }
            });
            // [FIX] Auto-Repair Departments: FILTER OUT EMPTY STRINGS
            const [departments, setDepartments] = useState(() => {
                try {
                    let stored = JSON.parse(localStorage.getItem('orgDepartments'));
                    // [KEY FIX] If stored is invalid, empty, or has empty strings, reset to defaults
                    if (!Array.isArray(stored) || stored.length === 0 || stored.some(d => !d || d.trim() === "")) {
                        const defaults = ["ASSEMBLY", "QC", "HR"];
                        localStorage.setItem('orgDepartments', JSON.stringify(defaults));
                        return defaults;
                    }
                    return stored;
                } catch { 
                    return ["ASSEMBLY", "QC", "HR"]; 
                }
            });
            const [employees, setEmployees] = useState(() => JSON.parse(localStorage.getItem('orgData')) || []);
            const [positions, setPositions] = useState(() => JSON.parse(localStorage.getItem('orgPositions')) || ["Manager", "Supervisor", "Engineer", "Leader", "Operator"]);
            const [currentDept, setCurrentDept] = useState(null);
            const [driveUrl, setDriveUrl] = useState("https://script.google.com/macros/s/AKfycbxYxBWD4blG_bP9hdTm_W8RP9PtM9CLZovmSFQVVsQTcBl18uxcaAxrhW5lZKFmEj8H/exec");
            const [viewMode, setViewMode] = useState('chart'); 
            const [zoom, setZoom] = useState(1);
            const [searchTerm, setSearchTerm] = useState('');
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingEmployee, setEditingEmployee] = useState(null);
            const [selectionMode, setSelectionMode] = useState(false);
            const [selectedIds, setSelectedIds] = useState([]);
            const [isSidebarCollapsed, setIsSidebarCollapsed] = useState(false);
            const [isAdminPanelOpen, setIsAdminPanelOpen] = useState(false);
            const [isSummaryOpen, setIsSummaryOpen] = useState(false);
            const [isManageDeptsOpen, setIsManageDeptsOpen] = useState(false);
            const [isManagePosOpen, setIsManagePosOpen] = useState(false);
            const [logo, setLogo] = useState({ url: null, x: 50, y: 50 });
            const [history, setHistory] = useState([]);
            const [historyIndex, setHistoryIndex] = useState(-1);
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);
            const [sidebarWidth, setSidebarWidth] = useState(256);
            const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
            const [isThemePanelOpen, setIsThemePanelOpen] = useState(false);
            const [appTheme, setAppTheme] = useState('blue');
            const [appShape, setAppShape] = useState(SHAPES.rounded);
            const [layoutThreshold, setLayoutThreshold] = useState(4);
            const [annotations, setAnnotations] = useState([]);
            const [linkStartId, setLinkStartId] = useState(null);
            const [showRulers, setShowRulers] = useState(false);
            const isResizing = useRef(false);
            const logoInputRef = useRef(null);
            const csvInputRef = useRef(null);

            const appApiCall = async (url, action, payload) => { try { const res = await fetch(url, { method: 'POST', body: JSON.stringify({ action, ...payload }) }); return await res.json(); } catch (e) { throw e; } };
            const syncUpdatesToCloud = async (updates = [], deletes = []) => { if (!driveUrl) return; try { await appApiCall(driveUrl, 'updateEmployees', { updates, deletes }); } catch (e) {} };
            useEffect(() => { if (driveUrl && currentUser) { appApiCall(driveUrl, 'getData').then(res => { if (res?.status === 'success' && res.data) { if (res.data.orgData) setEmployees(res.data.orgData); if (res.data.orgPositions) setPositions(res.data.orgPositions); if (res.data.orgDepartments) setDepartments(res.data.orgDepartments); } }); } }, [driveUrl, currentUser]);
            
            const pushToHistory = (newData) => { const newHistory = history.slice(0, historyIndex + 1); newHistory.push(newData); if (newHistory.length > 10) newHistory.shift(); setHistory(newHistory); setHistoryIndex(newHistory.length - 1); };
            const handleUndo = () => { if (historyIndex > 0) { const prevState = history[historyIndex - 1]; setEmployees(prevState); setHistoryIndex(prev => prev - 1); localStorage.setItem('orgData', JSON.stringify(prevState)); } };
            const updateStateFull = useCallback((newState, updates = [], deletes = []) => { pushToHistory(employees); setEmployees(newState); localStorage.setItem('orgData', JSON.stringify(newState)); if(updates.length > 0 || deletes.length > 0) syncUpdatesToCloud(updates, deletes); }, [employees, driveUrl, history, historyIndex]);

            const handleReorder = useCallback((id, offset) => {
                const target = employees.find(e => e.id === id); if (!target) return;
                const siblings = employees.filter(e => e.reportsTo === target.reportsTo).sort((a, b) => (a.order || 0) - (b.order || 0));
                const currentIndex = siblings.findIndex(e => e.id === id); if (currentIndex === -1) return;
                let newIndex = currentIndex + offset; if (newIndex < 0) newIndex = 0; if (newIndex >= siblings.length) newIndex = siblings.length - 1; if (newIndex === currentIndex) return;
                const siblingToSwap = siblings[newIndex];
                const updates = [ { ...target, order: siblingToSwap.order || 0 }, { ...siblingToSwap, order: target.order || 0 } ];
                const newData = employees.map(e => { const up = updates.find(u => u.id === e.id); return up ? up : e; });
                updateStateFull(newData, updates, []);
            }, [employees, updateStateFull]);

            const handleLogoUpload = (e) => { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (ev) => { setLogo(prev => ({ ...prev, url: ev.target.result })); }; reader.readAsDataURL(file); } };
            const handleAddAnnotation = () => { const newAnn = { id: Date.now().toString(), x: 100, y: 100, text: 'New Text', bg: '#ffffff', color: '#000000', linkTo: null }; setAnnotations(prev => { const n = [...prev, newAnn]; localStorage.setItem('orgAnnotations', JSON.stringify(n)); return n; }); };
            const handleUpdateAnnotation = (id, updates) => { setAnnotations(prev => { const n = prev.map(a => a.id === id ? { ...a, ...updates } : a); localStorage.setItem('orgAnnotations', JSON.stringify(n)); return n; }); };
            const handleDeleteAnnotation = (id) => { setAnnotations(prev => { const n = prev.filter(a => a.id !== id); localStorage.setItem('orgAnnotations', JSON.stringify(n)); return n; }); };
            const handleAnnotationLink = (nodeId) => { if(linkStartId) { handleUpdateAnnotation(linkStartId, { linkTo: nodeId }); setLinkStartId(null); } };
            const handleDropOnChart = useCallback((draggedIds, targetId) => { if(linkStartId) { handleAnnotationLink(targetId); return; } if(currentUser.role !== 'admin' && currentUser.role !== 'supervisor') return; const idsToMove = Array.isArray(draggedIds) ? draggedIds : [draggedIds]; let updates = []; const newData = employees.map(e => { if(idsToMove.includes(e.id)) { const updated = { ...e, reportsTo: targetId }; updates.push(updated); return updated; } return e; }); updateStateFull(newData, updates, []); setSelectedIds([]); }, [employees, linkStartId, currentUser, updateStateFull]);
            const handleAddPosition = (newPos) => { if(newPos) setPositions(prev => { const newArr = [...prev, newPos]; localStorage.setItem('orgPositions', JSON.stringify(newArr)); if (driveUrl) appApiCall(driveUrl, 'saveData', { orgPositions: newArr }); return newArr; }); };
            const handleDeletePosition = (pos) => { setPositions(prev => { const newArr = prev.filter(p => p !== pos); localStorage.setItem('orgPositions', JSON.stringify(newArr)); if (driveUrl) appApiCall(driveUrl, 'saveData', { orgPositions: newArr }); return newArr; }); };
            const handleBatchAdd = () => { const count = parseInt(prompt("จำนวนที่ต้องการเพิ่ม:", "5")); if(!count) return; let newCards = []; for(let i=0; i<count; i++) { newCards.push({ id: Math.floor(Math.random()*100000).toString(), name: 'New Employee', position: 'Operator', reportsTo: 'STAGING', status: 'Active', type: 'Subcontract', dept: currentDept }); } const newData = [...employees, ...newCards]; updateStateFull(newData, newCards, []); };
            const handleCSVImport = (e) => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (event) => { const text = event.target.result; const lines = text.split('\n'); const newEmployees = []; for (let i = 1; i < lines.length; i++) { const line = lines[i].trim(); if (line) { const cols = line.split(',').map(c => c.replace(/^"|"$/g, '').trim()); if (cols.length >= 2) { newEmployees.push({ id: cols[0] || Math.floor(Math.random()*100000).toString(), name: cols[1], position: cols[2] || 'Operator', dept: cols[3] || currentDept, type: cols[4] || 'Permanent', status: cols[5] || 'Active', reportsTo: cols[6] || 'STAGING', startDate: cols[7] || '', phone: cols[8] || '', order: parseInt(cols[9]) || 0 }); } } } if (newEmployees.length > 0) { const merged = [...employees, ...newEmployees]; updateStateFull(merged, newEmployees, []); alert(`Imported ${newEmployees.length} items!`); } }; reader.readAsText(file); };

            const validEmployees = employees.filter(e => e.id);
            const isAuthorized = (emp) => { if (currentUser.role === 'admin') return true; if (currentUser.dept === 'ALL') return true; return emp.dept === currentUser.dept; };
            const handleSave = useCallback((data, keepOpen=false) => { let updates = [data]; let newData = employees.find(e => e.id === data.id) ? employees.map(e => e.id === data.id ? data : e) : [...employees, data]; updateStateFull(newData, updates, []); if (!keepOpen) { setIsModalOpen(false); setEditingEmployee(null); } else { setEditingEmployee({ isNew: true, reportsTo: data.reportsTo, position: data.position, dept: data.dept }); } }, [employees, updateStateFull]);
            const handleDelete = useCallback((id) => { const newData = employees.filter(e => e.id !== id); updateStateFull(newData, [], [id]); setIsModalOpen(false); }, [employees, updateStateFull]);
            const handleTransferToDept = (targetDept) => { if(selectedIds.length === 0) return; const updates = []; const newData = employees.map(e => { if (selectedIds.includes(e.id)) { const u = { ...e, dept: targetDept, reportsTo: 'STAGING' }; updates.push(u); return u; } return e; }); updateStateFull(newData, updates, []); setSelectedIds([]); setSelectionMode(false); };
            const resize = useCallback((e) => { if (isResizing.current) { const w = e.clientX; if (w > 150 && w < 500) setSidebarWidth(w); } }, []);
            const stopResizing = useCallback(() => { isResizing.current = false; }, []);
            useEffect(() => { window.addEventListener("mousemove", resize); window.addEventListener("mouseup", stopResizing); return () => { window.removeEventListener("mousemove", resize); window.removeEventListener("mouseup", stopResizing); }; }, [resize, stopResizing]);

            if (!currentUser) return <LoginScreen onLogin={(u)=>{setCurrentUser(u); localStorage.setItem('currentUser', JSON.stringify(u));}} driveUrl={driveUrl} apiCall={appApiCall} />;
            if (!currentDept) return <LandingPage departments={departments} user={currentUser} onSelectDept={setCurrentDept} />;

            const filteredAll = validEmployees.filter(e => e.reportsTo !== 'STAGING' && (currentDept === 'ALL' || e.dept === currentDept));
            const stagingEmployees = validEmployees.filter(e => e.reportsTo === 'STAGING' && (currentDept === 'ALL' || e.dept === currentDept) && (!searchTerm || e.name.toLowerCase().includes(searchTerm.toLowerCase())));
            const rootEmployees = filteredAll.filter(e => { const boss = filteredAll.find(b => b.id === e.reportsTo); return !boss; });
            const isLocked = currentUser.role !== 'admin' && currentUser.role !== 'supervisor';
            const canEdit = (emp) => !isLocked && isAuthorized(emp);
            const connectors = annotations.filter(a => a.linkTo).map(ann => { const targetNode = document.getElementById(`node-${ann.linkTo}`); if(!targetNode) return null; const rect = targetNode.getBoundingClientRect(); const container = document.getElementById('org-chart-full-view').getBoundingClientRect(); const x1 = ann.x + 75; const y1 = ann.y + 20; const x2 = (rect.left - container.left) + (rect.width/2); const y2 = (rect.top - container.top) + (rect.height/2); return <line key={ann.id} x1={x1} y1={y1} x2={x2} y2={y2} stroke="red" strokeWidth="2" strokeDasharray="5,5" className="connector-line"/>; });

            return (
                <div className="flex flex-col h-full bg-gray-50">
                    <nav className="bg-white shadow-sm border-b sticky top-0 z-40 h-14 flex items-center px-4 justify-between shrink-0">
                        <div className="flex items-center gap-4">
                            <button onClick={()=>setIsMobileMenuOpen(true)} className="lg:hidden p-2 text-gray-600"><Icons.Menu/></button>
                            <button onClick={()=>setCurrentDept(null)} className="flex items-center gap-2 font-bold text-gray-700 hover:text-blue-600"><Icons.Home/> <span className="hidden sm:inline">Home</span></button>
                            <div className="h-6 w-px bg-gray-300"></div>
                            <span className="font-bold text-blue-600">{currentDept} DEPT</span>
                            {!isLocked && <button onClick={()=>setIsManageDeptsOpen(true)} className="p-1 text-gray-400 hover:text-blue-600"><Icons.Settings size={14}/></button>}
                        </div>
                        <div className="hidden lg:flex items-center gap-3">
                            <div className="hidden sm:flex items-center bg-gray-100 rounded-full px-3 py-1"><Icons.Search size={14} className="text-gray-400"/><input value={searchTerm} onChange={e=>setSearchTerm(e.target.value)} placeholder="Search..." className="bg-transparent border-none text-xs ml-2 w-24 outline-none"/></div>
                            <button onClick={()=>setViewMode('chart')} className={`p-1.5 rounded ${viewMode==='chart'?'bg-blue-50 text-blue-600':''}`}><Icons.Grid size={16}/></button>
                            <button onClick={()=>setViewMode('list')} className={`p-1.5 rounded ${viewMode==='list'?'bg-blue-50 text-blue-600':''}`}><Icons.List size={16}/></button>
                            {!isLocked && <button onClick={()=>{setSelectionMode(!selectionMode); setSelectedIds([]);}} className={`p-1.5 rounded border ${selectionMode?'bg-purple-600 text-white':'text-gray-600'}`}><Icons.CheckSquare size={18}/></button>}
                            {!isLocked && <button onClick={handleAddAnnotation} className="p-1.5 text-gray-600 hover:bg-gray-100 rounded border" title="Add Text"><Icons.Type size={18}/></button>}
                            {!isLocked && <button onClick={handleBatchAdd} className="p-1.5 text-gray-600 hover:bg-gray-100 rounded border" title="Bulk Add"><Icons.Users size={18}/></button>}
                            <div className={`p-1.5 rounded-full border flex items-center justify-center ${isLocked?'bg-gray-50 text-gray-500':'bg-green-50 text-green-600'}`} title={isLocked?"View Only":"Edit Mode"}>{isLocked?<Icons.Lock size={16}/>:<Icons.Unlock size={16}/>}</div>
                            {!isLocked && <button onClick={()=>setIsThemePanelOpen(!isThemePanelOpen)} className="p-2 text-gray-600 hover:bg-gray-100 rounded-full" title="Theme & Layout"><Icons.Paint size={20}/></button>}
                            {!isLocked && <div className="logo-controls"><button onClick={()=>logoInputRef.current.click()} className="p-2 text-purple-600 hover:bg-purple-50 rounded-full" title="Upload Logo"><Icons.Image size={20}/></button><input ref={logoInputRef} type="file" accept="image/*" className="hidden" onChange={handleLogoUpload}/></div>}
                            <button onClick={()=>setIsSummaryOpen(true)} className="p-2 text-blue-600 hover:bg-blue-50 rounded-full" title="Summary Dashboard"><Icons.Chart size={20}/></button>
                            <button onClick={()=>setShowRulers(!showRulers)} className={`p-2 rounded-full ${showRulers ? 'bg-blue-50 text-blue-600' : 'text-gray-600 hover:bg-gray-100'}`} title="Show Rulers"><Icons.RulerIcon size={20}/></button>
                            <div className="flex bg-gray-100 rounded-lg p-1 gap-1"> {!isLocked && <button onClick={()=>csvInputRef.current.click()} className="p-1.5 text-gray-600 hover:bg-white rounded shadow-sm" title="Import CSV"><Icons.Upload size={16}/></button>} <button onClick={()=>exportToExcel(employees)} className="p-1.5 text-green-600 hover:bg-white rounded shadow-sm" title="Export CSV"><Icons.FileSpreadsheet size={16}/></button> <input ref={csvInputRef} type="file" accept=".csv" className="hidden" onChange={handleCSVImport}/> </div>
                            {!isLocked && <Button onClick={() => { setEditingEmployee({ isNew: true, reportsTo: 'STAGING', dept: currentDept }); setIsModalOpen(true); }} icon={Icons.Plus} className="hidden sm:flex">เพิ่ม</Button>}
                            {currentUser.role === 'admin' && <button onClick={()=>setIsAdminPanelOpen(true)} className="p-2 text-gray-600 hover:bg-gray-100 rounded-full"><Icons.Settings size={20}/></button>}
                            <button onClick={()=>{localStorage.removeItem('currentUser'); setCurrentUser(null); setCurrentDept(null);}} className="text-red-500 p-2"><Icons.LogOut size={20}/></button>
                        </div>
                    </nav>

                    {isMobileMenuOpen && ( <div className="fixed inset-0 z-[110] lg:hidden"> <div className="absolute inset-0 bg-black/50" onClick={()=>setIsMobileMenuOpen(false)}></div> <div className="absolute right-0 top-0 h-full w-64 bg-white shadow-xl flex flex-col p-4 animate-in slide-in-from-right duration-200"> <div className="flex justify-between items-center mb-6 border-b pb-2"><span className="font-bold">เมนูจัดการ</span><button onClick={()=>setIsMobileMenuOpen(false)}><Icons.X/></button></div> <div className="flex flex-col gap-4 overflow-y-auto"> <button onClick={()=>{setCurrentDept(null); setIsMobileMenuOpen(false);}} className="flex items-center gap-3 p-2 hover:bg-gray-100 rounded"><Icons.Home/> หน้าหลัก</button> <button onClick={()=>{exportToExcel(employees); setIsMobileMenuOpen(false);}} className="flex items-center gap-3 p-2 hover:bg-gray-100 rounded"><Icons.FileSpreadsheet/> Export Excel</button> <button onClick={()=>{localStorage.removeItem('currentUser'); setCurrentUser(null);}} className="flex items-center gap-3 p-2 text-red-600 hover:bg-red-50 mt-auto border-t"><Icons.LogOut/> ออกจากระบบ</button> </div> </div> </div> )}

                    <div className="flex flex-1 overflow-hidden relative">
                        {viewMode === 'chart' && (
                            <>
                            <aside className={`fixed inset-y-0 left-0 z-40 bg-white border-r transform transition-transform duration-300 pt-14 lg:pt-0 ${isSidebarOpen?'translate-x-0':'-translate-x-full'} ${isSidebarCollapsed?'w-0 overflow-hidden':''} lg:relative lg:translate-x-0`} style={{ width: isSidebarCollapsed?'0px':(window.innerWidth>1024?`${sidebarWidth}px`:'16rem') }}>
                                <div className="p-4 flex justify-between items-center shrink-0">
                                    <h2 className="font-bold text-xs text-gray-400 uppercase">Waiting Area ({stagingEmployees.length})</h2>
                                    {!isLocked && <button onClick={()=>{setEditingEmployee({isNew:true, reportsTo:'STAGING', dept: currentDept}); setIsModalOpen(true);}}><Icons.Plus size={18} className="text-blue-600"/></button>}
                                    <button onClick={()=>setIsSidebarOpen(false)} className="lg:hidden text-gray-400 hover:text-red-500"><Icons.X size={18}/></button>
                                </div>
                                <div className="flex-1 overflow-y-auto px-4 space-y-3 pb-20">
                                    {stagingEmployees.map(emp => <EmployeeCard key={emp.id} employee={emp} onClick={()=> {setEditingEmployee({...emp, isNew:false}); setIsModalOpen(true);}} onDragStart={(e,id)=>e.dataTransfer.setData("empIds", JSON.stringify([id]))} isStaging={true} isLocked={!canEdit(emp)} selectionMode={selectionMode} isSelected={selectedIds.includes(emp.id)} toggleSelection={(id)=>setSelectedIds(prev=>prev.includes(id)?prev.filter(x=>x!==id):[...prev, id])}/>)}
                                </div>
                                <div className="sidebar-resizer hidden lg:block" onMouseDown={()=>isResizing.current=true}></div>
                                <button className="sidebar-toggle-btn hidden lg:flex" style={{right: '-12px', borderRadius: '50%'}} onClick={()=>setIsSidebarCollapsed(true)}><Icons.ChevronLeft size={14}/></button>
                            </aside>
                            {isSidebarCollapsed && <button className="sidebar-toggle-btn hidden lg:flex" style={{left: '0', borderTopRightRadius: '8px', borderBottomRightRadius: '8px'}} onClick={()=>setIsSidebarCollapsed(false)}><Icons.ChevronRight size={18}/></button>}
                            </>
                        )}

                        <main className="flex-1 bg-gray-100 overflow-auto relative p-8">
                            {showRulers && viewMode === 'chart' && <><Ruler orientation="horizontal" length={3000} /><Ruler orientation="vertical" length={2000} /></>}
                            {viewMode === 'chart' ? (
                                <div className={`flex flex-col items-center min-w-max transition-transform duration-100 ${showRulers?'ml-8 mt-8':''}`} style={{ transform: `scale(${zoom})`, transformOrigin: 'top center' }}>
                                    <DraggableLogo logo={logo} setLogo={setLogo} isLocked={isLocked} />
                                    {annotations.map(ann => <DraggableAnnotation key={ann.id} ann={ann} onUpdate={handleUpdateAnnotation} onDelete={handleDeleteAnnotation} isLocked={isLocked} onLinkStart={setLinkStartId} />)}
                                    <svg className="absolute top-0 left-0 w-full h-full pointer-events-none z-0" style={{overflow:'visible'}}>{connectors}</svg>
                                    <div id="org-chart-full-view" className="bg-white p-8 rounded-2xl border shadow-xl inline-block min-w-[800px] org-chart-container relative">
                                        <div className="mb-8 border-b-2 pb-2"><h1 className="text-3xl font-bold text-gray-800 uppercase">{currentDept} DEPT</h1></div>
                                        <div className="flex gap-16 justify-center">
                                            {rootEmployees.map(root => <EmployeeNode key={root.id} employee={root} allEmployees={filteredAll} onEdit={(e)=>{setEditingEmployee({...e, isNew:false}); setIsModalOpen(true);}} onDelete={handleDelete} onAddSubordinate={(id)=>{setEditingEmployee({isNew:true, reportsTo:id, dept:currentDept});setIsModalOpen(true);}} onDrop={handleDropOnChart} onMoveSelect={(tid)=>{if(linkStartId) handleAnnotationLink(tid); else { handleDropOnChart(selectedIds.length>0?selectedIds:moveSource?.id, tid); setMoveSource(null); }}} moveTargetId={moveSource?.id} isLocked={!canEdit(root)} themeConf={THEMES[appTheme]} shapeClass={appShape} selectionMode={selectionMode} selectedIds={selectedIds} toggleSelection={(id)=>setSelectedIds(prev=>prev.includes(id)?prev.filter(x=>x!==id):[...prev, id])} onAddChild={(p)=>{setEditingEmployee({isNew:true, reportsTo:p.id, dept:p.dept}); setIsModalOpen(true);}} layoutThreshold={layoutThreshold} searchTerm={searchTerm} onReorder={handleReorder}/>)}
                                        </div>
                                    </div>
                                </div>
                            ) : (
                                <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
                                    <table className="min-w-full divide-y">
                                        <thead className="bg-gray-50"><tr><th className="px-4 py-3 text-left text-xs font-bold text-gray-500">Employee</th><th className="px-4 py-3 text-left text-xs font-bold text-gray-500">Dept</th><th className="px-4 py-3 text-left text-xs font-bold text-gray-500">Position</th></tr></thead>
                                        <tbody className="divide-y">{validEmployees.filter(e => currentDept === 'ALL' || e.dept === currentDept).map(emp => <tr key={emp.id} className="hover:bg-gray-50 cursor-pointer" onClick={()=>{setEditingEmployee({...emp, isNew:false}); setIsModalOpen(true);}}><td className="px-4 py-3 text-sm font-medium">{emp.name}</td><td className="px-4 py-3 text-sm text-gray-500">{emp.dept}</td><td className="px-4 py-3 text-sm text-gray-500">{emp.position}</td></tr>)}</tbody>
                                    </table>
                                </div>
                            )}

                            {selectionMode && selectedIds.length > 0 && (
                                <div className="batch-actions">
                                    <span className="text-sm font-bold text-gray-600">{selectedIds.length} Selected</span>
                                    <div className="h-6 w-px bg-gray-200 mx-2"></div>
                                    <span className="text-xs text-gray-400 mr-2">Transfer To:</span>
                                    {departments.map(d => <button key={d} onClick={()=>handleTransferToDept(d)} className="px-2 py-1 text-xs bg-blue-50 text-blue-600 rounded hover:bg-blue-100">{d}</button>)}
                                    <button onClick={()=>{if(confirm('Delete?')) updateStateFull(employees.filter(e=>!selectedIds.includes(e.id)), [], selectedIds); setSelectedIds([]);}} className="p-2 text-red-600 ml-4"><Icons.Trash2 size={16}/></button>
                                </div>
                            )}

                            {viewMode === 'chart' && (
                                <>
                                    <div className="zoom-controls"><button onClick={()=>setZoom(z=>Math.max(0.3,z-0.1))}><Icons.ZoomOut/></button><span className="text-xs font-mono">{Math.round(zoom*100)}%</span><button onClick={()=>setZoom(z=>Math.min(1.5,z+0.1))}><Icons.ZoomIn/></button></div>
                                    {!isLocked && historyIndex > 0 && <div className="undo-controls"><button onClick={handleUndo} className="bg-white text-gray-700 p-3 rounded-full shadow-lg border hover:bg-gray-50 flex items-center gap-2 group undo-btn" title="Undo Last Action"><Icons.RotateCcw size={20}/></button></div>}
                                </>
                            )}
                        </main>
                    </div>

                    {isModalOpen && <EmployeeForm employee={editingEmployee} supervisors={validEmployees} positions={positions} depts={departments} onSave={(d)=>handleSave(d, false)} onSaveAndContinue={(d)=>handleSave(d, true)} onCancel={()=>setIsModalOpen(false)} onDelete={handleDelete} role={currentUser.role} driveUrl={driveUrl} onAddPosition={handleAddPosition} onDeletePosition={handleDeletePosition} />}
                    {isAdminPanelOpen && <AdminPanel onClose={()=>setIsAdminPanelOpen(false)} driveUrl={driveUrl} setDriveUrl={setDriveUrl} apiCall={appApiCall} depts={departments} />}
                    {isManageDeptsOpen && <ManageDeptsModal depts={departments} onAdd={(d)=>{const nd = [...departments, d]; setDepartments(nd); localStorage.setItem('orgDepartments', JSON.stringify(nd)); if(driveUrl) appApiCall(driveUrl, 'saveData', {orgDepartments: nd});}} onDelete={(d)=>{const nd = departments.filter(x=>x!==d); setDepartments(nd); localStorage.setItem('orgDepartments', JSON.stringify(nd));}} onClose={()=>setIsManageDeptsOpen(false)} />}
                    {isManagePosOpen && <ManagePositionsModal positions={positions} onAdd={handleAddPosition} onDelete={handleDeletePosition} onClose={()=>setIsManagePosOpen(false)} />}
                    {isThemePanelOpen && <ThemePanel onClose={() => setIsThemePanelOpen(false)} currentTheme={appTheme} setAppTheme={setAppTheme} currentShape={appShape} setAppShape={setAppShape} layoutThreshold={layoutThreshold} setLayoutThreshold={setLayoutThreshold} />}
                    {isSummaryOpen && <SummaryDashboard employees={employees} onClose={()=>setIsSummaryOpen(false)} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ErrorBoundary><App /></ErrorBoundary>);
    </script>
</body>
</html>
